<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>èª æ„é®®è”¬ï½œæ–°é®®è”¬æœå¤–é€ - SUB AGENTåœ˜éšŠç¾ä»£ç‰ˆ</title>
  
  <!-- PWAè¨­å®š -->
  <meta name="theme-color" content="#2d5a3d">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  
  <!-- å„ªåŒ–CSSè¼‰å…¥ -->
  <link rel="stylesheet" href="/css/mobile-optimized.css">
  <link rel="stylesheet" href="/css/card-layout.css">
  <link rel="stylesheet" href="/css/product-modal.css">
  <link rel="stylesheet" href="/css/cart-modal.css">
  <link rel="stylesheet" href="/css/cart-item-detail.css">
  
  <!-- é è¼‰å…¥é—œéµè³‡æº -->
  <link rel="preload" href="/api/products" as="fetch" crossorigin>
</head>

<body>
  <!-- ğŸª é ‚éƒ¨å°èˆª -->
  <header class="main-header">
    <div class="header-content">
      <div class="store-info">
        <h1 class="store-name">èª æ„é®®è”¬</h1>
        <div class="store-stats">
          <span class="views">ğŸ‘ <span id="viewCount">5489</span> views</span>
          <span class="store-badge">æ–°é®®é…é€</span>
        </div>
      </div>
      <% if (sessionLine) { %>
        <div class="line-status connected">
          âœ… LINE å·²ç¶å®š
        </div>
      <% } else { %>
        <div class="line-status">
          <a href="/auth/line/login" class="line-connect">ğŸ“± ç¶å®š LINE</a>
        </div>
      <% } %>
    </div>
  </header>

  <!-- ğŸ” æœå°‹åŠŸèƒ½ -->
  <div class="search-section">
    <div class="search-container">
      <div class="search-input-wrapper">
        <input 
          type="text" 
          id="search-input" 
          placeholder="ğŸ” æœå°‹å•†å“åç¨±..." 
          class="search-input"
          autocomplete="off"
          autocapitalize="off"
          spellcheck="false">
        <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">âœ•</button>
      </div>
    </div>
  </div>

  <!-- ğŸ“‹ åˆ†é¡å°èˆª -->
  <nav class="category-nav">
    <div class="category-tabs">
      <button class="category-tab active touch-target" data-category="all">æ¨è–¦</button>
      <button class="category-tab touch-target" data-category="vegetables">ä¸€èˆ¬è”¬èœ</button>
      <button class="category-tab touch-target" data-category="leafy">è‘‰èœé¡</button>
      <button class="category-tab touch-target" data-category="fruits">æ°´æœ</button>
      <button class="category-tab touch-target" data-category="proxy">ä»£è³¼</button>
    </div>
  </nav>
  
  <!-- ğŸ“¢ æœå‹™å…¬å‘Š (å¯æ”¶åˆ) -->
  <div class="service-announcement" id="announcement">
    <div class="announcement-header" onclick="toggleAnnouncement()">
      <h3>ğŸ“¢ æœå‹™è³‡è¨Š</h3>
      <button class="announcement-toggle">â–¼</button>
    </div>
    <div class="announcement-content">
      <div class="service-info-grid">
        <div class="service-item">
          <div class="service-icon">ğŸšš</div>
          <div class="service-text">
            <strong>æœå‹™ç¯„åœ</strong>
            <span>ä¸‰å³½ã€åŒ—å¤§ç‰¹å€ã€é¶¯æ­Œã€æ¨¹æ—ã€åœŸåŸ</span>
          </div>
        </div>
        <div class="service-item">
          <div class="service-icon">ğŸ’°</div>
          <div class="service-text">
            <strong>å¤–é€é–€æª»</strong>
            <span>æ»¿200å…ƒå…è²»å¤–é€</span>
          </div>
        </div>
        <div class="service-item">
          <div class="service-icon">ğŸ’³</div>
          <div class="service-text">
            <strong>ä»˜æ¬¾æ–¹å¼</strong>
            <span>ç¾é‡‘ã€LINE Payã€è½‰å¸³</span>
          </div>
        </div>
        <div class="service-item">
          <div class="service-icon">â°</div>
          <div class="service-text">
            <strong>é…é€æ™‚é–“</strong>
            <span>11é»å‰ä¸‹å–®ç•¶å¤©é€é”</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ¥¬ å•†å“å±•ç¤ºå€åŸŸ -->
  <main class="products-section">
    <% if (!products || products.length === 0) { %>
      <div class="empty-products">
        <div class="empty-icon">ğŸ¥¬</div>
        <h3>æš«ç„¡å•†å“</h3>
        <p>è«‹ç¨å¾Œå†è©¦æˆ–è¯çµ¡å®¢æœ</p>
        <button onclick="location.reload()" class="retry-btn touch-target">é‡æ–°è¼‰å…¥</button>
      </div>
    <% } else { %>
      <div class="products-list card-layout">
        <% products.forEach(function(product) { %>
          <div class="product-card touch-feedback <%= product.is_featured ? 'featured' : '' %>" 
               data-category="<%= product.is_priced_item ? 'proxy' : 'vegetables' %>" 
               onclick="openProductModal(<%= product.id %>)"
               data-product-id="<%= product.id %>">
            
            <!-- æ–°å“/ç‰¹åƒ¹æ¨™ç±¤ -->
            <% if (product.is_new) { %>
              <div class="card-new-badge">æ–°å“</div>
            <% } else if (product.on_sale) { %>
              <div class="card-sale-badge">ç‰¹åƒ¹</div>
            <% } %>
            
            <!-- åº«å­˜æŒ‡ç¤ºå™¨ -->
            <div class="card-stock-indicator <%= product.stock <= 0 ? 'out-of-stock' : '' %>"></div>
            
            <!-- å•†å“åœ–ç‰‡å€åŸŸ -->
            <div class="card-image-section">
              <div class="card-product-image">
                <% if (product.image_url && product.image_url.startsWith('/uploads/')) { %>
                  <img src="<%= product.image_url %>" alt="<%= product.name %>" loading="lazy">
                <% } else if (product.image_url) { %>
                  <%= product.image_url %>
                <% } else { %>
                  <%= getProductEmoji(product.name) %>
                <% } %>
              </div>
            </div>
            
            <!-- å•†å“å…§å®¹ -->
            <div class="card-content">
              <h3 class="card-product-title"><%= product.name %></h3>
              
              <% if (product.is_priced_item) { %>
                <div class="card-priced-badge">è¨ˆåƒ¹å•†å“</div>
                <div class="card-price-section">
                  <div class="card-price-main">æ™‚åƒ¹</div>
                </div>
              <% } else { %>
                <div class="card-price-section">
                  <span class="card-price-main">$<%= product.price %></span>
                  <span class="card-price-unit">/<%= product.unit || 'ä»½' %></span>
                </div>
              <% } %>
              
              <!-- å¿«é€ŸåŠ å…¥æŒ‰éˆ• -->
              <button class="card-add-btn" onclick="quickAddToCart(event, <%= product.id %>)" 
                      <%= product.stock <= 0 ? 'disabled' : '' %>>+</button>
            </div>
            
            <!-- è¼‰å…¥é®ç½© -->
            <div class="card-blur-overlay">
              è¼‰å…¥ä¸­...
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </main>

  <!-- ğŸ›’ è³¼ç‰©è»Šåº•éƒ¨æ¬„ -->
  <div class="cart-bar" id="cart-bar">
    <div class="cart-summary">
      <div class="cart-info">
        <div class="cart-total">ç¸½è¨ˆ $<span id="cart-total-amount">0</span></div>
        <div class="cart-note"><span id="cart-item-count">0</span> æ¨£å•†å“</div>
      </div>
      <button class="checkout-btn touch-target" onclick="openCartModal()">
        <span class="checkout-arrow">ğŸ›’</span>
      </button>
    </div>
  </div>

  <!-- ğŸ¯ ç”¢å“è©³æƒ…å½ˆçª— -->
  <div class="product-modal-overlay" id="product-modal">
    <div class="product-modal-card">
      <div class="modal-image-section">
        <div class="modal-product-image" id="modal-image"></div>
        <button class="modal-close-btn" onclick="closeProductModal()">âœ•</button>
      </div>
      
      <div class="modal-content">
        <h2 class="modal-product-title" id="modal-title"></h2>
        <p class="modal-product-description" id="modal-description">æ–°é®®è”¬æœï¼Œç•¶æ—¥æ¡æ”¶ç•¶æ—¥é…é€</p>
        
        <div class="modal-product-specs" id="modal-specs">
          <div class="spec-item">
            <span class="spec-label">ç”¢åœ°</span>
            <span class="spec-value">å°ç£åœ¨åœ°</span>
          </div>
          <div class="spec-item">
            <span class="spec-label">ä¿å­˜</span>
            <span class="spec-value">å†·è—ä¿é®®</span>
          </div>
        </div>
        
        <div class="modal-price-section">
          <div class="modal-price-main" id="modal-price">$0</div>
          <div class="modal-priced-badge" id="modal-priced-badge" style="display: none;">
            è¨ˆåƒ¹å•†å“ï¼Œå¯¦éš›åƒ¹æ ¼ä»¥é…é€æ™‚ç‚ºæº–
          </div>
        </div>
        
        <div class="quantity-selector">
          <button class="quantity-btn" onclick="adjustQuantity(-1)">âˆ’</button>
          <div class="quantity-display" id="quantity-display">1</div>
          <button class="quantity-btn" onclick="adjustQuantity(1)">+</button>
        </div>
      </div>
      
      <div class="modal-actions">
        <div class="total-price" id="modal-total">$0</div>
        <button class="add-to-cart-btn" onclick="addToCartFromModal()" id="add-to-cart-btn">
          <span>åŠ å…¥è³¼ç‰©è»Š</span>
        </button>
      </div>
    </div>
  </div>

  <!-- ğŸ›’ è³¼ç‰©è»Šå½ˆçª— -->
  <div class="cart-modal-overlay" id="cart-modal">
    <div class="cart-header">
      <h2 class="cart-title">
        è³¼ç‰©è»Š 
        <span class="cart-item-count" id="cart-modal-count">0</span>
      </h2>
      <button class="cart-close-btn" onclick="closeCartModal()">âœ•</button>
    </div>
    
    <div class="cart-content" id="cart-content">
      <!-- è³¼ç‰©è»Šå…§å®¹å°‡ç”± JavaScript å‹•æ…‹å¡«å…¥ -->
      <div class="cart-empty">
        <div class="cart-empty-icon">ğŸ›’</div>
        <div class="cart-empty-text">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
        <div class="cart-empty-hint">å¿«å»é¸è³¼æ–°é®®è”¬æœå§ï¼</div>
      </div>
    </div>
    
    <div class="cart-footer" id="cart-footer" style="display: none;">
      <div class="minimum-order-notice" id="minimum-order-notice" style="display: none;">
        <span>âš ï¸</span> é‚„å·® $<span id="remaining-amount">200</span> å³å¯äº«å…è²»å¤–é€
      </div>
      
      <div class="cart-summary">
        <div class="cart-summary-row">
          <span class="cart-summary-label">å°è¨ˆ</span>
          <span class="cart-summary-value" id="cart-subtotal">$0</span>
        </div>
        <div class="cart-summary-row">
          <span class="cart-summary-label">å¤–é€è²»</span>
          <span class="cart-summary-value" id="delivery-fee">$0</span>
        </div>
        <div class="cart-summary-row">
          <span class="cart-summary-label">ç¸½è¨ˆ</span>
          <span class="cart-total-value" id="cart-final-total">$0</span>
        </div>
      </div>
      
      <button class="cart-checkout-btn touch-target" onclick="proceedToCheckout()" id="checkout-button">
        <span>å‰å¾€çµå¸³</span>
        <span>â†’</span>
      </button>
    </div>
  </div>

  <!-- âœï¸ è³¼ç‰©è»Šå•†å“è©³æƒ…ç·¨è¼¯ -->
  <div class="cart-item-detail-overlay" id="cart-item-detail">
    <div class="cart-item-detail-card">
      <div class="detail-header">
        <h3 class="detail-title">ç·¨è¼¯å•†å“</h3>
        <button class="detail-close-btn" onclick="closeCartItemDetail()">âœ•</button>
      </div>
      
      <div class="detail-content">
        <div class="detail-product-info">
          <div class="detail-product-image" id="detail-image"></div>
          <div class="detail-product-text">
            <h4 class="detail-product-name" id="detail-name"></h4>
            <div class="detail-product-price" id="detail-price"></div>
            <div class="detail-current-quantity">ç›®å‰æ•¸é‡: <span id="detail-current-qty">1</span></div>
          </div>
        </div>
        
        <!-- å•†å“é¸é …å€åŸŸ (å¦‚æœæœ‰çš„è©±) -->
        <div class="detail-options-section" id="detail-options" style="display: none;">
          <!-- å‹•æ…‹å…§å®¹ -->
        </div>
        
        <div class="detail-quantity-section">
          <h4 class="quantity-section-title">èª¿æ•´æ•¸é‡</h4>
          <div class="detail-quantity-controls">
            <button class="detail-qty-btn" onclick="adjustDetailQuantity(-1)">âˆ’</button>
            <div class="detail-qty-display" id="detail-qty-display">1</div>
            <button class="detail-qty-btn" onclick="adjustDetailQuantity(1)">+</button>
          </div>
        </div>
      </div>
      
      <div class="detail-footer">
        <div class="detail-price-preview">
          <span class="price-preview-label">å°è¨ˆ</span>
          <span class="price-preview-value" id="detail-subtotal">$0</span>
        </div>
        
        <div class="detail-actions">
          <button class="detail-remove-btn" onclick="removeFromCartDetail()">
            ğŸ—‘ï¸ ç§»é™¤
          </button>
          <button class="detail-update-btn" onclick="updateCartItem()">
            âœ“ æ›´æ–°
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ”„ è¼‰å…¥æŒ‡ç¤ºå™¨ -->
  <div class="loading-overlay" id="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <div class="loading-text">è™•ç†ä¸­...</div>
  </div>

  <!-- JavaScript -->
  <script>
    // å…¨åŸŸè®Šæ•¸
    let products = <%- JSON.stringify(products || []) %>;
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');
    let currentProduct = null;
    let currentQuantity = 1;
    let currentCartItem = null;
    
    // å•†å“è¡¨æƒ…ç¬¦è™Ÿæ˜ å°„
    function getProductEmoji(name) {
      const emojiMap = {
        'é«˜éº—èœ': 'ğŸ¥¬', 'ç•ªèŒ„': 'ğŸ…', 'èƒ¡è˜¿è””': 'ğŸ¥•', 
        'å°é»ƒç“œ': 'ğŸ¥’', 'æ´‹è”¥': 'ğŸ§…', 'ç‰ç±³': 'ğŸŒ½',
        'é¦¬éˆ´è–¯': 'ğŸ¥”', 'é’æ±Ÿèœ': 'ğŸ¥¬', 'ç©ºå¿ƒèœ': 'ğŸ¥¬',
        'è èœ': 'ğŸ¥¬', 'éŸ­èœ': 'ğŸ¥¬', 'é’æ¤’': 'ğŸ«‘'
      };
      
      for (let key in emojiMap) {
        if (name.includes(key)) {
          return emojiMap[key];
        }
      }
      return 'ğŸ¥¬'; // é è¨­è”¬èœåœ–ç¤º
    }

    // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      updateCartDisplay();
      initializeSearch();
      initializeCategories();
    });

    // æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
    function initializeApp() {
      // è¨­å®šè§¸æ§å›é¥‹
      document.querySelectorAll('.touch-feedback').forEach(element => {
        element.addEventListener('touchstart', function() {
          this.style.transform = 'scale(0.98)';
        });
        
        element.addEventListener('touchend', function() {
          setTimeout(() => {
            this.style.transform = 'scale(1)';
          }, 100);
        });
      });
      
      // é é˜²é›™é‡é»æ“Š
      let lastClick = 0;
      document.addEventListener('click', function(e) {
        if (Date.now() - lastClick < 300) {
          e.preventDefault();
          return false;
        }
        lastClick = Date.now();
      });
    }

    // æœå°‹åŠŸèƒ½åˆå§‹åŒ–
    function initializeSearch() {
      const searchInput = document.getElementById('search-input');
      const clearBtn = document.getElementById('search-clear');
      
      searchInput.addEventListener('input', function() {
        const query = this.value.toLowerCase();
        clearBtn.style.display = query ? 'block' : 'none';
        filterProducts(query);
      });
      
      // é˜²æŠ–è™•ç†
      let searchTimeout;
      searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          const query = this.value.toLowerCase();
          filterProducts(query);
        }, 300);
      });
    }

    // åˆ†é¡åŠŸèƒ½åˆå§‹åŒ–
    function initializeCategories() {
      document.querySelectorAll('.category-tab').forEach(tab => {
        tab.addEventListener('click', function() {
          document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          filterByCategory(this.dataset.category);
        });
      });
    }

    // ç”¢å“éæ¿¾
    function filterProducts(query = '') {
      const productCards = document.querySelectorAll('.product-card');
      
      productCards.forEach(card => {
        const title = card.querySelector('.card-product-title').textContent.toLowerCase();
        const shouldShow = title.includes(query);
        
        if (shouldShow) {
          card.style.display = 'flex';
          card.classList.remove('hidden');
        } else {
          card.style.display = 'none';
          card.classList.add('hidden');
        }
      });
    }

    // åˆ†é¡éæ¿¾
    function filterByCategory(category) {
      const productCards = document.querySelectorAll('.product-card');
      
      productCards.forEach(card => {
        const cardCategory = card.dataset.category;
        const shouldShow = category === 'all' || cardCategory === category;
        
        if (shouldShow) {
          card.style.display = 'flex';
          card.classList.remove('hidden');
        } else {
          card.style.display = 'none';
          card.classList.add('hidden');
        }
      });
    }

    // æ¸…é™¤æœå°‹
    function clearSearch() {
      const searchInput = document.getElementById('search-input');
      const clearBtn = document.getElementById('search-clear');
      
      searchInput.value = '';
      clearBtn.style.display = 'none';
      filterProducts('');
    }

    // å…¬å‘Šæ¬„åˆ‡æ›
    function toggleAnnouncement() {
      const announcement = document.getElementById('announcement');
      const toggle = document.querySelector('.announcement-toggle');
      
      announcement.classList.toggle('collapsed');
      toggle.textContent = announcement.classList.contains('collapsed') ? 'â–²' : 'â–¼';
    }

    // é–‹å•Ÿç”¢å“å½ˆçª—
    function openProductModal(productId) {
      currentProduct = products.find(p => p.id === productId);
      if (!currentProduct) return;
      
      const modal = document.getElementById('product-modal');
      const modalImage = document.getElementById('modal-image');
      const modalTitle = document.getElementById('modal-title');
      const modalPrice = document.getElementById('modal-price');
      const modalPricedBadge = document.getElementById('modal-priced-badge');
      
      // è¨­å®šç”¢å“è³‡è¨Š
      modalImage.innerHTML = currentProduct.image_url ? 
        (currentProduct.image_url.startsWith('/uploads/') ? 
          `<img src="${currentProduct.image_url}" alt="${currentProduct.name}">` : 
          currentProduct.image_url) : 
        getProductEmoji(currentProduct.name);
      
      modalTitle.textContent = currentProduct.name;
      
      if (currentProduct.is_priced_item) {
        modalPrice.textContent = 'æ™‚åƒ¹';
        modalPricedBadge.style.display = 'block';
      } else {
        modalPrice.textContent = `$${currentProduct.price}`;
        modalPricedBadge.style.display = 'none';
      }
      
      // é‡è¨­æ•¸é‡
      currentQuantity = 1;
      document.getElementById('quantity-display').textContent = currentQuantity;
      updateModalTotal();
      
      // é¡¯ç¤ºå½ˆçª—
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // é—œé–‰ç”¢å“å½ˆçª—
    function closeProductModal() {
      const modal = document.getElementById('product-modal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // èª¿æ•´æ•¸é‡
    function adjustQuantity(change) {
      currentQuantity = Math.max(1, currentQuantity + change);
      document.getElementById('quantity-display').textContent = currentQuantity;
      
      // æ•¸é‡è®ŠåŒ–å‹•ç•«
      const display = document.getElementById('quantity-display');
      display.classList.add('changed');
      setTimeout(() => display.classList.remove('changed'), 300);
      
      updateModalTotal();
    }

    // æ›´æ–°å½ˆçª—ç¸½åƒ¹
    function updateModalTotal() {
      if (!currentProduct || currentProduct.is_priced_item) {
        document.getElementById('modal-total').textContent = 'æ™‚åƒ¹';
        return;
      }
      
      const total = currentProduct.price * currentQuantity;
      document.getElementById('modal-total').textContent = `$${total}`;
    }

    // å¾å½ˆçª—åŠ å…¥è³¼ç‰©è»Š
    function addToCartFromModal() {
      if (!currentProduct) return;
      
      const button = document.getElementById('add-to-cart-btn');
      
      // é˜²æ­¢é‡è¤‡é»æ“Š
      if (button.classList.contains('success')) return;
      
      // åŠ å…¥è³¼ç‰©è»Šé‚è¼¯
      addToCart(currentProduct.id, currentQuantity);
      
      // æˆåŠŸå›é¥‹
      button.classList.add('success');
      setTimeout(() => {
        button.classList.remove('success');
        closeProductModal();
      }, 1000);
    }

    // å¿«é€ŸåŠ å…¥è³¼ç‰©è»Š
    function quickAddToCart(event, productId) {
      event.stopPropagation();
      
      const product = products.find(p => p.id === productId);
      if (!product || product.stock <= 0) return;
      
      addToCart(productId, 1);
      
      // è¦–è¦ºå›é¥‹
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = 'âœ“';
      button.style.background = '#4caf50';
      
      setTimeout(() => {
        button.textContent = originalText;
        button.style.background = '';
      }, 1000);
    }

    // åŠ å…¥è³¼ç‰©è»Šæ ¸å¿ƒé‚è¼¯
    function addToCart(productId, quantity) {
      const product = products.find(p => p.id === productId);
      if (!product) return;
      
      const existingItem = cart.find(item => item.id === productId);
      
      if (existingItem) {
        existingItem.quantity += quantity;
      } else {
        cart.push({
          id: productId,
          name: product.name,
          price: product.price,
          quantity: quantity,
          image: product.image_url || getProductEmoji(product.name),
          is_priced_item: product.is_priced_item || false,
          unit: product.unit || 'ä»½'
        });
      }
      
      saveCart();
      updateCartDisplay();
    }

    // å„²å­˜è³¼ç‰©è»Š
    function saveCart() {
      localStorage.setItem('cart', JSON.stringify(cart));
    }

    // æ›´æ–°è³¼ç‰©è»Šé¡¯ç¤º
    function updateCartDisplay() {
      const cartBar = document.getElementById('cart-bar');
      const totalAmount = document.getElementById('cart-total-amount');
      const itemCount = document.getElementById('cart-item-count');
      
      let total = 0;
      let count = 0;
      
      cart.forEach(item => {
        if (!item.is_priced_item) {
          total += item.price * item.quantity;
        }
        count += item.quantity;
      });
      
      totalAmount.textContent = total;
      itemCount.textContent = count;
      
      if (count > 0) {
        cartBar.classList.add('visible');
      } else {
        cartBar.classList.remove('visible');
      }
    }

    // é–‹å•Ÿè³¼ç‰©è»Šå½ˆçª—
    function openCartModal() {
      const modal = document.getElementById('cart-modal');
      renderCartContent();
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    // é—œé–‰è³¼ç‰©è»Šå½ˆçª—
    function closeCartModal() {
      const modal = document.getElementById('cart-modal');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    // æ¸²æŸ“è³¼ç‰©è»Šå…§å®¹
    function renderCartContent() {
      const content = document.getElementById('cart-content');
      const footer = document.getElementById('cart-footer');
      const modalCount = document.getElementById('cart-modal-count');
      
      modalCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
      
      if (cart.length === 0) {
        content.innerHTML = `
          <div class="cart-empty">
            <div class="cart-empty-icon">ğŸ›’</div>
            <div class="cart-empty-text">è³¼ç‰©è»Šæ˜¯ç©ºçš„</div>
            <div class="cart-empty-hint">å¿«å»é¸è³¼æ–°é®®è”¬æœå§ï¼</div>
          </div>
        `;
        footer.style.display = 'none';
        return;
      }
      
      let html = '';
      cart.forEach((item, index) => {
        html += `
          <div class="cart-item-card" data-item-index="${index}">
            <div class="cart-item-image">
              ${item.image.startsWith('/uploads/') ? 
                `<img src="${item.image}" alt="${item.name}">` : 
                item.image}
            </div>
            
            <div class="cart-item-info">
              <h4 class="cart-item-name">${item.name}</h4>
              <div class="cart-item-price">$${item.price}</div>
              <div class="cart-item-unit">/${item.unit}</div>
              ${item.is_priced_item ? '<div class="cart-item-badge">è¨ˆåƒ¹å•†å“</div>' : ''}
            </div>
            
            <div class="cart-item-controls">
              <div class="cart-quantity-controls">
                <button class="cart-qty-btn" onclick="updateCartQuantity(${index}, -1)">âˆ’</button>
                <div class="cart-qty-display">${item.quantity}</div>
                <button class="cart-qty-btn" onclick="updateCartQuantity(${index}, 1)">+</button>
              </div>
              
              <div class="cart-item-subtotal">$${item.is_priced_item ? 'æ™‚åƒ¹' : item.price * item.quantity}</div>
              
              <button class="cart-remove-btn" onclick="removeFromCart(${index})">Ã—</button>
            </div>
          </div>
        `;
      });
      
      content.innerHTML = html;
      footer.style.display = 'block';
      updateCartSummary();
    }

    // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡
    function updateCartQuantity(index, change) {
      if (cart[index]) {
        cart[index].quantity = Math.max(1, cart[index].quantity + change);
        saveCart();
        updateCartDisplay();
        
        // æ›´æ–°ç•¶å‰é¡¯ç¤º
        const qtyDisplay = document.querySelector(`[data-item-index="${index}"] .cart-qty-display`);
        const subtotal = document.querySelector(`[data-item-index="${index}"] .cart-item-subtotal`);
        
        if (qtyDisplay && subtotal) {
          qtyDisplay.textContent = cart[index].quantity;
          qtyDisplay.classList.add('changed');
          setTimeout(() => qtyDisplay.classList.remove('changed'), 300);
          
          if (!cart[index].is_priced_item) {
            subtotal.textContent = `$${cart[index].price * cart[index].quantity}`;
          }
        }
        
        updateCartSummary();
      }
    }

    // å¾è³¼ç‰©è»Šç§»é™¤
    function removeFromCart(index) {
      if (confirm('ç¢ºå®šè¦ç§»é™¤æ­¤å•†å“å—ï¼Ÿ')) {
        const card = document.querySelector(`[data-item-index="${index}"]`);
        if (card) {
          card.classList.add('removing');
          setTimeout(() => {
            cart.splice(index, 1);
            saveCart();
            updateCartDisplay();
            renderCartContent();
          }, 400);
        }
      }
    }

    // æ›´æ–°è³¼ç‰©è»Šæ‘˜è¦
    function updateCartSummary() {
      let subtotal = 0;
      cart.forEach(item => {
        if (!item.is_priced_item) {
          subtotal += item.price * item.quantity;
        }
      });
      
      const deliveryFee = subtotal >= 200 ? 0 : 50;
      const finalTotal = subtotal + deliveryFee;
      const remaining = Math.max(0, 200 - subtotal);
      
      document.getElementById('cart-subtotal').textContent = `$${subtotal}`;
      document.getElementById('delivery-fee').textContent = deliveryFee === 0 ? 'å…è²»' : `$${deliveryFee}`;
      document.getElementById('cart-final-total').textContent = `$${finalTotal}`;
      
      const notice = document.getElementById('minimum-order-notice');
      const remainingAmount = document.getElementById('remaining-amount');
      
      if (remaining > 0) {
        notice.style.display = 'flex';
        remainingAmount.textContent = remaining;
      } else {
        notice.style.display = 'none';
      }
    }

    // å‰å¾€çµå¸³
    function proceedToCheckout() {
      if (cart.length === 0) return;
      
      showLoading('æº–å‚™çµå¸³é é¢...');
      
      // æ¨¡æ“¬è¼‰å…¥
      setTimeout(() => {
        hideLoading();
        window.location.href = '/checkout';
      }, 1500);
    }

    // é¡¯ç¤ºè¼‰å…¥
    function showLoading(text = 'è™•ç†ä¸­...') {
      const overlay = document.getElementById('loading-overlay');
      const loadingText = document.querySelector('.loading-text');
      
      loadingText.textContent = text;
      overlay.style.display = 'flex';
    }

    // éš±è—è¼‰å…¥
    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      overlay.style.display = 'none';
    }

    // é»æ“ŠèƒŒæ™¯é—œé–‰å½ˆçª—
    document.getElementById('product-modal').addEventListener('click', function(e) {
      if (e.target === this) closeProductModal();
    });
    
    document.getElementById('cart-modal').addEventListener('click', function(e) {
      if (e.target === this) closeCartModal();
    });

    // ç›£è½éµç›¤äº‹ä»¶
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeProductModal();
        closeCartModal();
        closeCartItemDetail();
      }
    });

    // è³¼ç‰©è»Šå•†å“ç´°é …ç·¨è¼¯åŠŸèƒ½ (é ç•™)
    function openCartItemDetail(index) {
      // å¯¦ç¾å•†å“ç´°é …ç·¨è¼¯åŠŸèƒ½
      console.log('é–‹å•Ÿå•†å“ç´°é …ç·¨è¼¯:', index);
    }

    function closeCartItemDetail() {
      const modal = document.getElementById('cart-item-detail');
      modal.classList.remove('active');
      document.body.style.overflow = 'auto';
    }

    function adjustDetailQuantity(change) {
      // å¯¦ç¾ç´°é …æ•¸é‡èª¿æ•´
      console.log('èª¿æ•´ç´°é …æ•¸é‡:', change);
    }

    function updateCartItem() {
      // å¯¦ç¾è³¼ç‰©è»Šé …ç›®æ›´æ–°
      console.log('æ›´æ–°è³¼ç‰©è»Šé …ç›®');
    }

    function removeFromCartDetail() {
      // å¯¦ç¾å¾ç´°é …ç§»é™¤
      console.log('å¾ç´°é …ç§»é™¤');
    }
  </script>

  <style>
    /* è£œå……æ¨£å¼ */
    .service-announcement {
      background: rgba(255, 255, 255, 0.98);
      margin: 0;
      border-bottom: 1px solid var(--border-light);
      position: sticky;
      top: 186px;
      z-index: 97;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    
    .service-announcement.collapsed {
      max-height: 60px;
    }
    
    .announcement-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.5rem;
      cursor: pointer;
      user-select: none;
    }
    
    .announcement-header h3 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .announcement-toggle {
      background: none;
      border: none;
      font-size: 0.8rem;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }
    
    .service-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.8rem;
      padding: 0 1.5rem 1rem;
    }
    
    .service-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .service-icon {
      font-size: 1.2rem;
      width: 1.5rem;
      text-align: center;
    }
    
    .service-text {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
    }
    
    .service-text strong {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .service-text span {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }
    
    .empty-products {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    
    .empty-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .empty-products h3 {
      font-size: 1.3rem;
      margin-bottom: 0.5rem;
      color: var(--text-primary);
    }
    
    .retry-btn {
      margin-top: 1.5rem;
      background: var(--accent-green);
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 25px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }
    
    .loading-text {
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 400px) {
      .service-info-grid {
        grid-template-columns: 1fr;
        gap: 0.6rem;
      }
      
      .announcement-header {
        padding: 0.8rem 1rem;
      }
      
      .service-info-grid {
        padding: 0 1rem 0.8rem;
      }
    }
  </style>
</body>
</html>