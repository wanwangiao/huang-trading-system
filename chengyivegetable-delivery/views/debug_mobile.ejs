<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“± æ‰‹æ©Ÿé™¤éŒ¯é é¢ - å¤–é€å“¡ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft JhengHei', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }
        
        .debug-container {
            max-width: 100%;
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            font-size: 24px;
        }
        
        .status-section {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }
        
        .status-section.error {
            background: #ffeaea;
            border-color: #e74c3c;
        }
        
        .status-section.warning {
            background: #fff8e1;
            border-color: #f39c12;
        }
        
        .log-container {
            background: #1a1a1a;
            color: #00ff00;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 5px;
            width: calc(50% - 10px);
            transition: all 0.3s;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .test-button.success {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }
        
        .test-button.error {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #dee2e6;
        }
        
        .info-card h3 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .info-card .value {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
        }
        
        .clear-log-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            float: right;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>ğŸ“± å¤–é€å“¡ç³»çµ±æ‰‹æ©Ÿé™¤éŒ¯</h1>
        
        <!-- ç³»çµ±ç‹€æ…‹ -->
        <div id="system-status" class="status-section">
            <strong>ğŸ” ç³»çµ±æª¢æŸ¥ä¸­...</strong>
        </div>
        
        <!-- ç³»çµ±è³‡è¨Š -->
        <div class="info-grid">
            <div class="info-card">
                <h3>ğŸŒ ç¶²è·¯ç‹€æ…‹</h3>
                <div class="value" id="network-status">æª¢æŸ¥ä¸­...</div>
            </div>
            <div class="info-card">
                <h3>ğŸ”— APIç‹€æ…‹</h3>
                <div class="value" id="api-status">æª¢æŸ¥ä¸­...</div>
            </div>
            <div class="info-card">
                <h3>â±ï¸ è¼‰å…¥æ™‚é–“</h3>
                <div class="value" id="load-time">è¨ˆç®—ä¸­...</div>
            </div>
            <div class="info-card">
                <h3>ğŸ“Š è¨‚å–®æ•¸é‡</h3>
                <div class="value" id="order-count">è¼‰å…¥ä¸­...</div>
            </div>
        </div>
        
        <!-- æ¸¬è©¦æŒ‰éˆ• -->
        <div style="text-align: center; margin: 20px 0;">
            <button class="test-button" onclick="testOrderCounts()">ğŸ“Š æ¸¬è©¦è¨‚å–®çµ±è¨ˆ</button>
            <button class="test-button" onclick="testAreaOrders()">ğŸ“ æ¸¬è©¦åœ°å€è¨‚å–®</button>
            <button class="test-button" onclick="testDriverStats()">ğŸ‘¨â€ğŸ’¼ æ¸¬è©¦çµ±è¨ˆè³‡æ–™</button>
            <button class="test-button" onclick="testFullSystem()">ğŸš€ å®Œæ•´ç³»çµ±æ¸¬è©¦</button>
        </div>
        
        <!-- é™¤éŒ¯æ—¥èªŒ -->
        <div>
            <button class="clear-log-btn" onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
            <h3>ğŸ“ å³æ™‚æ—¥èªŒ</h3>
        </div>
        <div id="debug-log" class="log-container">æ—¥èªŒåˆå§‹åŒ–ä¸­...</div>
        
        <!-- å¿«é€Ÿæ“ä½œ -->
        <div style="margin-top: 20px;">
            <button class="test-button success" onclick="goToDriverSystem()">ğŸš› å‰å¾€å¤–é€å“¡ç³»çµ±</button>
            <button class="test-button error" onclick="reportProblem()">ğŸ†˜ å›å ±å•é¡Œ</button>
        </div>
    </div>

    <script>
        let debugLog = [];
        const startTime = Date.now();
        
        // æ—¥èªŒå‡½æ•¸
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            debugLog.push(logEntry);
            
            // æ›´æ–°é¡¯ç¤º
            const logContainer = document.getElementById('debug-log');
            logContainer.textContent = debugLog.join('\n');
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // æ§åˆ¶å°ä¹Ÿè¼¸å‡º
            console.log(logEntry);
        }
        
        function clearLogs() {
            debugLog = [];
            document.getElementById('debug-log').textContent = '';
            addLog('æ—¥èªŒå·²æ¸…é™¤');
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(message, type = 'success') {
            const statusEl = document.getElementById('system-status');
            statusEl.className = `status-section ${type === 'error' ? 'error' : type === 'warning' ? 'warning' : ''}`;
            statusEl.innerHTML = `<strong>${message}</strong>`;
        }
        
        function updateInfo(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }
        
        // ç¶²è·¯ç‹€æ…‹æª¢æŸ¥
        function checkNetworkStatus() {
            updateInfo('network-status', navigator.onLine ? 'âœ… åœ¨ç·š' : 'âŒ é›¢ç·š');
            addLog(`ç¶²è·¯ç‹€æ…‹: ${navigator.onLine ? 'åœ¨ç·š' : 'é›¢ç·š'}`);
        }
        
        // APIæ¸¬è©¦å‡½æ•¸
        async function testApi(url, name) {
            try {
                addLog(`é–‹å§‹æ¸¬è©¦ ${name}: ${url}`);
                const startTime = Date.now();
                
                const response = await fetch(url);
                const duration = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`âœ… ${name} æˆåŠŸ (${duration}ms): ${JSON.stringify(data).substring(0, 100)}...`);
                    return { success: true, data, duration };
                } else {
                    addLog(`âŒ ${name} HTTPéŒ¯èª¤: ${response.status} ${response.statusText}`);
                    return { success: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                addLog(`âŒ ${name} ç¶²è·¯éŒ¯èª¤: ${error.message}`);
                return { success: false, error: error.message };
            }
        }
        
        // æ¸¬è©¦è¨‚å–®çµ±è¨ˆ
        async function testOrderCounts() {
            updateStatus('ğŸ” æ¸¬è©¦è¨‚å–®çµ±è¨ˆä¸­...', 'warning');
            const result = await testApi('/api/driver/order-counts', 'è¨‚å–®çµ±è¨ˆAPI');
            
            if (result.success) {
                const totalOrders = Object.values(result.data.counts || {}).reduce((a, b) => a + b, 0);
                updateInfo('order-count', totalOrders);
                updateInfo('api-status', 'âœ… æ­£å¸¸');
                updateStatus('âœ… è¨‚å–®çµ±è¨ˆæ¸¬è©¦æˆåŠŸ');
            } else {
                updateInfo('api-status', 'âŒ ç•°å¸¸');
                updateStatus(`âŒ è¨‚å–®çµ±è¨ˆå¤±æ•—: ${result.error}`, 'error');
            }
        }
        
        // æ¸¬è©¦åœ°å€è¨‚å–®
        async function testAreaOrders() {
            updateStatus('ğŸ” æ¸¬è©¦åœ°å€è¨‚å–®ä¸­...', 'warning');
            const areas = ['ä¸‰å³½å€', 'æ¨¹æ—å€', 'é¶¯æ­Œå€'];
            let successCount = 0;
            
            for (const area of areas) {
                const encodedArea = encodeURIComponent(area);
                const result = await testApi(`/api/driver/area-orders/${encodedArea}`, `${area}è¨‚å–®`);
                if (result.success) successCount++;
            }
            
            if (successCount === areas.length) {
                updateStatus('âœ… åœ°å€è¨‚å–®æ¸¬è©¦å…¨éƒ¨é€šé');
            } else {
                updateStatus(`âš ï¸ åœ°å€è¨‚å–®æ¸¬è©¦: ${successCount}/${areas.length} æˆåŠŸ`, 'warning');
            }
        }
        
        // æ¸¬è©¦çµ±è¨ˆè³‡æ–™
        async function testDriverStats() {
            updateStatus('ğŸ” æ¸¬è©¦çµ±è¨ˆè³‡æ–™ä¸­...', 'warning');
            const result = await testApi('/api/driver/stats', 'çµ±è¨ˆè³‡æ–™API');
            
            if (result.success) {
                updateStatus('âœ… çµ±è¨ˆè³‡æ–™æ¸¬è©¦æˆåŠŸ');
            } else {
                updateStatus(`âŒ çµ±è¨ˆè³‡æ–™å¤±æ•—: ${result.error}`, 'error');
            }
        }
        
        // å®Œæ•´ç³»çµ±æ¸¬è©¦
        async function testFullSystem() {
            updateStatus('ğŸš€ åŸ·è¡Œå®Œæ•´ç³»çµ±æ¸¬è©¦...', 'warning');
            addLog('=== é–‹å§‹å®Œæ•´ç³»çµ±æ¸¬è©¦ ===');
            
            await testOrderCounts();
            await new Promise(resolve => setTimeout(resolve, 1000)); // å»¶é²1ç§’
            
            await testAreaOrders();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            await testDriverStats();
            
            const loadTime = Date.now() - startTime;
            updateInfo('load-time', `${loadTime}ms`);
            
            addLog('=== å®Œæ•´ç³»çµ±æ¸¬è©¦çµæŸ ===');
            updateStatus('âœ… å®Œæ•´ç³»çµ±æ¸¬è©¦å®Œæˆ');
        }
        
        // å‰å¾€å¤–é€å“¡ç³»çµ±
        function goToDriverSystem() {
            addLog('è·³è½‰åˆ°å¤–é€å“¡ç³»çµ±...');
            window.location.href = '/driver/login';
        }
        
        // å›å ±å•é¡Œ
        function reportProblem() {
            const logText = debugLog.join('\n');
            const deviceInfo = {
                userAgent: navigator.userAgent,
                screen: `${screen.width}x${screen.height}`,
                connection: navigator.connection ? navigator.connection.effectiveType : 'æœªçŸ¥',
                timestamp: new Date().toISOString()
            };
            
            const problemReport = `
=== å•é¡Œå›å ± ===
æ™‚é–“: ${deviceInfo.timestamp}
è¨­å‚™: ${deviceInfo.userAgent}
è¢å¹•: ${deviceInfo.screen}
ç¶²è·¯: ${deviceInfo.connection}

=== é™¤éŒ¯æ—¥èªŒ ===
${logText}
            `;
            
            // è¤‡è£½åˆ°å‰ªè²¼æ¿
            if (navigator.clipboard) {
                navigator.clipboard.writeText(problemReport).then(() => {
                    alert('ğŸ“‹ å•é¡Œå ±å‘Šå·²è¤‡è£½åˆ°å‰ªè²¼æ¿ï¼\nè«‹è²¼çµ¦æŠ€è¡“æ”¯æ´äººå“¡ã€‚');
                });
            } else {
                // é¡¯ç¤ºåœ¨å½ˆçª—ä¸­
                alert('å•é¡Œå ±å‘Š:\n' + problemReport.substring(0, 1000) + '...');
            }
            
            addLog('å•é¡Œå›å ±å·²ç”Ÿæˆ');
        }
        
        // é é¢è¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.addEventListener('load', function() {
            addLog('æ‰‹æ©Ÿé™¤éŒ¯é é¢è¼‰å…¥å®Œæˆ');
            checkNetworkStatus();
            
            // 5ç§’å¾Œè‡ªå‹•åŸ·è¡Œå®Œæ•´æ¸¬è©¦
            setTimeout(() => {
                addLog('è‡ªå‹•åŸ·è¡Œç³»çµ±æª¢æŸ¥...');
                testFullSystem();
            }, 2000);
            
            // ç¶²è·¯ç‹€æ…‹è®ŠåŒ–ç›£è½
            window.addEventListener('online', () => {
                addLog('ç¶²è·¯é€£æ¥æ¢å¾©');
                checkNetworkStatus();
            });
            
            window.addEventListener('offline', () => {
                addLog('ç¶²è·¯é€£æ¥ä¸­æ–·');
                checkNetworkStatus();
            });
        });
    </script>
</body>
</html>