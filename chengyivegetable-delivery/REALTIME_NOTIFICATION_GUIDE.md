# å³æ™‚è¨‚å–®ç‹€æ…‹æ¨æ’­ç³»çµ±ä½¿ç”¨æŒ‡å—

## ğŸ‰ ç³»çµ±æ¦‚è¿°

æœ¬ç³»çµ±ç‚ºæ‰¿å„„è”¬èœå¤–é€å¹³å°æä¾›å®Œæ•´çš„å³æ™‚è¨‚å–®ç‹€æ…‹æ¨æ’­åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
- âœ… Server-Sent Events (SSE) å³æ™‚æ¨æ’­
- ğŸ“‹ è¨‚å–®ç‹€æ…‹è®Šæ›´é€šçŸ¥
- ğŸšš å¤–é€å“¡ä½ç½®å³æ™‚è¿½è¹¤
- â° æ™ºèƒ½é…é€æ™‚é–“é ä¼°
- ğŸ“± å¤šå®¢æˆ¶ç«¯åŒæ­¥æ›´æ–°

## ğŸš€ å¿«é€Ÿé–‹å§‹

### 1. ç³»çµ±åˆå§‹åŒ–

é¦–å…ˆç¢ºä¿è³‡æ–™åº«å·²æ­£ç¢ºè¨­ç½®ï¼š

```bash
# 1. åœ¨ PostgreSQL ä¸­åŸ·è¡Œè³‡æ–™åº«åˆå§‹åŒ–
psql -d your_database -f realtime_notifications_schema.sql

# 2. é‡å•Ÿæœå‹™å™¨
npm start
```

### 2. è¨ªå•åŠŸèƒ½

ç³»çµ±å•Ÿå‹•å¾Œï¼Œå³å¯ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼š

- **ç®¡ç†å“¡é¢æ¿**: `http://localhost:3002/admin/dashboard`
- **è¨‚å–®è¿½è¹¤é é¢**: `http://localhost:3002/order-tracking/{è¨‚å–®ID}`
- **SSEé€£æ¥ç«¯é»**: `http://localhost:3002/api/notifications/stream`

## ğŸ“¡ æ ¸å¿ƒåŠŸèƒ½è©³è§£

### 1. å³æ™‚é€šçŸ¥é€£æ¥

ç³»çµ±è‡ªå‹•å»ºç«‹ SSE é€£æ¥ï¼Œæ”¯æ´ï¼š

```javascript
// å‰ç«¯è‡ªå‹•åˆå§‹åŒ–
const notifications = new RealtimeNotificationClient();

// è¨‚é–±è¨‚å–®æ›´æ–°
notifications.subscribeToOrder(orderId);

// è¨‚é–±å¤–é€å“¡ä½ç½®
notifications.subscribeToDriver(driverId);

// ç›£è½äº‹ä»¶
notifications.on('orderUpdate', (data) => {
  console.log('è¨‚å–®ç‹€æ…‹æ›´æ–°:', data);
});
```

### 2. è¨‚å–®ç‹€æ…‹ç®¡ç†

æ”¯æ´çš„è¨‚å–®ç‹€æ…‹æµç¨‹ï¼š
1. **placed** - è¨‚å–®æˆç«‹
2. **confirmed** - è¨‚å–®ç¢ºèª
3. **preparing** - å•†å“æº–å‚™ä¸­
4. **ready** - å•†å“æº–å‚™å®Œæˆ
5. **assigned** - å·²åˆ†é…å¤–é€å“¡
6. **picked_up** - å¤–é€å“¡å·²å–è²¨
7. **delivering** - é…é€ä¸­
8. **delivered** - å·²é€é”
9. **completed** - è¨‚å–®å®Œæˆ

### 3. å¤–é€å“¡ä½ç½®è¿½è¹¤

ç³»çµ±æä¾›ç²¾ç¢ºçš„å¤–é€å“¡ä½ç½®è¿½è¹¤ï¼š

```javascript
// æ›´æ–°å¤–é€å“¡ä½ç½®
const locationData = {
  lat: 24.1477,
  lng: 120.6736,
  accuracy: 10,
  speed: 25,
  orderId: 123
};

// ç³»çµ±è‡ªå‹•å»£æ’­ä½ç½®æ›´æ–°çµ¦ç›¸é—œå®¢æˆ¶
```

### 4. æ™ºèƒ½æ™‚é–“é ä¼°

ç³»çµ±æ ¹æ“šå¤šå€‹å› ç´ è¨ˆç®—é è¨ˆé€é”æ™‚é–“ï¼š
- ğŸ“¦ å•†å“æº–å‚™æ™‚é–“
- ğŸšš å¤–é€å“¡åˆ°åº—æ™‚é–“
- ğŸ“ é…é€è·é›¢å’Œè·¯æ³
- â° æ™‚æ®µäº¤é€šç‹€æ³
- ğŸŒ¦ï¸ å¤©æ°£å½±éŸ¿

## ğŸ”§ API ä½¿ç”¨èªªæ˜

### SSE é€£æ¥

```javascript
// å»ºç«‹é€£æ¥
GET /api/notifications/stream?userId={ç”¨æˆ¶ID}&userType={ç”¨æˆ¶é¡å‹}

// æ¥æ”¶äº‹ä»¶é¡å‹:
- connected: é€£æ¥ç¢ºèª
- orderUpdate: è¨‚å–®ç‹€æ…‹æ›´æ–°
- driverLocation: å¤–é€å“¡ä½ç½®æ›´æ–°
- systemNotification: ç³»çµ±é€šçŸ¥
- heartbeat: å¿ƒè·³åŒ…
```

### è¨‚å–®ç‹€æ…‹ API

```bash
# æ›´æ–°è¨‚å–®ç‹€æ…‹
POST /api/notifications/order/{è¨‚å–®ID}/status
{
  "status": "confirmed",
  "changedBy": "admin",
  "notes": "è¨‚å–®å·²ç¢ºèª"
}

# åˆ†é…å¤–é€å“¡
POST /api/notifications/order/{è¨‚å–®ID}/assign-driver
{
  "driverId": 1,
  "assignedBy": "admin"
}

# ç²å–è¨‚å–®ç‹€æ…‹æ­·å²
GET /api/notifications/order/{è¨‚å–®ID}/status-history
```

### å¤–é€å“¡ä½ç½® API

```bash
# æ›´æ–°å¤–é€å“¡ä½ç½®
POST /api/notifications/driver/{å¤–é€å“¡ID}/location
{
  "lat": 24.1477,
  "lng": 120.6736,
  "accuracy": 10,
  "speed": 25,
  "orderId": 123
}

# é–‹å§‹ä½ç½®è¿½è¹¤
POST /api/notifications/driver/{å¤–é€å“¡ID}/start-tracking
{
  "orderId": 123
}

# åœæ­¢ä½ç½®è¿½è¹¤
POST /api/notifications/driver/{å¤–é€å“¡ID}/stop-tracking

# ç²å–é™„è¿‘å¤–é€å“¡
GET /api/notifications/nearby-drivers?lat=24.1477&lng=120.6736&radius=5
```

## ğŸ“± å‰ç«¯æ•´åˆ

### 1. å¼•å…¥å³æ™‚é€šçŸ¥è…³æœ¬

```html
<!-- åœ¨é é¢ä¸­å¼•å…¥å³æ™‚é€šçŸ¥å®¢æˆ¶ç«¯ -->
<script src="/js/realtime-notifications.js"></script>
```

### 2. åˆå§‹åŒ–å’Œä½¿ç”¨

```javascript
// ç³»çµ±æœƒè‡ªå‹•åˆå§‹åŒ–ï¼Œä¹Ÿå¯ä»¥æ‰‹å‹•å‰µå»º
const notifications = window.realtimeNotifications;

// è¨‚é–±è¨‚å–®æ›´æ–°
await notifications.subscribeToOrder(orderId);

// ç›£è½è¨‚å–®ç‹€æ…‹è®Šæ›´
notifications.on('orderUpdate', (data) => {
  // æ›´æ–°é é¢é¡¯ç¤º
  updateOrderStatus(data);
});

// ç›£è½å¤–é€å“¡ä½ç½®æ›´æ–°
notifications.on('driverLocation', (data) => {
  // æ›´æ–°åœ°åœ–é¡¯ç¤º
  updateDriverLocationOnMap(data);
});

// è«‹æ±‚ç€è¦½å™¨é€šçŸ¥æ¬Šé™
await notifications.requestNotificationPermission();
```

### 3. è¨‚å–®è¿½è¹¤é é¢

ç³»çµ±æä¾›å®Œæ•´çš„è¨‚å–®è¿½è¹¤é é¢ï¼š

```bash
# è¨ªå•è¨‚å–®è¿½è¹¤é é¢
http://localhost:3002/order-tracking/{è¨‚å–®ID}
```

é é¢åŠŸèƒ½ï¼š
- ğŸ“‹ è¨‚å–®ç‹€æ…‹æ™‚é–“è»¸
- ğŸšš å¤–é€å“¡è³‡è¨Šé¡¯ç¤º
- ğŸ“ å³æ™‚ä½ç½®åœ°åœ–
- â° é è¨ˆé€é”å€’æ•¸
- ğŸ”” å³æ™‚é€šçŸ¥å½ˆçª—

## ğŸ§ª ç³»çµ±æ¸¬è©¦

ä½¿ç”¨æä¾›çš„æ¸¬è©¦è…³æœ¬é©—è­‰ç³»çµ±åŠŸèƒ½ï¼š

```bash
# é‹è¡Œå®Œæ•´æ¸¬è©¦
node test_realtime_notifications.js
```

æ¸¬è©¦é …ç›®ï¼š
- âœ… è³‡æ–™åº« Schema æª¢æŸ¥
- âœ… SSE é€£æ¥æ¸¬è©¦
- âœ… è¨‚å–®ç‹€æ…‹æ›´æ–°æ¸¬è©¦
- âœ… å¤–é€å“¡ä½ç½®æ›´æ–°æ¸¬è©¦
- âœ… é€šçŸ¥å»£æ’­æ¸¬è©¦
- âœ… å¤šé‡é€£æ¥æ¸¬è©¦
- âœ… è¨‚å–®è¿½è¹¤æµç¨‹æ¸¬è©¦

## ğŸ”§ ç®¡ç†å“¡åŠŸèƒ½

### 1. é€£æ¥ç›£æ§

```bash
# ç²å–é€£æ¥çµ±è¨ˆ
GET /api/notifications/stats

# å›æ‡‰ç¯„ä¾‹:
{
  "totalConnections": 15,
  "orderSubscriptions": 8,
  "driverSubscriptions": 5,
  "connectionsByType": {
    "customer": 10,
    "admin": 3,
    "driver": 2
  }
}
```

### 2. ç³»çµ±é€šçŸ¥

```bash
# ç™¼é€ç³»çµ±é€šçŸ¥
POST /api/notifications/test-notification
{
  "message": "ç³»çµ±ç¶­è­·é€šçŸ¥",
  "level": "warning"
}
```

### 3. å¤–é€å“¡ç®¡ç†

```bash
# ç²å–å¤–é€å“¡çµ±è¨ˆ
GET /api/notifications/driver-stats

# å›æ‡‰ç¯„ä¾‹:
{
  "total_drivers": 10,
  "online_drivers": 6,
  "busy_drivers": 3,
  "delivering_drivers": 1
}
```

## âš ï¸ æ³¨æ„äº‹é …

### 1. ç€è¦½å™¨æ”¯æ´

- éœ€è¦ç¾ä»£ç€è¦½å™¨æ”¯æ´ Server-Sent Events
- å»ºè­°å•Ÿç”¨ç€è¦½å™¨é€šçŸ¥åŠŸèƒ½
- ç§»å‹•è£ç½®éœ€è¦ä¿æŒé é¢æ´»èºç‹€æ…‹

### 2. ç¶²è·¯é€£æ¥

- SSE é€£æ¥éœ€è¦ç©©å®šçš„ç¶²è·¯ç’°å¢ƒ
- ç³»çµ±å…·å‚™è‡ªå‹•é‡é€£æ©Ÿåˆ¶
- ç¶²è·¯ä¸­æ–·æ™‚æœƒé¡¯ç¤ºé€£æ¥ç‹€æ…‹

### 3. æ•ˆèƒ½è€ƒé‡

- ç³»çµ±è‡ªå‹•æ¸…ç†éæœŸçš„ä½ç½®è¨˜éŒ„
- é€£æ¥æ•¸éå¤šæ™‚æœƒè‡ªå‹•é™åˆ¶
- å»ºè­°å®šæœŸé‡å•Ÿæœå‹™ä»¥æ¸…ç†è¨˜æ†¶é«”

### 4. è³‡æ–™å®‰å…¨

- ä½ç½®è³‡æ–™å·²åŠ å¯†å‚³è¼¸
- é€šçŸ¥å…§å®¹ä¸åŒ…å«æ•æ„Ÿè³‡è¨Š
- å»ºè­°åœ¨ç”Ÿç”¢ç’°å¢ƒé…ç½® HTTPS

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

1. **SSE é€£æ¥å¤±æ•—**
   - æª¢æŸ¥é˜²ç«ç‰†è¨­å®š
   - ç¢ºèªæœå‹™å™¨æ­£å¸¸é‹è¡Œ
   - æŸ¥çœ‹ç€è¦½å™¨æ§åˆ¶å°éŒ¯èª¤

2. **é€šçŸ¥æœªæ”¶åˆ°**
   - ç¢ºèªå·²æ­£ç¢ºè¨‚é–±
   - æª¢æŸ¥ç¶²è·¯é€£æ¥ç‹€æ…‹
   - æŸ¥çœ‹æœå‹™å™¨æ—¥èªŒ

3. **ä½ç½®æ›´æ–°ç•°å¸¸**
   - ç¢ºèªGPSæ¬Šé™å·²é–‹å•Ÿ
   - æª¢æŸ¥ä½ç½®è³‡æ–™æ ¼å¼
   - é©—è­‰å¤–é€å“¡IDæ­£ç¢ºæ€§

### æ—¥èªŒç›£æ§

ç³»çµ±æœƒè¨˜éŒ„è©³ç´°çš„æ“ä½œæ—¥èªŒï¼š

```bash
# æœå‹™å™¨æ—¥èªŒç¯„ä¾‹
ğŸ“¡ æ–°çš„SSEé€£æ¥å»ºç«‹: conn_1_1640995200000 (customer:user123)
ğŸ“‹ è¨‚å–® 123 ç‹€æ…‹å·²æ›´æ–°: placed -> confirmed
ğŸšš å¤–é€å“¡ 1 ä½ç½®å·²æ›´æ–°: (24.1477, 120.6736)
ğŸ“¢ è¨‚å–® 123 æ›´æ–°å·²å»£æ’­çµ¦ 2 å€‹é€£æ¥
```

## ğŸ“ æŠ€è¡“æ”¯æ´

å¦‚é‡åˆ°å•é¡Œï¼Œè«‹æª¢æŸ¥ï¼š
1. æœå‹™å™¨æ—¥èªŒæª”æ¡ˆ
2. ç€è¦½å™¨é–‹ç™¼è€…å·¥å…·
3. è³‡æ–™åº«é€£æ¥ç‹€æ…‹
4. ç¶²è·¯é€£æ¥ç‹€æ³

---

ğŸ‰ **æ­å–œï¼** å³æ™‚è¨‚å–®ç‹€æ…‹æ¨æ’­ç³»çµ±å·²æˆåŠŸæ•´åˆå®Œæˆï¼Œç¾åœ¨æ‚¨çš„å¤–é€å¹³å°å…·å‚™äº†å®Œæ•´çš„å³æ™‚é€šçŸ¥åŠŸèƒ½ï¼