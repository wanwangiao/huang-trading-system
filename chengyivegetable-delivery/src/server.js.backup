const express = require('express'),
      session = require('express-session'),
      bodyParser = require('body-parser'),
      { Pool } = require('pg'),
      path = require('path'),
      helmet = require('helmet'),
      compression = require('compression'),
      cors = require('cors'),
      dns = require('dns');

require('dotenv').config();

dns.setDefaultResultOrder('ipv4first');
process.env.FORCE_IPV4 = '1';

const SUPABASE_IPv4_MAP = {
  'db.cywcuzgbuqmxjxwyrrsp.supabase.co': '18.206.107.106'
};

process.env.NODE_OPTIONS = '--dns-result-order=ipv4first';

const { apiLimiter, orderLimiter, loginLimiter } = require('./middleware/rateLimiter'),
      { validateOrderData, validateAdminPassword, sanitizeInput } = require('./middleware/validation'),
      { apiErrorHandler, pageErrorHandler, notFoundHandler, asyncWrapper } = require('./middleware/errorHandler'),
      { createAgentSystem } = require('./agents'),
      driverApiRoutes = require('./routes/driver_api'),
      { router: googleMapsApiRoutes, setDatabasePool: setGoogleMapsDatabasePool } = require('./routes/google_maps_api'),
      SmartRouteService = require('./services/SmartRouteService');

let agentSystem = null;
let smartRouteService = null;

const app = express(),
      port = process.env.PORT || 3002;

let pool,
    demoMode = false;

async function createDatabasePool() {
  // è¨­ç½® Node.js ç’°å¢ƒä½¿ç”¨ UTF-8 ç·¨ç¢¼
  process.env.LC_ALL = 'zh_TW.UTF-8';
  process.env.LANG = 'zh_TW.UTF-8';
  
  console.log('ğŸ”§ é–‹å§‹å˜—è©¦è³‡æ–™åº«é€£ç·š...');
  console.log('ğŸ” ç’°å¢ƒè®Šæ•¸æª¢æŸ¥:');
  console.log('  DATABASE_URL:', process.env.DATABASE_URL ? 'å·²è¨­å®š' : 'æœªè¨­å®š');
  console.log('  NODE_ENV:', process.env.NODE_ENV);
  
  const errors = [];
  
  // æ–¹æ³•1: å„ªå…ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼ˆæ­£ç¢ºæ–¹å¼ï¼‰
  if (process.env.DATABASE_URL) {
    console.log('æ–¹æ³•1: ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ DATABASE_URL...');
    try {
      pool = new Pool({
        connectionString: process.env.DATABASE_URL,
        ssl: { rejectUnauthorized: false },
        connectionTimeoutMillis: 60000,
        idleTimeoutMillis: 30000,
        max: 5,
        // ç¢ºä¿è³‡æ–™åº«é€£ç·šä½¿ç”¨ UTF-8 ç·¨ç¢¼
        options: '--client_encoding=UTF8'
      });
      
      const testResult = await pool.query('SELECT NOW() as current_time');
      console.log('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ (ç’°å¢ƒè®Šæ•¸)', testResult.rows[0]);
      demoMode = false;
      return pool;
      
    } catch (error1) {
      console.log('âŒ ç’°å¢ƒè®Šæ•¸é€£ç·šå¤±æ•—:', error1.code, error1.message);
      errors.push({ method: 'ç’°å¢ƒè®Šæ•¸', error: error1.message });
    }
  } else {
    console.log('âš ï¸ DATABASE_URL ç’°å¢ƒè®Šæ•¸æœªè¨­å®š');
    errors.push({ method: 'ç’°å¢ƒè®Šæ•¸', error: 'DATABASE_URL æœªè¨­å®š' });
  }
  
  // æ–¹æ³•2: ç›´æ¥IPåœ°å€é€£ç·šï¼ˆå°ˆå®¶å»ºè­°ï¼‰
  console.log('æ–¹æ³•2: ä½¿ç”¨ç›´æ¥IPåœ°å€é€£ç·š...');
  try {
    const directIP = SUPABASE_IPv4_MAPPING['db.cywcuzgbuqmxjxwyrrsp.supabase.co'];
    console.log(`ğŸ”— å˜—è©¦ç›´æ¥é€£ç·šåˆ° IP: ${directIP}`);
    
    pool = new Pool({
      host: directIP,
      port: 5432,
      database: 'postgres',
      user: 'postgres',
      password: 'Chengyivegetable2025!',
      ssl: { 
        rejectUnauthorized: false,
        // å› ç‚ºä½¿ç”¨IPè€ŒéåŸŸåï¼Œéœ€è¦æŒ‡å®šservername
        servername: 'db.cywcuzgbuqmxjxwyrrsp.supabase.co'
      },
      connectionTimeoutMillis: 30000,
      idleTimeoutMillis: 30000,
      max: 5
    });
    
    const testResult = await pool.query('SELECT NOW() as current_time');
    console.log('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ (ç›´æ¥IP)', testResult.rows[0]);
    demoMode = false;
    return pool;
    
  } catch (error2) {
    console.log('âŒ ç›´æ¥IPé€£ç·šå¤±æ•—:', error2.code, error2.message);
    errors.push({ method: 'ç›´æ¥IP', error: error2.message });
  }
  
  // æ–¹æ³•3: ä½¿ç”¨Supabaseæ¨™æº–IPv4æ± 
  console.log('æ–¹æ³•3: ä½¿ç”¨Supabase IPv4é€£ç·šæ± ...');
  try {
    pool = new Pool({
      connectionString: process.env.DATABASE_URL?.replace('db.cywcuzgbuqmxjxwyrrsp.supabase.co', 'aws-0-us-east-1.pooler.supabase.com'),
      ssl: { rejectUnauthorized: false },
      connectionTimeoutMillis: 30000,
      idleTimeoutMillis: 30000,
      max: 5
    });
    
    const testResult = await pool.query('SELECT NOW() as current_time');
    console.log('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ (Supabaseé€£ç·šæ± )', testResult.rows[0]);
    demoMode = false;
    return pool;
    
  } catch (error3) {
    console.log('âŒ Supabaseé€£ç·šæ± å¤±æ•—:', error3.code, error3.message);
    errors.push({ method: 'Supabaseé€£ç·šæ± ', error: error3.message });
  }
  
  
  // æ–¹æ³•3: ä½¿ç”¨è§£æçš„IPåœ°å€ç›´æ¥é€£ç·š
  console.log('æ–¹æ³•3: ä½¿ç”¨IPåœ°å€ç›´æ¥é€£ç·š...');
  try {
    // æ‰‹å‹•è§£æç‚ºIPv4åœ°å€
    const { promisify } = require('util');
    const resolve4 = promisify(dns.resolve4);
    const ipAddresses = await resolve4('db.cywcuzgbuqmxjxwyrrsp.supabase.co');
    const ipAddress = ipAddresses[0]; // ä½¿ç”¨ç¬¬ä¸€å€‹IPv4åœ°å€
    
    console.log(`ğŸ” è§£æåˆ°IPv4åœ°å€: ${ipAddress}`);
    
    pool = new Pool({
      host: ipAddress,
      port: 5432,
      database: 'postgres',
      user: 'postgres',
      password: 'Chengyivegetable2025!',
      ssl: { rejectUnauthorized: false },
      connectionTimeoutMillis: 60000,
      idleTimeoutMillis: 30000,
      max: 5,
      // ç¢ºä¿ä½¿ç”¨IPv4
      family: 4
    });
    
    const testResult = await pool.query('SELECT NOW() as current_time');
    console.log('âœ… è³‡æ–™åº«é€£ç·šæˆåŠŸ (IPç›´é€£)', testResult.rows[0]);
    demoMode = false;
    return pool;
    
  } catch (error3) {
    console.log('âŒ IPç›´é€£å¤±æ•—:', error3.code, error3.message);
    errors.push({ method: 'IPç›´é€£', error: error3.message });
  }
  
  // è¨˜éŒ„æ‰€æœ‰éŒ¯èª¤
  console.log('âŒ æ‰€æœ‰é€£ç·šæ–¹æ³•éƒ½å¤±æ•—äº†');
  errors.forEach((err, index) => {
    console.log(`âŒ éŒ¯èª¤${index + 1} (${err.method}):`, err.error);
  });
  
  // æœ€å¾Œé¸æ“‡ - å•Ÿç”¨ç¤ºç¯„æ¨¡å¼
  console.log('ğŸ”„ å•Ÿç”¨ç¤ºç¯„æ¨¡å¼ - ä½¿ç”¨æœ¬æ©Ÿç¤ºç¯„è³‡æ–™');
  demoMode = true;
  
  // å‰µå»ºä¸€å€‹æ¨¡æ“¬çš„ pool é¿å…å´©æ½°
  pool = {
    query: async (sql, params) => {
      console.log('ğŸ“ æ¨¡æ“¬SQLæŸ¥è©¢:', sql.substring(0, 50));
      throw new Error('è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œæ­£åœ¨ä½¿ç”¨ç¤ºç¯„è³‡æ–™');
    },
    end: () => console.log('ğŸ“´ æ¨¡æ“¬è³‡æ–™åº«é€£ç·šçµæŸ')
  };
  
  return pool;
}

// åˆå§‹åŒ–è³‡æ–™åº«é€£ç·š
createDatabasePool().then(async () => {
  // åˆå§‹åŒ– Agent ç³»çµ±
  try {
    agentSystem = createAgentSystem(pool);
    await agentSystem.initialize();
    console.log('ğŸ¤– Agent ç³»çµ±å·²å•Ÿå‹•');
  } catch (error) {
    console.error('âŒ Agent ç³»çµ±å•Ÿå‹•å¤±æ•—:', error);
    // å³ä½¿ Agent ç³»çµ±å•Ÿå‹•å¤±æ•—ï¼Œä¼ºæœå™¨ä»å¯ç¹¼çºŒé‹è¡Œ
  }
  
  // åˆå§‹åŒ– Google Maps API æœå‹™
  try {
    setGoogleMapsDatabasePool(pool);
    console.log('ğŸ—ºï¸ Google Maps API æœå‹™å·²åˆå§‹åŒ–');
  } catch (error) {
    console.error('âŒ Google Maps API æœå‹™åˆå§‹åŒ–å¤±æ•—:', error);
  }
  
  // åˆå§‹åŒ–æ™ºèƒ½è·¯ç·šæœå‹™
  try {
    smartRouteService = new SmartRouteService(pool);
    console.log('ğŸ§  SmartRouteService å·²åˆå§‹åŒ–');
  } catch (error) {
    console.error('âŒ SmartRouteService åˆå§‹åŒ–å¤±æ•—:', error);
  }
}).catch(console.error);

// è¨­å®š view engine èˆ‡éœæ…‹æª”æ¡ˆ
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, '../views'));
// è¨­ç½® EJS æ¨¡æ¿çš„ UTF-8 ç·¨ç¢¼
app.set('view options', { 
  rmWhitespace: true,
  charset: 'utf-8'
});
app.use(express.static(path.join(__dirname, '../public')));

// è™•ç† favicon.ico è«‹æ±‚
app.get('/favicon.ico', (req, res) => {
  res.status(204).send(); // è¿”å› 204 No Content
});

// å®‰å…¨æ€§ä¸­é–“ä»¶ - æš«æ™‚ç¦ç”¨ CSP ä¾†ä¿®å¾© 502 éŒ¯èª¤
app.use(helmet({
  contentSecurityPolicy: false // æš«æ™‚ç¦ç”¨ CSP
}));

// å£“ç¸®å›æ‡‰
app.use(compression());

// CORSè¨­å®š
app.use(cors({
  origin: process.env.NODE_ENV === 'production' 
    ? [process.env.FRONTEND_URL] 
    : ['http://localhost:3000', 'http://127.0.0.1:3000'],
  credentials: true
}));

// è¨­ç½®ä¸­æ–‡ç·¨ç¢¼æ”¯æ´
app.use((req, res, next) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  res.setHeader('Accept-Charset', 'utf-8');
  next();
});

// ä¸€èˆ¬APIé™åˆ¶
app.use('/api/', apiLimiter);

// è§£æè«‹æ±‚é«” - è¨­ç½®æ­£ç¢ºçš„ä¸­æ–‡ç·¨ç¢¼
app.use(bodyParser.json({ 
  limit: '10mb',
  type: 'application/json',
  charset: 'utf-8'
}));
app.use(bodyParser.urlencoded({ 
  extended: false, 
  limit: '10mb',
  charset: 'utf-8'
}));

// è¨­ç½®éŸ¿æ‡‰é ­ç¢ºä¿ä¸­æ–‡æ­£ç¢ºé¡¯ç¤º
app.use((req, res, next) => {
  res.setHeader('Content-Type', 'text/html; charset=utf-8');
  next();
});

// Sessioné…ç½®
app.use(session({
  secret: process.env.SESSION_SECRET || 'chengyi-secret-key-change-in-production',
  resave: false,
  saveUninitialized: false,
  cookie: {
    secure: false, // æš«æ™‚é—œé–‰ secure è¦æ±‚ï¼Œä»¥ä¾¿æ’æŸ¥å•é¡Œ
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000 // 24å°æ™‚
  }
}));

// å°‡ LINE ç¶å®šç‹€æ…‹å‚³éè‡³æ‰€æœ‰æ¨¡æ¿
app.use((req, res, next) => {
  res.locals.sessionLine = req.session ? req.session.line : null;
  next();
});

// è¨­ç½®å…¨å±€è®Šæ•¸ä¾›è·¯ç”±ä½¿ç”¨
app.use((req, res, next) => {
  req.app.locals.pool = pool;
  req.app.locals.demoMode = demoMode;
  next();
});

// å¤–é€å“¡APIè·¯ç”±
app.use('/api/driver', driverApiRoutes);

// Google Maps APIè·¯ç”±
app.use('/api/maps', googleMapsApiRoutes);

// æ™ºèƒ½è·¯ç·šAPIç«¯é»
app.post('/api/smart-route/plan', ensureAdmin, async (req, res) => {
  try {
    const { orderIds, options = {} } = req.body;
    
    if (!Array.isArray(orderIds) || orderIds.length === 0) {
      return res.status(400).json({
        success: false,
        message: 'è¨‚å–®IDåˆ—è¡¨å¿…å¡«ä¸”ä¸èƒ½ç‚ºç©º'
      });
    }

    if (!smartRouteService) {
      return res.status(503).json({
        success: false,
        message: 'æ™ºèƒ½è·¯ç·šæœå‹™å°šæœªåˆå§‹åŒ–'
      });
    }

    const routePlan = await smartRouteService.planSmartRoute(orderIds, options);

    res.json({
      success: true,
      message: 'æ™ºèƒ½è·¯ç·šè¦åŠƒå®Œæˆ',
      data: routePlan
    });

  } catch (error) {
    console.error('æ™ºèƒ½è·¯ç·šè¦åŠƒAPIéŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'æ™ºèƒ½è·¯ç·šè¦åŠƒå¤±æ•—: ' + error.message
    });
  }
});

app.get('/api/smart-route/plans', ensureAdmin, async (req, res) => {
  try {
    if (!smartRouteService) {
      return res.status(503).json({
        success: false,
        message: 'æ™ºèƒ½è·¯ç·šæœå‹™å°šæœªåˆå§‹åŒ–'
      });
    }

    const options = {
      status: req.query.status,
      limit: parseInt(req.query.limit) || 50,
      offset: parseInt(req.query.offset) || 0,
      startDate: req.query.startDate,
      endDate: req.query.endDate
    };

    const plans = await smartRouteService.getRoutePlans(options);

    res.json({
      success: true,
      data: plans,
      count: plans.length
    });

  } catch (error) {
    console.error('ç²å–è·¯ç·šè¨ˆåŠƒAPIéŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'ç²å–è·¯ç·šè¨ˆåŠƒå¤±æ•—: ' + error.message
    });
  }
});

app.get('/api/smart-route/plans/:planId', ensureAdmin, async (req, res) => {
  try {
    const { planId } = req.params;

    if (!smartRouteService) {
      return res.status(503).json({
        success: false,
        message: 'æ™ºèƒ½è·¯ç·šæœå‹™å°šæœªåˆå§‹åŒ–'
      });
    }

    const planDetails = await smartRouteService.getRoutePlanDetails(planId);

    res.json({
      success: true,
      data: planDetails
    });

  } catch (error) {
    console.error('ç²å–è·¯ç·šè¨ˆåŠƒè©³æƒ…APIéŒ¯èª¤:', error);
    res.status(500).json({
      success: false,
      message: 'ç²å–è·¯ç·šè¨ˆåŠƒè©³æƒ…å¤±æ•—: ' + error.message
    });
  }
});

// åœ°ç†ç·¨ç¢¼ï¼šå°‡åœ°å€è½‰ç‚ºåº§æ¨™
async function geocodeAddress(address) {
  const apiKey = process.env.GOOGLE_MAPS_API_KEY;
  if (!apiKey) {
    return { lat: null, lng: null, status: 'no_api_key' };
  }
  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address)}&key=${apiKey}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.status === 'OK' && data.results && data.results[0]) {
      const loc = data.results[0].geometry.location;
      return { lat: loc.lat, lng: loc.lng, status: 'OK' };
    }
    return { lat: null, lng: null, status: data.status };
  } catch (e) {
    return { lat: null, lng: null, status: 'error' };
  }
}

// å„²å­˜æˆ–æ›´æ–°ä½¿ç”¨è€…ï¼ˆä¾æ‰‹æ©Ÿç‚ºä¸»éµï¼‰
async function upsertUser(phone, name, lineUserId, lineDisplayName) {
  if (demoMode) {
    console.log('ğŸ“ ç¤ºç¯„æ¨¡å¼ï¼šæ¨¡æ“¬ç”¨æˆ¶è³‡æ–™å„²å­˜', { phone, name, lineUserId });
    return;
  }
  
  try {
    await pool.query(
      'INSERT INTO users (phone, name, line_user_id, line_display_name) VALUES ($1,$2,$3,$4) ON CONFLICT (phone) DO UPDATE SET line_user_id=EXCLUDED.line_user_id, line_display_name=EXCLUDED.line_display_name, name=EXCLUDED.name',
      [phone, name || null, lineUserId || null, lineDisplayName || null]
    );
  } catch (e) {
    console.error('Upsert user error:', e.message);
  }
}

// ç¤ºç¯„ç”¢å“è³‡æ–™
const demoProducts = [
  { id: 1, name: 'ğŸ¥¬ æœ‰æ©Ÿé«˜éº—èœ', price: 80, is_priced_item: false, unit_hint: 'æ¯é¡†' },
  { id: 2, name: 'ğŸ… æ–°é®®ç•ªèŒ„', price: null, is_priced_item: true, unit_hint: 'æ¯å…¬æ–¤' },
  { id: 3, name: 'ğŸ¥¬ é’æ±Ÿèœ', price: 40, is_priced_item: false, unit_hint: 'æ¯æŠŠ' },
  { id: 4, name: 'ğŸ¥• èƒ¡è˜¿è””', price: null, is_priced_item: true, unit_hint: 'æ¯å…¬æ–¤' },
  { id: 5, name: 'ğŸ¥’ å°é»ƒç“œ', price: 60, is_priced_item: false, unit_hint: 'æ¯åŒ…' },
  { id: 6, name: 'ğŸ§… æ´‹è”¥', price: null, is_priced_item: true, unit_hint: 'æ¯å…¬æ–¤' }
];

// å–å¾—ç”¢å“è³‡æ–™
async function fetchProducts() {
  // å¦‚æœæ˜¯ç¤ºç¯„æ¨¡å¼ï¼Œç›´æ¥è¿”å›ç¤ºç¯„è³‡æ–™
  if (demoMode) {
    console.log('ğŸ“¦ ä½¿ç”¨ç¤ºç¯„ç”¢å“è³‡æ–™ (å…±', demoProducts.length, 'é …)');
    return demoProducts;
  }
  
  try {
    if (!pool) {
      await createDatabasePool();
    }
    
    // å¦‚æœåˆå§‹åŒ–å¾Œä»æ˜¯ç¤ºç¯„æ¨¡å¼
    if (demoMode) {
      return demoProducts;
    }
    
    const { rows } = await pool.query('SELECT * FROM products ORDER BY id');
    console.log('âœ… æˆåŠŸå¾è³‡æ–™åº«ç²å–', rows.length, 'å€‹ç”¢å“');
    return rows;
    
  } catch (error) {
    console.log('âŒ è³‡æ–™åº«æŸ¥è©¢å¤±æ•—ï¼Œåˆ‡æ›åˆ°ç¤ºç¯„æ¨¡å¼:', error.message);
    demoMode = true;
    return demoProducts;
  }
}

// å‰å°ï¼šé¦–é ï¼Œåˆ—å‡ºå•†å“
app.get('/', async (req, res, next) => {
  try {
    const products = await fetchProducts();
    res.render('index', { 
      products: products,
      sessionLine: req.session.line || null
    });
  } catch (err) {
    next(err);
  }
});

// ğŸš› å¤–é€å“¡ç™»å…¥é é¢
app.get('/driver/login', (req, res) => {
  res.render('driver_login', { error: null });
});

// ğŸš› å¤–é€å“¡ç™»å…¥è™•ç†
app.post('/driver/login', async (req, res) => {
  const { phone, password } = req.body;
  
  try {
    // é€™è£¡å¯ä»¥å¾è³‡æ–™åº«é©—è­‰å¤–é€å“¡
    // æš«æ™‚ä½¿ç”¨é è¨­å¸³è™Ÿï¼šæ‰‹æ©Ÿ 0912345678ï¼Œå¯†ç¢¼ driver123
    if (phone === '0912345678' && password === 'driver123') {
      req.session.driverId = 1;
      req.session.driverName = 'æå¤§æ˜';
      return res.redirect('/driver/dashboard');
    }
    
    res.render('driver_login', { error: 'æ‰‹æ©Ÿè™Ÿç¢¼æˆ–å¯†ç¢¼éŒ¯èª¤' });
  } catch (error) {
    console.error('å¤–é€å“¡ç™»å…¥éŒ¯èª¤:', error);
    res.render('driver_login', { error: 'ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦' });
  }
});

// ğŸš› å¤–é€å“¡å·¥ä½œå°
app.get('/driver/dashboard', (req, res) => {
  if (!req.session.driverId) {
    return res.redirect('/driver/login');
  }
  
  res.render('driver_dashboard', {
    driver: {
      id: req.session.driverId,
      name: req.session.driverName || 'å¤–é€å“¡'
    }
  });
});

// ğŸš› å¤–é€å“¡ç™»å‡º
app.get('/driver/logout', (req, res) => {
  req.session.driverId = null;
  req.session.driverName = null;
  res.redirect('/driver/login');
});

// ğŸš› å¤–é€å“¡API - å¯æ¥è¨‚å–®
app.get('/api/driver/available-orders', async (req, res) => {
  try {
    let orders = [];
    
    if (!demoMode && pool) {
      // å¾è³‡æ–™åº«ç²å–å·²åŒ…è£ä½†æœªæ¥å–çš„è¨‚å–®
      const query = `
        SELECT o.*, 
               c.name as customer_name, 
               c.phone as customer_phone,
               c.address,
               COALESCE(o.delivery_fee, 0) as delivery_fee
        FROM orders o
        JOIN customers c ON o.customer_id = c.id
        WHERE o.status = 'packed' 
          AND o.driver_id IS NULL
        ORDER BY o.created_at ASC
      `;
      
      const result = await pool.query(query);
      orders = result.rows;
      
      // ç‚ºæ¯å€‹è¨‚å–®ç²å–å•†å“è©³æƒ…
      for (let order of orders) {
        const itemsQuery = `
          SELECT oi.*, p.name as product_name
          FROM order_items oi
          JOIN products p ON oi.product_id = p.id
          WHERE oi.order_id = $1
        `;
        const itemsResult = await pool.query(itemsQuery, [order.id]);
        order.items = itemsResult.rows;
        order.total = parseFloat(order.total_amount || 0);
        order.packed_at = order.packed_at || order.updated_at;
      }
    } else {
      // Demoæ¨¡å¼çš„ç¯„ä¾‹æ•¸æ“š
      orders = [
        {
          id: 1234,
          customer_name: 'ç‹å°æ˜',
          customer_phone: '0912-345-678',
          address: 'æ–°åŒ—å¸‚ä¸‰å³½å€ä¸­å±±è·¯123è™Ÿ',
          total: 185,
          delivery_fee: 0,
          packed_at: new Date(Date.now() - 30 * 60 * 1000).toISOString(),
          items: [
            { product_name: 'é«˜éº—èœ', quantity: 2, price: 45 },
            { product_name: 'è‘¡è„', quantity: 1, price: 95 }
          ]
        },
        {
          id: 1235,
          customer_name: 'æå°è¯',
          customer_phone: '0923-456-789',
          address: 'æ–°åŒ—å¸‚åŒ—å¤§ç‰¹å€å­¸æˆè·¯456è™Ÿ',
          total: 230,
          delivery_fee: 0,
          packed_at: new Date(Date.now() - 45 * 60 * 1000).toISOString(),
          items: [
            { product_name: 'ç•ªèŒ„', quantity: 3, price: 60 },
            { product_name: 'èƒ¡è˜¿è””', quantity: 2, price: 35 }
          ]
        }
      ];
    }
    
    res.json({ success: true, orders });
  } catch (error) {
    console.error('ç²å–å¯æ¥è¨‚å–®å¤±æ•—:', error);
    res.status(500).json({ success: false, message: 'ç²å–è¨‚å–®å¤±æ•—' });
  }
});

// ğŸš› å¤–é€å“¡API - æˆ‘çš„é…é€
app.get('/api/driver/my-orders', async (req, res) => {
  try {
    const driverId = req.session.driverId;
    if (!driverId) {
      return res.status(401).json({ success: false, message: 'è«‹å…ˆç™»å…¥' });
    }
    
    let orders = [];
    
    if (!demoMode && pool) {
      // å¾è³‡æ–™åº«ç²å–è©²å¤–é€å“¡æ­£åœ¨é…é€çš„è¨‚å–®
      const query = `
        SELECT o.*, 
               c.name as customer_name, 
               c.phone as customer_phone,
               c.address,
               COALESCE(o.delivery_fee, 0) as delivery_fee,
               o.taken_at
        FROM orders o
        JOIN customers c ON o.customer_id = c.id
        WHERE o.driver_id = $1 
          AND o.status = 'delivering'
        ORDER BY o.taken_at ASC
      `;
      
      const result = await pool.query(query, [driverId]);
      orders = result.rows;
      
      // ç‚ºæ¯å€‹è¨‚å–®ç²å–å•†å“è©³æƒ…
      for (let order of orders) {
        const itemsQuery = `
          SELECT oi.*, p.name as product_name
          FROM order_items oi
          JOIN products p ON oi.product_id = p.id
          WHERE oi.order_id = $1
        `;
        const itemsResult = await pool.query(itemsQuery, [order.id]);
        order.items = itemsResult.rows;
        order.total = parseFloat(order.total_amount || 0);
      }
    }
    
    res.json({ success: true, orders });
  } catch (error) {
    console.error('ç²å–æˆ‘çš„é…é€è¨‚å–®å¤±æ•—:', error);
    res.status(500).json({ success: false, message: 'ç²å–è¨‚å–®å¤±æ•—' });
  }
});

// ğŸš› å¤–é€å“¡API - å·²å®Œæˆè¨‚å–®
app.get('/api/driver/completed-orders', async (req, res) => {
  try {
    const driverId = req.session.driverId;
    if (!driverId) {
      return res.status(401).json({ success: false, message: 'è«‹å…ˆç™»å…¥' });
    }
    
    let orders = [];
    
    if (!demoMode && pool) {
      // å¾è³‡æ–™åº«ç²å–è©²å¤–é€å“¡ä»Šæ—¥å·²å®Œæˆçš„è¨‚å–®
      const query = `
        SELECT o.*, 
               c.name as customer_name, 
               c.phone as customer_phone,
               c.address,
               COALESCE(o.delivery_fee, 50) as delivery_fee,
               o.completed_at
        FROM orders o
        JOIN customers c ON o.customer_id = c.id
        WHERE o.driver_id = $1 
          AND o.status = 'delivered'
          AND DATE(o.completed_at) = CURRENT_DATE
        ORDER BY o.completed_at DESC
      `;
      
      const result = await pool.query(query, [driverId]);
      orders = result.rows;
      
      // ç‚ºæ¯å€‹è¨‚å–®ç²å–å•†å“è©³æƒ…
      for (let order of orders) {
        const itemsQuery = `
          SELECT oi.*, p.name as product_name
          FROM order_items oi
          JOIN products p ON oi.product_id = p.id
          WHERE oi.order_id = $1
        `;
        const itemsResult = await pool.query(itemsQuery, [order.id]);
        order.items = itemsResult.rows;
        order.total = parseFloat(order.total_amount || 0);
      }
    }
    
    res.json({ success: true, orders });
  } catch (error) {
    console.error('ç²å–å·²å®Œæˆè¨‚å–®å¤±æ•—:', error);
    res.status(500).json({ success: false, message: 'ç²å–è¨‚å–®å¤±æ•—' });
  }
});

// ğŸš› å¤–é€å“¡API - çµ±è¨ˆæ•¸æ“š
app.get('/api/driver/stats', async (req, res) => {
  try {
    const driverId = req.session.driverId;
    if (!driverId) {
      return res.status(401).json({ success: false, message: 'è«‹å…ˆç™»å…¥' });
    }
    
    let todayEarnings = 0;
    let todayCompleted = 0;
    
    if (!demoMode && pool) {
      // è¨ˆç®—ä»Šæ—¥æ”¶å…¥å’Œå®Œæˆè¨‚å–®æ•¸
      const statsQuery = `
        SELECT 
          COUNT(*) as completed_count,
          COALESCE(SUM(delivery_fee), 0) as total_earnings
        FROM orders 
        WHERE driver_id = $1 
          AND status = 'delivered'
          AND DATE(completed_at) = CURRENT_DATE
      `;
      
      const result = await pool.query(statsQuery, [driverId]);
      if (result.rows.length > 0) {
        todayCompleted = parseInt(result.rows[0].completed_count || 0);
        todayEarnings = parseFloat(result.rows[0].total_earnings || 0);
      }
    }
    
    res.json({
      success: true,
      todayEarnings: todayEarnings,
      todayCompleted: todayCompleted
    });
  } catch (error) {
    console.error('ç²å–çµ±è¨ˆæ•¸æ“šå¤±æ•—:', error);
    res.status(500).json({ success: false, message: 'ç²å–çµ±è¨ˆå¤±æ•—' });
  }
});

// ğŸš› å¤–é€å“¡API - è¨‚å–®è©³æƒ…
app.get('/api/driver/order/:id', (req, res) => {
  const orderId = req.params.id;
  
  // æ¨¡æ“¬è¨‚å–®è©³æƒ…
  const order = {
    id: orderId,
    customer_name: 'ç‹å°æ˜',
    customer_phone: '0912-345-678',
    address: 'æ–°åŒ—å¸‚ä¸‰å³½å€ä¸­å±±è·¯123è™Ÿ',
    total: 185,
    subtotal: 185,
    delivery_fee: 0,
    payment_method: 'LINEPAY',
    created_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
    items: [
      { product_name: 'é«˜éº—èœ', quantity: 2, price: 45 },
      { product_name: 'è‘¡è„', quantity: 1, price: 95 }
    ]
  };
  
  res.json(order);
});

// ğŸš› å¤–é€å“¡API - æ¥å–è¨‚å–®
app.post('/api/driver/take-order/:id', async (req, res) => {
  const orderId = req.params.id;
  const driverId = req.session.driverId;
  
  if (!driverId) {
    return res.status(401).json({ success: false, message: 'è«‹å…ˆç™»å…¥' });
  }
  
  try {
    if (!demoMode && pool) {
      // æª¢æŸ¥è¨‚å–®æ˜¯å¦é‚„å¯ä»¥æ¥å–
      const checkQuery = `
        SELECT id, status, driver_id 
        FROM orders 
        WHERE id = $1 AND status = 'packed' AND driver_id IS NULL
      `;
      const checkResult = await pool.query(checkQuery, [orderId]);
      
      if (checkResult.rows.length === 0) {
        return res.status(400).json({ 
          success: false, 
          message: 'æ­¤è¨‚å–®å·²è¢«å…¶ä»–å¤–é€å“¡æ¥å–æˆ–ç‹€æ…‹å·²è®Šæ›´' 
        });
      }
      
      // æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚ºé…é€ä¸­ï¼Œä¸¦æŒ‡æ´¾çµ¦å¤–é€å“¡
      const updateQuery = `
        UPDATE orders 
        SET status = 'delivering', 
            driver_id = $1, 
            taken_at = CURRENT_TIMESTAMP,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = $2
      `;
      await pool.query(updateQuery, [driverId, orderId]);
      
      console.log(`âœ… å¤–é€å“¡ ${driverId} æˆåŠŸæ¥å–è¨‚å–® ${orderId}`);
    } else {
      console.log(`ğŸ“ Demoæ¨¡å¼: å¤–é€å“¡ ${driverId} æ¥å–äº†è¨‚å–® ${orderId}`);
    }
    
    res.json({ success: true, message: 'è¨‚å–®æ¥å–æˆåŠŸ' });
  } catch (error) {
    console.error('æ¥å–è¨‚å–®å¤±æ•—:', error);
    res.status(500).json({ success: false, message: 'æ¥å–è¨‚å–®å¤±æ•—ï¼Œè«‹é‡è©¦' });
  }
});

// ğŸš› å¤–é€å“¡API - å®Œæˆé…é€
app.post('/api/driver/complete-order/:id', async (req, res) => {
  const orderId = req.params.id;
  const driverId = req.session.driverId;
  
  if (!driverId) {
    return res.status(401).json({ success: false, message: 'è«‹å…ˆç™»å…¥' });
  }
  
  try {
    if (!demoMode && pool) {
      // æª¢æŸ¥è¨‚å–®æ˜¯å¦å±¬æ–¼è©²å¤–é€å“¡ä¸”æ­£åœ¨é…é€ä¸­
      const checkQuery = `
        SELECT id, status, driver_id, customer_id
        FROM orders 
        WHERE id = $1 AND driver_id = $2 AND status = 'delivering'
      `;
      const checkResult = await pool.query(checkQuery, [orderId, driverId]);
      
      if (checkResult.rows.length === 0) {
        return res.status(400).json({ 
          success: false, 
          message: 'æ­¤è¨‚å–®ä¸å­˜åœ¨æˆ–ä¸å±¬æ–¼æ‚¨ï¼Œæˆ–ç‹€æ…‹å·²è®Šæ›´' 
        });
      }
      
      // æ›´æ–°è¨‚å–®ç‹€æ…‹ç‚ºå·²å®Œæˆ
      const updateQuery = `
        UPDATE orders 
        SET status = 'delivered', 
            completed_at = CURRENT_TIMESTAMP,
            updated_at = CURRENT_TIMESTAMP
        WHERE id = $1
      `;
      await pool.query(updateQuery, [orderId]);
      
      // TODO: é€™è£¡å¯ä»¥ç™¼é€LINEé€šçŸ¥çµ¦å®¢æˆ¶
      const customerId = checkResult.rows[0].customer_id;
      console.log(`âœ… å¤–é€å“¡ ${driverId} å®Œæˆè¨‚å–® ${orderId}ï¼Œæ‡‰ç™¼é€é€šçŸ¥çµ¦å®¢æˆ¶ ${customerId}`);
      
    } else {
      console.log(`ğŸ“ Demoæ¨¡å¼: å¤–é€å“¡ ${driverId} å®Œæˆäº†è¨‚å–® ${orderId}`);
    }
    
    res.json({ success: true, message: 'é…é€å®Œæˆ' });
  } catch (error) {
    console.error('å®Œæˆé…é€å¤±æ•—:', error);
    res.status(500).json({ success: false, message: 'å®Œæˆé…é€å¤±æ•—ï¼Œè«‹é‡è©¦' });
  }
});

// ğŸš€ ç®¡ç†å¾Œå°è·¯ç”±
app.get('/admin/dashboard', ensureAdmin, async (req, res, next) => {
  console.log('ğŸ“Š ç®¡ç†å¾Œå°è¢«è¨ªå•');
  
  try {
    // æº–å‚™å„€è¡¨æ¿æ•¸æ“š
    const dashboardData = {
      stats: {
        todayRevenue: 12450,
        todayOrders: 47,
        todayCustomers: 38,
        avgOrderValue: 265
      },
      recentOrders: [],
      inventoryAlerts: [],
      deliveryStatus: {}
    };
    
    if (!demoMode) {
      // å¾è³‡æ–™åº«ç²å–çœŸå¯¦æ•¸æ“š
      try {
        const revenueQuery = await pool.query(`
          SELECT COALESCE(SUM(total_amount), 0) as today_revenue,
                 COUNT(*) as today_orders
          FROM orders 
          WHERE DATE(created_at) = CURRENT_DATE
        `);
        
        if (revenueQuery.rows.length > 0) {
          dashboardData.stats.todayRevenue = parseFloat(revenueQuery.rows[0].today_revenue || 0);
          dashboardData.stats.todayOrders = parseInt(revenueQuery.rows[0].today_orders || 0);
        }
      } catch (dbError) {
        console.warn('âš ï¸ ç„¡æ³•å¾è³‡æ–™åº«ç²å–æ•¸æ“šï¼Œä½¿ç”¨demoæ•¸æ“š:', dbError.message);
      }
    }
    
    res.render('admin_dashboard', { 
      title: 'èª æ„é®®è”¬ - ç®¡ç†å¾Œå°',
      dashboardData: dashboardData,
      user: {
        name: 'é»ƒå£«å˜‰',
        role: 'ç³»çµ±ç®¡ç†å“¡'
      },
      googleMapsApiKey: process.env.GOOGLE_MAPS_API_KEY
    });
  } catch (error) {
    console.error('âŒ ç®¡ç†å¾Œå°è¼‰å…¥éŒ¯èª¤:', error);
    next(error);
  }
});

// å‰å°ï¼šçµå¸³é 
app.get('/checkout', (req, res) => {
  res.render('checkout');
});

// APIï¼šæäº¤è¨‚å–®
app.post('/api/orders', orderLimiter, sanitizeInput, validateOrderData, asyncWrapper(async (req, res) => {
  const { name, phone, address, notes, invoice, items } = req.body;
  try {
    if (!name || !phone || !address || !Array.isArray(items) || items.length === 0) {
      return res.status(400).json({ success: false, message: 'åƒæ•¸ä¸å®Œæ•´' });
    }
    
    // ç¤ºç¯„æ¨¡å¼è™•ç†
    if (demoMode) {
      console.log('ğŸ“‹ ç¤ºç¯„æ¨¡å¼ï¼šæ¨¡æ“¬è¨‚å–®å»ºç«‹');
      const mockOrderId = Math.floor(Math.random() * 9000) + 1000;
      
      // è¨ˆç®—æ¨¡æ“¬è¨‚å–®é‡‘é¡
      let subtotal = 0;
      for (const it of items) {
        const { productId, quantity } = it;
        const product = demoProducts.find(p => p.id == productId);
        if (product && !product.is_priced_item) {
          subtotal += Number(product.price) * Number(quantity);
        }
      }
      
      const deliveryFee = subtotal >= 200 ? 0 : 50;
      const total = subtotal + deliveryFee;
      
      return res.json({ 
        success: true, 
        orderId: mockOrderId,
        message: 'âœ¨ ç¤ºç¯„æ¨¡å¼ï¼šè¨‚å–®å·²æ¨¡æ“¬å»ºç«‹ï¼å¯¦éš›éƒ¨ç½²å¾Œå°‡é€£æ¥çœŸå¯¦è³‡æ–™åº«',
        data: {
          orderId: mockOrderId,
          total,
          estimatedDelivery: '2-3å°æ™‚å…§ï¼ˆç¤ºç¯„æ¨¡å¼ï¼‰'
        }
      });
    }
    
    // æ­£å¸¸è³‡æ–™åº«æ¨¡å¼
    let subtotal = 0;
    const orderItems = [];
    for (const it of items) {
      const { productId, quantity } = it;
      const { rows } = await pool.query('SELECT * FROM products WHERE id=$1', [productId]);
      if (rows.length === 0) {
        continue;
      }
      const p = rows[0];
      let lineTotal = 0;
      if (!p.is_priced_item) {
        lineTotal = Number(p.price) * Number(quantity);
        subtotal += lineTotal;
      }
      orderItems.push({
        product_id: p.id,
        name: p.name,
        is_priced_item: p.is_priced_item,
        quantity: Number(quantity),
        unit_price: p.price,
        line_total: lineTotal,
        actual_weight: null
      });
    }
    const deliveryFee = subtotal >= 200 ? 0 : 50;
    const total = subtotal + deliveryFee;
    // é€²è¡Œåœ°ç†ç·¨ç¢¼
    const geo = await geocodeAddress(address);
    // å»ºç«‹è¨‚å–®ï¼Œå„²å­˜åº§æ¨™èˆ‡åœ°ç†ç‹€æ…‹
    const insertOrder = await pool.query(
      'INSERT INTO orders (contact_name, contact_phone, address, notes, invoice, subtotal, delivery_fee, total_amount, status, lat, lng, geocoded_at, geocode_status) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,NOW(),$12) RETURNING id',
      [name, phone, address, notes || '', invoice || '', subtotal, deliveryFee, total, 'placed', geo.lat, geo.lng, geo.status]
    );
    const orderId = insertOrder.rows[0].id;
    // æ’å…¥å“é …
    for (const item of orderItems) {
      await pool.query(
        'INSERT INTO order_items (order_id, product_id, name, is_priced_item, quantity, unit_price, line_total, actual_weight) VALUES ($1,$2,$3,$4,$5,$6,$7,$8)',
        [orderId, item.product_id, item.name, item.is_priced_item, item.quantity, item.unit_price, item.line_total, item.actual_weight]
      );
    }
    // è‹¥å·²ç¶å®š LINEï¼Œå°‡ç”¨æˆ¶è³‡æ–™å¯«å…¥ users è¡¨
    if (req.session.line && req.session.line.userId) {
      await upsertUser(phone, name, req.session.line.userId, req.session.line.displayName);
    } else {
      await upsertUser(phone, name, null, null);
    }
    res.json({ 
      success: true, 
      orderId,
      message: 'è¨‚å–®å·²æˆåŠŸå»ºç«‹',
      data: {
        orderId,
        total,
        estimatedDelivery: '2-3å°æ™‚å…§'
      }
    });
  } catch (err) {
    console.error('Create order error:', err);
    res.status(500).json({ 
      success: false, 
      message: 'å»ºç«‹è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦' 
    });
  }
}));

// APIï¼šå–å¾—æ‰€æœ‰ç”¢å“ï¼ˆä¾›å‰ç«¯ checkout é‡æ–°è¨ˆç®—å°è¨ˆï¼‰
app.get('/api/products', asyncWrapper(async (req, res) => {
  try {
    let products;
    
    if (demoMode) {
      console.log('ğŸ“¦ APIï¼šä½¿ç”¨ç¤ºç¯„ç”¢å“è³‡æ–™');
      products = demoProducts;
    } else {
      const { rows } = await pool.query('SELECT * FROM products ORDER BY id');
      products = rows;
    }
    
    res.json({ 
      success: true,
      products,
      count: products.length,
      mode: demoMode ? 'demo' : 'database'
    });
  } catch (error) {
    console.log('âŒ APIç”¢å“æŸ¥è©¢å¤±æ•—ï¼Œä½¿ç”¨ç¤ºç¯„è³‡æ–™');
    res.json({ 
      success: true,
      products: demoProducts,
      count: demoProducts.length,
      mode: 'demo'
    });
  }
}));
// å‰å°ï¼šè¨‚å–®æˆåŠŸé ï¼ˆä¾›å¤–éƒ¨é€£çµä½¿ç”¨ï¼‰
app.get('/order-success', async (req, res) => {
  const id = parseInt(req.query.id, 10);
  if (!id) return res.status(400).send('è¨‚å–®ä¸å­˜åœ¨');
  
  if (demoMode) {
    // ç¤ºç¯„æ¨¡å¼ï¼šé¡¯ç¤ºæ¨¡æ“¬è¨‚å–®æˆåŠŸé 
    const mockOrder = {
      id: id,
      contact_name: 'ç¤ºç¯„ç”¨æˆ¶',
      total: 200,
      status: 'placed',
      created_at: new Date()
    };
    return res.render('order_success', { order: mockOrder });
  }
  
  try {
    const { rows: orders } = await pool.query('SELECT * FROM orders WHERE id=$1', [id]);
    if (orders.length === 0) return res.status(404).send('è¨‚å–®ä¸å­˜åœ¨');
    const order = orders[0];
    res.render('order_success', { order });
  } catch (err) {
    console.error('Order success error:', err);
    res.status(500).send('éŒ¯èª¤');
  }
});

// ç®¡ç†å¾Œå°æ ¹è·¯å¾‘é‡å®šå‘
app.get('/admin', (req, res) => {
  if (req.session && req.session.isAdmin) {
    res.redirect('/admin/dashboard');
  } else {
    res.redirect('/admin/login');
  }
});

// ç™»å…¥é 
app.get('/admin/login', (req, res) => {
  res.render('admin_login', { error: null });
});

// è™•ç†ç™»å…¥
app.post('/admin/login', validateAdminPassword, (req, res) => {
  const { password } = req.body;
  const adminPassword = process.env.ADMIN_PASSWORD || 'shnf830629';
  
  console.log('ç™»å…¥å˜—è©¦ - è¼¸å…¥å¯†ç¢¼:', password);
  console.log('æœŸæœ›å¯†ç¢¼:', adminPassword);
  
  if (password === adminPassword) {
    req.session.isAdmin = true;
    req.session.loginTime = new Date();
    console.log('ç™»å…¥æˆåŠŸï¼Œé‡å°å‘åˆ° dashboard');
    return res.redirect('/admin/dashboard');
  }
  
  console.log('å¯†ç¢¼éŒ¯èª¤');
  res.render('admin_login', { error: 'å¯†ç¢¼éŒ¯èª¤' });
});

// ç™»å‡º
app.get('/admin/logout', (req, res) => {
  req.session.isAdmin = false;
  req.session.destroy(() => {
    res.redirect('/admin/login');
  });
});

// ç®¡ç†å“¡é©—è­‰ä¸­ä»‹
function ensureAdmin(req, res, next) {
  if (req.session && req.session.isAdmin) {
    return next();
  }
  return res.redirect('/admin/login');
}

// ---------------- LINE ç™»å…¥èˆ‡ç¶å®š ----------------
// ç”¢ç”Ÿç™»å…¥ URL
app.get('/auth/line/login', (req, res) => {
  const clientId = process.env.LINE_CHANNEL_ID;
  const redirectUri = process.env.LINE_REDIRECT_URI;
  if (!clientId || !redirectUri) {
    return res.status(500).send('LINE è¨­å®šå°šæœªå®Œæˆ');
  }
  // ç”Ÿæˆäº‚æ•¸ state é˜²æ­¢ CSRF
  const state = Math.random().toString(36).substring(2);
  req.session.lineState = state;
  const scope = 'profile';
  const authUrl =
    'https://access.line.me/oauth2/v2.1/authorize' +
    '?response_type=code' +
    '&client_id=' + encodeURIComponent(clientId) +
    '&redirect_uri=' + encodeURIComponent(redirectUri) +
    '&state=' + encodeURIComponent(state) +
    '&scope=' + encodeURIComponent(scope);
  res.redirect(authUrl);
});

// LINE ç™»å…¥å›å‘¼
app.get('/auth/line/callback', async (req, res) => {
  const { code, state } = req.query;
  const sessionState = req.session.lineState;
  // æª¢æŸ¥ state
  if (!state || !sessionState || state !== sessionState) {
    return res.status(400).send('ç‹€æ…‹é©—è­‰å¤±æ•—');
  }
  // ç§»é™¤ç‹€æ…‹
  delete req.session.lineState;
  try {
    const clientId = process.env.LINE_CHANNEL_ID;
    const clientSecret = process.env.LINE_CHANNEL_SECRET;
    const redirectUri = process.env.LINE_REDIRECT_URI;
    // äº¤æ› token
    const tokenRes = await fetch('https://api.line.me/oauth2/v2.1/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        grant_type: 'authorization_code',
        code: code,
        redirect_uri: redirectUri,
        client_id: clientId,
        client_secret: clientSecret
      })
    });
    const tokenData = await tokenRes.json();
    if (!tokenData.access_token) {
      console.error('LINE token error:', tokenData);
      return res.status(400).send('LINE ç™»å…¥å¤±æ•—');
    }
    // å–å¾—ä½¿ç”¨è€…è³‡æ–™
    const profileRes = await fetch('https://api.line.me/v2/profile', {
      headers: { Authorization: 'Bearer ' + tokenData.access_token }
    });
    const profile = await profileRes.json();
    if (!profile.userId) {
      console.error('LINE profile error:', profile);
      return res.status(400).send('ç„¡æ³•å–å¾— LINE ä½¿ç”¨è€…è³‡æ–™');
    }
    // å°‡è³‡æ–™å­˜å…¥ session
    req.session.line = {
      userId: profile.userId,
      displayName: profile.displayName
    };
    res.redirect('/line-connected');
  } catch (err) {
    console.error('LINE login callback error:', err);
    res.status(500).send('LINE ç™»å…¥ç™¼ç”ŸéŒ¯èª¤');
  }
});

// ç¶å®šæˆåŠŸé é¢
app.get('/line-connected', (req, res) => {
  res.render('line_connected', {
    line: req.session.line
  });
});

// ---------------- Google Maps & åœ°åœ– API ----------------
// ç®¡ç†å“¡åœ°åœ–é 
app.get('/admin/map', ensureAdmin, (req, res) => {
  // è®“å‰ç«¯å–å¾— API é‡‘é‘°
  res.render('admin_map', {
    googleMapsApiKey: process.env.GOOGLE_MAPS_API_KEY
  });
});

// è¿”å›å«åº§æ¨™çš„è¨‚å–®æ¸…å–®
app.get('/api/admin/orders-geo', ensureAdmin, async (req, res) => {
  if (demoMode) {
    res.json({ orders: [] });
    return;
  }
  
  try {
    const { rows: orders } = await pool.query('SELECT id, contact_name, contact_phone, address, status, total_amount as total, lat, lng FROM orders WHERE lat IS NOT NULL AND lng IS NOT NULL');
    res.json({ orders });
  } catch (err) {
    console.error(err);
    res.status(500).json({ orders: [] });
  }
});

// å¾Œå°ï¼šè¨‚å–®åˆ—è¡¨
app.get('/admin/orders', ensureAdmin, async (req, res, next) => {
  if (demoMode) {
    const mockOrders = [
      {
        id: 1001,
        contact_name: 'ç¤ºç¯„å®¢æˆ¶',
        contact_phone: '0912345678',
        address: 'å°åŒ—å¸‚å¤§å®‰å€ç¤ºç¯„è·¯123è™Ÿ',
        total: 280,
        status: 'placed',
        created_at: new Date()
      }
    ];
    return res.render('admin_orders', { orders: mockOrders });
  }
  
  try {
    const { rows: orders } = await pool.query('SELECT * FROM orders ORDER BY id DESC');
    res.render('admin_orders', { orders });
  } catch (err) {
    next(err);
  }
});

// å¾Œå°ï¼šå–®ä¸€è¨‚å–®ç·¨è¼¯
app.get('/admin/orders/:id', ensureAdmin, async (req, res, next) => {
  const id = parseInt(req.params.id, 10);
  try {
    const { rows: orders } = await pool.query('SELECT * FROM orders WHERE id=$1', [id]);
    if (orders.length === 0) return res.status(404).send('è¨‚å–®ä¸å­˜åœ¨');
    const order = orders[0];
    const { rows: items } = await pool.query('SELECT * FROM order_items WHERE order_id=$1 ORDER BY id', [id]);
    order.items = items;
    res.render('admin_order_edit', { order });
  } catch (err) {
    next(err);
  }
});

// å¾Œå°ï¼šæ›´æ–°è¨‚å–®
app.post('/admin/orders/:id', ensureAdmin, async (req, res, next) => {
  const id = parseInt(req.params.id, 10);
  try {
    const ordersData = await pool.query('SELECT * FROM orders WHERE id=$1', [id]);
    if (ordersData.rows.length === 0) return res.status(404).send('è¨‚å–®ä¸å­˜åœ¨');
    const order = ordersData.rows[0];
    // æŠ“å–è¨‚å–®é …ç›®
    const { rows: items } = await pool.query('SELECT * FROM order_items WHERE order_id=$1 ORDER BY id', [id]);
    let lineTotals = req.body.lineTotal;
    let actualWeights = req.body.actualWeight;
    if (!Array.isArray(lineTotals)) lineTotals = [lineTotals];
    if (!Array.isArray(actualWeights)) actualWeights = [actualWeights];
    // æ›´æ–°æ¯ä¸€é …ç›®
    for (let i = 0; i < items.length; i++) {
      const item = items[i];
      let lineTotal = parseFloat(lineTotals[i]);
      if (isNaN(lineTotal)) lineTotal = 0;
      let actualWeight = parseFloat(actualWeights[i]);
      if (isNaN(actualWeight)) actualWeight = null;
      if (item.is_priced_item) {
        await pool.query(
          'UPDATE order_items SET line_total=$1, actual_weight=$2 WHERE id=$3',
          [lineTotal, actualWeight, item.id]
        );
      } else {
        // ç¢ºä¿å›ºå®šåƒ¹ç¶­æŒåŸé‡‘é¡
        const fixedTotal = Number(item.unit_price) * Number(item.quantity);
        await pool.query(
          'UPDATE order_items SET line_total=$1, actual_weight=NULL WHERE id=$2',
          [fixedTotal, item.id]
        );
      }
    }
    // é‡æ–°è¨ˆç®— totals
    const { rows: updatedItems } = await pool.query('SELECT * FROM order_items WHERE order_id=$1', [id]);
    let newSubtotal = 0;
    updatedItems.forEach(it => {
      newSubtotal += Number(it.line_total || 0);
    });
    const newDelivery = newSubtotal >= 200 ? 0 : 50;
    const newTotal = newSubtotal + newDelivery;
    await pool.query('UPDATE orders SET subtotal=$1, delivery_fee=$2, total=$3, status=$4 WHERE id=$5', [newSubtotal, newDelivery, newTotal, 'quoted', id]);
    res.redirect('/admin/orders/' + id);
  } catch (err) {
    next(err);
  }
});

// å¾Œå°ï¼šç”¢å“ç®¡ç†åˆ—è¡¨
app.get('/admin/products', ensureAdmin, async (req, res, next) => {
  if (demoMode) {
    return res.render('admin_products', { products: demoProducts });
  }
  
  try {
    const { rows: products } = await pool.query('SELECT * FROM products ORDER BY id');
    res.render('admin_products', { products });
  } catch (err) {
    next(err);
  }
});

// å¾Œå°ï¼šæ›´æ–°æŸç”¢å“
app.post('/admin/products/:id/update', ensureAdmin, async (req, res, next) => {
  const id = parseInt(req.params.id, 10);
  const { price, isPricedItem, unitHint } = req.body;
  try {
    const priceVal = price === '' || price === null ? null : parseFloat(price);
    const priced = isPricedItem === 'on' || isPricedItem === 'true';
    await pool.query(
      'UPDATE products SET price=$1, is_priced_item=$2, unit_hint=$3 WHERE id=$4',
      [priceVal, priced, unitHint || null, id]
    );
    res.redirect('/admin/products');
  } catch (err) {
    next(err);
  }
});

// å¾Œå°ï¼šæ–°å¢ç”¢å“è¡¨å–®
app.get('/admin/products/new', ensureAdmin, (req, res) => {
  res.render('admin_product_new');
});

// å¾Œå°ï¼šæ–°å¢ç”¢å“
app.post('/admin/products/new', ensureAdmin, async (req, res, next) => {
  const { name, price, isPricedItem, unitHint, initialStock, minStockAlert, supplierName } = req.body;
  
  if (demoMode) {
    console.log('ğŸ“ ç¤ºç¯„æ¨¡å¼ï¼šæ¨¡æ“¬æ–°å¢å•†å“', { name, price });
    return res.redirect('/admin/products');
  }
  
  try {
    if (!name) {
      return res.render('admin_product_new', { error: 'å“åå¿…å¡«' });
    }
    
    const priceVal = price === '' || price === null ? null : parseFloat(price);
    const priced = isPricedItem === 'on' || isPricedItem === 'true';
    
    // é–‹å§‹äº¤æ˜“
    await pool.query('BEGIN');
    
    try {
      // æ–°å¢å•†å“
      const productResult = await pool.query(
        'INSERT INTO products (name, price, is_priced_item, unit_hint) VALUES ($1,$2,$3,$4) RETURNING id',
        [name, priceVal, priced, unitHint || null]
      );
      
      const productId = productResult.rows[0].id;
      
      // è‡ªå‹•å‰µå»ºåº«å­˜è¨˜éŒ„
      const stockVal = parseInt(initialStock) || 0;
      const minAlertVal = parseInt(minStockAlert) || 10;
      const unitCostVal = priceVal ? parseFloat(priceVal) * 0.7 : 0; // å‡è¨­æˆæœ¬æ˜¯å”®åƒ¹çš„70%
      
      await pool.query(
        'INSERT INTO inventory (product_id, current_stock, min_stock_alert, max_stock_capacity, unit_cost, supplier_name) VALUES ($1,$2,$3,$4,$5,$6)',
        [productId, stockVal, minAlertVal, 1000, unitCostVal, supplierName || null]
      );
      
      // è¨˜éŒ„åˆå§‹åº«å­˜
      if (stockVal > 0) {
        await pool.query(
          'INSERT INTO stock_movements (product_id, movement_type, quantity, unit_cost, reason, operator_name) VALUES ($1,$2,$3,$4,$5,$6)',
          [productId, 'in', stockVal, unitCostVal, 'æ–°å•†å“åˆå§‹åº«å­˜', 'ç®¡ç†å“¡']
        );
      }
      
      // æäº¤äº¤æ˜“
      await pool.query('COMMIT');
      console.log(`âœ… æˆåŠŸæ–°å¢å•†å“ï¼š${name}ï¼Œåˆå§‹åº«å­˜ï¼š${stockVal}`);
      
      res.redirect('/admin/products');
    } catch (error) {
      // å›æ»¾äº¤æ˜“
      await pool.query('ROLLBACK');
      throw error;
    }
  } catch (err) {
    console.error('æ–°å¢å•†å“éŒ¯èª¤:', err);
    res.render('admin_product_new', { 
      error: 'æ–°å¢å•†å“å¤±æ•—ï¼š' + err.message,
      formData: req.body 
    });
  }
});

// ğŸ“‹ å¾Œå°ï¼šåº«å­˜ç®¡ç†é é¢
app.get('/admin/inventory', ensureAdmin, async (req, res, next) => {
  try {
    let inventoryData = [];
    
    if (!demoMode && pool) {
      // å¾è³‡æ–™åº«ç²å–åº«å­˜è³‡æ–™
      const query = `
        SELECT 
          p.id,
          p.name,
          p.price,
          p.unit_hint,
          COALESCE(i.current_stock, 0) as current_stock,
          COALESCE(i.min_stock_alert, 10) as min_stock_alert,
          COALESCE(i.max_stock_capacity, 1000) as max_stock_capacity,
          COALESCE(i.unit_cost, 0) as unit_cost,
          i.supplier_name,
          i.last_updated
        FROM products p
        LEFT JOIN inventory i ON p.id = i.product_id
        ORDER BY p.name
      `;
      const result = await pool.query(query);
      inventoryData = result.rows;
    } else {
      // Demoæ¨¡å¼æ•¸æ“š
      inventoryData = [
        { id: 1, name: 'ğŸ¥¬ æœ‰æ©Ÿé«˜éº—èœ', current_stock: 45, min_stock_alert: 10, unit_cost: 25.00, supplier_name: 'æ–°é®®è¾²å ´' },
        { id: 2, name: 'ğŸ… æ–°é®®ç•ªèŒ„', current_stock: 8, min_stock_alert: 15, unit_cost: 18.00, supplier_name: 'é™½å…‰æœåœ’' },
        { id: 3, name: 'ğŸ¥¬ é’æ±Ÿèœ', current_stock: 23, min_stock_alert: 10, unit_cost: 12.00, supplier_name: 'ç¶ é‡è¾²å ´' }
      ];
    }
    
    res.render('admin_inventory', { 
      inventoryData,
      title: 'åº«å­˜ç®¡ç†',
      lowStockCount: inventoryData.filter(item => item.current_stock <= item.min_stock_alert).length
    });
  } catch (err) {
    console.error('åº«å­˜ç®¡ç†é é¢éŒ¯èª¤:', err);
    next(err);
  }
});

// ğŸ“‹ APIï¼šæ›´æ–°åº«å­˜
app.post('/api/admin/inventory/update', ensureAdmin, async (req, res) => {
  try {
    const { productId, currentStock, minStockAlert, maxStockCapacity, unitCost, supplierName } = req.body;
    
    if (!demoMode && pool) {
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰åº«å­˜è¨˜éŒ„
      const existingQuery = 'SELECT id FROM inventory WHERE product_id = $1';
      const existingResult = await pool.query(existingQuery, [productId]);
      
      if (existingResult.rows.length > 0) {
        // æ›´æ–°ç¾æœ‰è¨˜éŒ„
        await pool.query(`
          UPDATE inventory 
          SET current_stock = $1, min_stock_alert = $2, max_stock_capacity = $3, 
              unit_cost = $4, supplier_name = $5, last_updated = CURRENT_TIMESTAMP
          WHERE product_id = $6
        `, [currentStock, minStockAlert, maxStockCapacity, unitCost, supplierName, productId]);
      } else {
        // æ–°å¢åº«å­˜è¨˜éŒ„
        await pool.query(`
          INSERT INTO inventory (product_id, current_stock, min_stock_alert, max_stock_capacity, unit_cost, supplier_name)
          VALUES ($1, $2, $3, $4, $5, $6)
        `, [productId, currentStock, minStockAlert, maxStockCapacity, unitCost, supplierName]);
      }
      
      // è¨˜éŒ„åº«å­˜ç•°å‹•
      await pool.query(`
        INSERT INTO stock_movements (product_id, movement_type, quantity, unit_cost, reason, operator_name)
        VALUES ($1, 'adjustment', $2, $3, 'åº«å­˜èª¿æ•´', 'ç®¡ç†å“¡')
      `, [productId, currentStock, unitCost]);
    }
    
    res.json({ success: true, message: 'åº«å­˜æ›´æ–°æˆåŠŸ' });
  } catch (err) {
    console.error('æ›´æ–°åº«å­˜éŒ¯èª¤:', err);
    res.status(500).json({ success: false, message: 'æ›´æ–°å¤±æ•—' });
  }
});

// ğŸ“‹ APIï¼šé€²è²¨æ“ä½œ
app.post('/api/admin/inventory/restock', ensureAdmin, async (req, res) => {
  try {
    const { productId, quantity, unitCost, supplierName, reason } = req.body;
    
    if (!demoMode && pool) {
      // æ›´æ–°åº«å­˜æ•¸é‡
      await pool.query(`
        UPDATE inventory 
        SET current_stock = current_stock + $1, unit_cost = $2, supplier_name = $3, last_updated = CURRENT_TIMESTAMP
        WHERE product_id = $4
      `, [quantity, unitCost, supplierName, productId]);
      
      // è¨˜éŒ„é€²è²¨
      await pool.query(`
        INSERT INTO stock_movements (product_id, movement_type, quantity, unit_cost, reason, operator_name)
        VALUES ($1, 'in', $2, $3, $4, 'ç®¡ç†å“¡')
      `, [productId, quantity, unitCost, reason || 'é€²è²¨è£œå……']);
    }
    
    res.json({ success: true, message: 'é€²è²¨è¨˜éŒ„æˆåŠŸ' });
  } catch (err) {
    console.error('é€²è²¨æ“ä½œéŒ¯èª¤:', err);
    res.status(500).json({ success: false, message: 'é€²è²¨å¤±æ•—' });
  }
});

// ğŸ“ˆ å¾Œå°ï¼šçµ±è¨ˆå ±è¡¨é é¢
app.get('/admin/reports', ensureAdmin, async (req, res, next) => {
  try {
    // æº–å‚™å ±è¡¨æ•¸æ“š
    const reportData = {
      revenue: {
        total: 287650,
        growth: 8.3,
        orders: 1247,
        avgOrderValue: 231
      },
      products: [],
      customers: {
        total: 1456,
        returnRate: 68,
        newCustomers: 234
      },
      delivery: {
        avgTime: 42,
        onTimeRate: 94.2,
        cost: 12450
      }
    };
    
    if (!demoMode && pool) {
      try {
        // å¾è³‡æ–™åº«ç²å–çœŸå¯¦çµ±è¨ˆæ•¸æ“š
        const revenueQuery = await pool.query(`
          SELECT 
            DATE(created_at) as date,
            COUNT(*) as orders,
            SUM(total_amount) as revenue
          FROM orders 
          WHERE created_at >= CURRENT_DATE - INTERVAL '30 days'
          GROUP BY DATE(created_at)
          ORDER BY date
        `);
        
        const productQuery = await pool.query(`
          SELECT 
            p.name,
            COUNT(oi.id) as sales_count,
            SUM(oi.line_total) as sales_revenue
          FROM products p
          LEFT JOIN order_items oi ON p.id = oi.product_id
          LEFT JOIN orders o ON oi.order_id = o.id
          WHERE o.created_at >= CURRENT_DATE - INTERVAL '30 days'
          GROUP BY p.id, p.name
          ORDER BY sales_revenue DESC
          LIMIT 10
        `);
        
        reportData.revenueData = revenueQuery.rows;
        reportData.productData = productQuery.rows;
      } catch (dbError) {
        console.warn('âš ï¸ ç„¡æ³•å¾è³‡æ–™åº«ç²å–å ±è¡¨æ•¸æ“šï¼Œä½¿ç”¨demoæ•¸æ“š:', dbError.message);
      }
    }
    
    res.render('admin_reports', { 
      title: 'çµ±è¨ˆå ±è¡¨åˆ†æ',
      reportData: reportData
    });
  } catch (err) {
    console.error('âŒ çµ±è¨ˆå ±è¡¨é é¢éŒ¯èª¤:', err);
    next(err);
  }
});

// ğŸ“ˆ APIï¼šç²å–å ±è¡¨æ•¸æ“š
app.get('/api/admin/reports/:type', ensureAdmin, async (req, res) => {
  try {
    const { type } = req.params;
    const { timeRange = '30', startDate, endDate } = req.query;
    
    let data = {};
    
    if (!demoMode && pool) {
      const days = parseInt(timeRange);
      const whereClause = startDate && endDate 
        ? `created_at BETWEEN '${startDate}' AND '${endDate}'`
        : `created_at >= CURRENT_DATE - INTERVAL '${days} days'`;
      
      switch (type) {
        case 'revenue':
          const revenueResult = await pool.query(`
            SELECT 
              DATE(created_at) as date,
              COUNT(*) as orders,
              SUM(total_amount) as revenue,
              AVG(total_amount) as avg_order_value
            FROM orders 
            WHERE ${whereClause}
            GROUP BY DATE(created_at)
            ORDER BY date
          `);
          data = revenueResult.rows;
          break;
          
        case 'products':
          const productsResult = await pool.query(`
            SELECT 
              p.name,
              COUNT(oi.id) as sales_count,
              SUM(oi.line_total) as sales_revenue,
              AVG(oi.line_total) as avg_price
            FROM products p
            LEFT JOIN order_items oi ON p.id = oi.product_id
            LEFT JOIN orders o ON oi.order_id = o.id
            WHERE o.${whereClause}
            GROUP BY p.id, p.name
            ORDER BY sales_revenue DESC
          `);
          data = productsResult.rows;
          break;
          
        case 'customers':
          const customersResult = await pool.query(`
            SELECT 
              contact_name,
              contact_phone,
              COUNT(*) as order_count,
              SUM(total_amount) as total_spent,
              MAX(created_at) as last_order
            FROM orders 
            WHERE ${whereClause}
            GROUP BY contact_name, contact_phone
            ORDER BY total_spent DESC
          `);
          data = customersResult.rows;
          break;
          
        default:
          // Demoæ•¸æ“š
          data = generateDemoData(type, days);
      }
    } else {
      // Demoæ¨¡å¼
      data = generateDemoData(type, parseInt(timeRange));
    }
    
    res.json({ success: true, data });
  } catch (err) {
    console.error('å ±è¡¨æ•¸æ“šAPIéŒ¯èª¤:', err);
    res.status(500).json({ success: false, message: 'ç²å–å ±è¡¨æ•¸æ“šå¤±æ•—' });
  }
});

// ç”Ÿæˆç¤ºç¯„æ•¸æ“š
function generateDemoData(type, days) {
  const data = [];
  const today = new Date();
  
  for (let i = days - 1; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    
    switch (type) {
      case 'revenue':
        data.push({
          date: date.toISOString().split('T')[0],
          orders: Math.floor(Math.random() * 50) + 20,
          revenue: Math.floor(Math.random() * 15000) + 5000,
          avg_order_value: Math.floor(Math.random() * 100) + 180
        });
        break;
        
      case 'products':
        const products = ['ğŸ¥¬ é«˜éº—èœ', 'ğŸ‡ è‘¡è„', 'ğŸ¥¬ å¤§ç™½èœ', 'ğŸ… ç•ªèŒ„', 'ğŸ¥• èƒ¡è˜¿è””'];
        products.forEach((name, index) => {
          data.push({
            name,
            sales_count: Math.floor(Math.random() * 200) + 100,
            sales_revenue: Math.floor(Math.random() * 20000) + 10000,
            avg_price: Math.floor(Math.random() * 50) + 20
          });
        });
        break;
    }
  }
  
  return data;
}

// ğŸ•°ï¸ å¾Œå°ï¼šç‡Ÿæ¥­æ™‚é–“ç®¡ç†é é¢
app.get('/admin/business-hours', ensureAdmin, (req, res) => {
  res.render('admin_business_hours');
});

// ğŸ•°ï¸ å¾Œå°ï¼šæ›´æ–°ç‡Ÿæ¥­æ™‚é–“
app.post('/admin/business-hours', ensureAdmin, async (req, res, next) => {
  try {
    const businessHours = req.body;
    console.log('ğŸ“ ç‡Ÿæ¥­æ™‚é–“è¨­å®šå·²æ›´æ–°:', businessHours);
    res.json({ success: true, message: 'ç‡Ÿæ¥­æ™‚é–“è¨­å®šå·²å„²å­˜' });
  } catch (err) {
    console.error('âŒ ç‡Ÿæ¥­æ™‚é–“æ›´æ–°å¤±æ•—:', err);
    res.status(500).json({ success: false, message: 'å„²å­˜å¤±æ•—' });
  }
});

// ğŸ•°ï¸ APIï¼šå–å¾—ç‡Ÿæ¥­æ™‚é–“è³‡æ–™
app.get('/api/business-hours', (req, res) => {
  try {
    const defaultHours = {
      monday: { open: '06:00', close: '13:00', closed: false },
      tuesday: { open: '06:00', close: '13:00', closed: false },
      wednesday: { open: '06:00', close: '13:00', closed: false },
      thursday: { open: '06:00', close: '13:00', closed: false },
      friday: { open: '06:00', close: '13:00', closed: false },
      saturday: { open: '06:00', close: '13:00', closed: false },
      sunday: { open: '06:00', close: '13:00', closed: true }
    };
    res.json(defaultHours);
  } catch (err) {
    console.error('âŒ å–å¾—ç‡Ÿæ¥­æ™‚é–“å¤±æ•—:', err);
    res.status(500).json({ error: 'å–å¾—ç‡Ÿæ¥­æ™‚é–“å¤±æ•—' });
  }
});

// ğŸ¤– Agent ç³»çµ±ç®¡ç† API
app.get('/api/admin/agents/status', ensureAdmin, (req, res) => {
  try {
    const status = agentSystem ? agentSystem.getSystemStatus() : { status: 'not_initialized' };
    res.json({ success: true, ...status });
  } catch (error) {
    res.status(500).json({ success: false, message: error.message });
  }
});

app.post('/api/admin/agents/restart/:agentName', ensureAdmin, async (req, res) => {
  try {
    const { agentName } = req.params;
    
    if (!agentSystem) {
      return res.status(400).json({ success: false, message: 'Agent ç³»çµ±æœªåˆå§‹åŒ–' });
    }

    await agentSystem.restartAgent(agentName);
    res.json({ success: true, message: `${agentName} é‡å•ŸæˆåŠŸ` });
  } catch (error) {
    res.status(500).json({ success: false, message: error.message });
  }
});

app.post('/api/admin/agents/health-check', ensureAdmin, async (req, res) => {
  try {
    const healthReport = agentSystem ? await agentSystem.healthCheck() : { systemHealthy: false };
    res.json({ success: true, health: healthReport });
  } catch (error) {
    res.status(500).json({ success: false, message: error.message });
  }
});

// ğŸ¤– ä½¿ç”¨ Agent ç³»çµ±çš„ API ç«¯é»
app.post('/api/orders-agent', orderLimiter, sanitizeInput, validateOrderData, asyncWrapper(async (req, res) => {
  const { name, phone, address, notes, invoice, items } = req.body;
  
  try {
    if (!agentSystem) {
      // é™ç´šåˆ°åŸæœ‰é‚è¼¯
      return res.status(503).json({ 
        success: false, 
        message: 'Agent ç³»çµ±æœªå•Ÿå‹•ï¼Œè«‹ç¨å¾Œå†è©¦' 
      });
    }

    // ä½¿ç”¨ OrderAgent å»ºç«‹è¨‚å–®
    const result = await agentSystem.executeTask('OrderAgent', 'create_order', {
      name, phone, address, notes, invoice, items
    });

    res.json({ 
      success: true, 
      ...result,
      message: 'è¨‚å–®å·²é€é Agent ç³»çµ±å»ºç«‹'
    });
    
  } catch (error) {
    console.error('Agent ç³»çµ±å»ºç«‹è¨‚å–®éŒ¯èª¤:', error);
    res.status(500).json({ 
      success: false, 
      message: 'å»ºç«‹è¨‚å–®æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message 
    });
  }
}));

app.get('/api/inventory-agent/stock/:productId?', asyncWrapper(async (req, res) => {
  try {
    if (!agentSystem) {
      return res.status(503).json({ 
        success: false, 
        message: 'Agent ç³»çµ±æœªå•Ÿå‹•' 
      });
    }

    const { productId } = req.params;
    
    const result = await agentSystem.executeTask('InventoryAgent', 'check_stock', {
      productId: productId ? parseInt(productId) : undefined
    });

    res.json({ success: true, data: result });
    
  } catch (error) {
    console.error('Agent åº«å­˜æŸ¥è©¢éŒ¯èª¤:', error);
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
}));

app.get('/api/inventory-agent/low-stock', asyncWrapper(async (req, res) => {
  try {
    if (!agentSystem) {
      return res.status(503).json({ 
        success: false, 
        message: 'Agent ç³»çµ±æœªå•Ÿå‹•' 
      });
    }

    const result = await agentSystem.executeTask('InventoryAgent', 'get_low_stock_items', {});

    res.json({ success: true, data: result });
    
  } catch (error) {
    console.error('Agent ä½åº«å­˜æŸ¥è©¢éŒ¯èª¤:', error);
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
}));

app.post('/api/inventory-agent/restock', ensureAdmin, asyncWrapper(async (req, res) => {
  try {
    if (!agentSystem) {
      return res.status(503).json({ 
        success: false, 
        message: 'Agent ç³»çµ±æœªå•Ÿå‹•' 
      });
    }

    const { productId, quantity, unitCost, supplierName, reason } = req.body;
    
    const result = await agentSystem.executeTask('InventoryAgent', 'restock_item', {
      productId: parseInt(productId),
      quantity: parseInt(quantity),
      unitCost: parseFloat(unitCost),
      supplierName,
      reason
    });

    res.json({ success: true, data: result });
    
  } catch (error) {
    console.error('Agent é€²è²¨éŒ¯èª¤:', error);
    res.status(500).json({ 
      success: false, 
      message: error.message 
    });
  }
}));

// ğŸš€ APIï¼šéƒ¨ç½²è³‡æ–™åº«æ›´æ–°ï¼ˆåŸ·è¡Œå•†å“æ–°å¢å’Œé¸é …å»ºç«‹ï¼‰
app.post('/api/admin/deploy-updates', ensureAdmin, async (req, res) => {
  // å¦‚æœåœ¨ç¤ºç¯„æ¨¡å¼ï¼Œå…ˆå˜—è©¦é‡æ–°é€£æ¥è³‡æ–™åº«
  if (demoMode) {
    console.log('ğŸ”„ ç¤ºç¯„æ¨¡å¼æª¢æ¸¬åˆ°ï¼Œå˜—è©¦é‡æ–°é€£æ¥è³‡æ–™åº«...');
    try {
      await createDatabasePool();
      if (demoMode) {
        return res.json({ 
          success: false, 
          message: 'è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œç„¡æ³•åŸ·è¡Œæ›´æ–°ã€‚è«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå’Œè³‡æ–™åº«è¨­å®šã€‚',
          demo: true,
          suggestion: 'è«‹ç¨å¾Œå†è©¦ï¼Œæˆ–è¯ç¹«ç®¡ç†å“¡æª¢æŸ¥ Supabase è³‡æ–™åº«ç‹€æ…‹ã€‚'
        });
      }
    } catch (error) {
      return res.json({ 
        success: false, 
        message: 'è³‡æ–™åº«é‡æ–°é€£ç·šå¤±æ•—: ' + error.message,
        demo: true 
      });
    }
  }

  try {
    console.log('ğŸš€ é–‹å§‹åŸ·è¡Œè³‡æ–™åº«éƒ¨ç½²æ›´æ–°...');
    
    // å»ºç«‹å•†å“é¸é …ç›¸é—œè³‡æ–™è¡¨
    console.log('ğŸ“‹ å»ºç«‹å•†å“é¸é …ç›¸é—œè³‡æ–™è¡¨...');
    
    await pool.query(`
      CREATE TABLE IF NOT EXISTS product_option_groups (
        id SERIAL PRIMARY KEY,
        product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        is_required BOOLEAN DEFAULT true,
        selection_type VARCHAR(20) DEFAULT 'single',
        sort_order INTEGER DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);

    await pool.query(`
      CREATE TABLE IF NOT EXISTS product_options (
        id SERIAL PRIMARY KEY,
        group_id INTEGER NOT NULL REFERENCES product_option_groups(id) ON DELETE CASCADE,
        name VARCHAR(100) NOT NULL,
        description TEXT,
        price_modifier NUMERIC(10,2) DEFAULT 0,
        is_default BOOLEAN DEFAULT false,
        sort_order INTEGER DEFAULT 0,
        is_active BOOLEAN DEFAULT true,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);

    await pool.query(`
      CREATE TABLE IF NOT EXISTS order_item_options (
        id SERIAL PRIMARY KEY,
        order_item_id INTEGER NOT NULL REFERENCES order_items(id) ON DELETE CASCADE,
        option_group_id INTEGER NOT NULL REFERENCES product_option_groups(id),
        option_id INTEGER NOT NULL REFERENCES product_options(id),
        option_name VARCHAR(100) NOT NULL,
        price_modifier NUMERIC(10,2) DEFAULT 0,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )
    `);

    console.log('âœ… å•†å“é¸é …è³‡æ–™è¡¨å»ºç«‹å®Œæˆ');

    // æª¢æŸ¥ä¸¦æ–°å¢å•†å“
    console.log('ğŸ¥¬ æª¢æŸ¥ä¸¦æ–°å¢å•†å“...');
    
    const existingProducts = await pool.query(`
      SELECT name FROM products 
      WHERE name IN ('ğŸ¥¬ ç©ºå¿ƒèœ', 'ğŸ¥¬ é«˜éº—èœ', 'ğŸŒ½ æ°´æœç‰ç±³')
    `);
    
    const existingNames = existingProducts.rows.map(p => p.name);
    const results = { created: [], existing: [] };

    // 1. æ–°å¢ç©ºå¿ƒèœ
    if (!existingNames.includes('ğŸ¥¬ ç©ºå¿ƒèœ')) {
      const spinachResult = await pool.query(
        'INSERT INTO products (name, price, is_priced_item, unit_hint) VALUES ($1, $2, $3, $4) RETURNING id',
        ['ğŸ¥¬ ç©ºå¿ƒèœ', 50, false, 'æ¯æŠŠ']
      );
      const spinachId = spinachResult.rows[0].id;
      
      await pool.query(
        'INSERT INTO inventory (product_id, current_stock, min_stock_alert, max_stock_capacity, unit_cost, supplier_name) VALUES ($1, $2, $3, $4, $5, $6)',
        [spinachId, 30, 5, 100, 35.0, 'æ–°é®®è¾²å ´']
      );
      
      await pool.query(
        'INSERT INTO stock_movements (product_id, movement_type, quantity, unit_cost, reason, operator_name) VALUES ($1, $2, $3, $4, $5, $6)',
        [spinachId, 'in', 30, 35.0, 'æ–°å•†å“åˆå§‹åº«å­˜', 'ç®¡ç†å“¡']
      );
      
      results.created.push('ğŸ¥¬ ç©ºå¿ƒèœ');
      console.log('âœ… ç©ºå¿ƒèœæ–°å¢å®Œæˆ');
    } else {
      results.existing.push('ğŸ¥¬ ç©ºå¿ƒèœ');
    }

    // 2. æ–°å¢é«˜éº—èœ  
    if (!existingNames.includes('ğŸ¥¬ é«˜éº—èœ')) {
      const cabbageResult = await pool.query(
        'INSERT INTO products (name, price, is_priced_item, unit_hint) VALUES ($1, $2, $3, $4) RETURNING id',
        ['ğŸ¥¬ é«˜éº—èœ', 45, true, 'æ¯æ–¤']
      );
      const cabbageId = cabbageResult.rows[0].id;
      
      await pool.query(
        'INSERT INTO inventory (product_id, current_stock, min_stock_alert, max_stock_capacity, unit_cost, supplier_name) VALUES ($1, $2, $3, $4, $5, $6)',
        [cabbageId, 20, 3, 50, 31.5, 'æœ‰æ©Ÿè¾²å ´']
      );
      
      await pool.query(
        'INSERT INTO stock_movements (product_id, movement_type, quantity, unit_cost, reason, operator_name) VALUES ($1, $2, $3, $4, $5, $6)',
        [cabbageId, 'in', 20, 31.5, 'æ–°å•†å“åˆå§‹åº«å­˜', 'ç®¡ç†å“¡']
      );
      
      results.created.push('ğŸ¥¬ é«˜éº—èœ');
      console.log('âœ… é«˜éº—èœæ–°å¢å®Œæˆ');
    } else {
      results.existing.push('ğŸ¥¬ é«˜éº—èœ');
    }

    // 3. æ–°å¢æ°´æœç‰ç±³
    let cornId;
    if (!existingNames.includes('ğŸŒ½ æ°´æœç‰ç±³')) {
      const cornResult = await pool.query(
        'INSERT INTO products (name, price, is_priced_item, unit_hint) VALUES ($1, $2, $3, $4) RETURNING id',
        ['ğŸŒ½ æ°´æœç‰ç±³', 80, false, 'æ¯æ¢']
      );
      cornId = cornResult.rows[0].id;
      
      await pool.query(
        'INSERT INTO inventory (product_id, current_stock, min_stock_alert, max_stock_capacity, unit_cost, supplier_name) VALUES ($1, $2, $3, $4, $5, $6)',
        [cornId, 25, 5, 100, 56.0, 'ç‰ç±³å°ˆæ¥­è¾²å ´']
      );
      
      await pool.query(
        'INSERT INTO stock_movements (product_id, movement_type, quantity, unit_cost, reason, operator_name) VALUES ($1, $2, $3, $4, $5, $6)',
        [cornId, 'in', 25, 56.0, 'æ–°å•†å“åˆå§‹åº«å­˜', 'ç®¡ç†å“¡']
      );
      
      results.created.push('ğŸŒ½ æ°´æœç‰ç±³');
      console.log('âœ… æ°´æœç‰ç±³æ–°å¢å®Œæˆ');
    } else {
      results.existing.push('ğŸŒ½ æ°´æœç‰ç±³');
      const cornResult = await pool.query('SELECT id FROM products WHERE name = $1', ['ğŸŒ½ æ°´æœç‰ç±³']);
      cornId = cornResult.rows[0].id;
    }

    // ç‚ºæ°´æœç‰ç±³å»ºç«‹é¸é …
    console.log('ğŸŒ½ ç‚ºæ°´æœç‰ç±³å»ºç«‹é¸é …...');
    
    const existingGroups = await pool.query(
      'SELECT id, name FROM product_option_groups WHERE product_id = $1',
      [cornId]
    );

    if (existingGroups.rows.length === 0) {
      // å»ºç«‹æ’¥çš®é¸é …ç¾¤çµ„
      const peelGroupResult = await pool.query(`
        INSERT INTO product_option_groups (product_id, name, description, is_required, selection_type, sort_order)
        VALUES ($1, $2, $3, $4, $5, $6) RETURNING id
      `, [cornId, 'æ’¥çš®æœå‹™', 'æ˜¯å¦éœ€è¦ä»£ç‚ºæ’¥ç‰ç±³çš®', true, 'single', 1]);
      
      const peelGroupId = peelGroupResult.rows[0].id;

      // å»ºç«‹æ’¥çš®é¸é …
      await pool.query(`
        INSERT INTO product_options (group_id, name, description, price_modifier, is_default, sort_order)
        VALUES 
        ($1, 'è¦æ’¥çš®', 'ä»£ç‚ºæ’¥é™¤ç‰ç±³å¤–çš®', 5, false, 1),
        ($1, 'ä¸æ’¥çš®', 'ä¿æŒåŸç‹€ä¸è™•ç†', 0, true, 2)
      `, [peelGroupId]);

      // å»ºç«‹åˆ‡ç‰‡é¸é …ç¾¤çµ„
      const sliceGroupResult = await pool.query(`
        INSERT INTO product_option_groups (product_id, name, description, is_required, selection_type, sort_order)
        VALUES ($1, $2, $3, $4, $5, $6) RETURNING id
      `, [cornId, 'åˆ‡ç‰‡æœå‹™', 'æ˜¯å¦éœ€è¦åˆ‡æˆç‰‡ç‹€', true, 'single', 2]);
      
      const sliceGroupId = sliceGroupResult.rows[0].id;

      // å»ºç«‹åˆ‡ç‰‡é¸é …
      await pool.query(`
        INSERT INTO product_options (group_id, name, description, price_modifier, is_default, sort_order)
        VALUES 
        ($1, 'è¦åˆ‡ç‰‡', 'åˆ‡æˆé©åˆé£Ÿç”¨çš„ç‰‡ç‹€', 3, false, 1),
        ($1, 'ä¸åˆ‡ç‰‡', 'ä¿æŒæ•´æ¢ç‹€æ…‹', 0, true, 2)
      `, [sliceGroupId]);

      console.log('âœ… æ°´æœç‰ç±³é¸é …å·²å»ºç«‹');
    } else {
      console.log('â­ï¸ æ°´æœç‰ç±³é¸é …å·²å­˜åœ¨ï¼Œè·³é');
    }

    // é©—è­‰çµæœ
    const finalResult = await pool.query(`
      SELECT 
        p.id,
        p.name,
        p.price,
        p.is_priced_item,
        p.unit_hint,
        i.current_stock,
        i.supplier_name,
        COUNT(pog.id) as option_groups_count
      FROM products p
      LEFT JOIN inventory i ON p.id = i.product_id
      LEFT JOIN product_option_groups pog ON p.id = pog.product_id
      WHERE p.name IN ('ğŸ¥¬ ç©ºå¿ƒèœ', 'ğŸ¥¬ é«˜éº—èœ', 'ğŸŒ½ æ°´æœç‰ç±³')
      GROUP BY p.id, p.name, p.price, p.is_priced_item, p.unit_hint, i.current_stock, i.supplier_name
      ORDER BY p.id DESC
    `);

    console.log('ğŸ‰ éƒ¨ç½²å®Œæˆï¼');
    
    res.json({
      success: true,
      message: 'éƒ¨ç½²æ›´æ–°å®Œæˆ',
      results: {
        created: results.created,
        existing: results.existing,
        products: finalResult.rows
      }
    });

  } catch (error) {
    console.error('âŒ éƒ¨ç½²å¤±æ•—:', error);
    res.status(500).json({
      success: false,
      message: 'éƒ¨ç½²å¤±æ•—: ' + error.message
    });
  }
});

// ğŸ”§ APIï¼šæ‰‹å‹•é‡æ–°é€£æ¥è³‡æ–™åº«
app.post('/api/admin/reconnect-database', ensureAdmin, async (req, res) => {
  try {
    console.log('ğŸ”„ ç®¡ç†å“¡è«‹æ±‚é‡æ–°é€£æ¥è³‡æ–™åº«...');
    
    // é—œé–‰ç¾æœ‰é€£ç·š
    if (pool && typeof pool.end === 'function') {
      await pool.end();
    }
    
    // é‡æ–°å»ºç«‹é€£ç·š
    await createDatabasePool();
    
    if (demoMode) {
      res.json({
        success: false,
        message: 'è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œä»åœ¨ç¤ºç¯„æ¨¡å¼',
        demoMode: true
      });
    } else {
      // æ¸¬è©¦é€£ç·š
      const testResult = await pool.query('SELECT NOW() as current_time, version() as db_version');
      res.json({
        success: true,
        message: 'è³‡æ–™åº«é‡æ–°é€£ç·šæˆåŠŸ',
        demoMode: false,
        connectionTime: testResult.rows[0].current_time,
        databaseVersion: testResult.rows[0].db_version.substring(0, 50) + '...'
      });
    }
    
  } catch (error) {
    console.error('âŒ é‡æ–°é€£ç·šå¤±æ•—:', error);
    res.status(500).json({
      success: false,
      message: 'é‡æ–°é€£ç·šå¤±æ•—: ' + error.message,
      demoMode: demoMode
    });
  }
});

// 404è™•ç†
app.use(notFoundHandler);

// APIéŒ¯èª¤è™•ç†
app.use('/api/*', apiErrorHandler);

// é é¢éŒ¯èª¤è™•ç†
app.use(pageErrorHandler);

// å„ªé›…é—œé–‰è™•ç†
const gracefulShutdown = async (signal) => {
  console.log(`\nğŸ“´ æ”¶åˆ° ${signal} ä¿¡è™Ÿï¼Œæ­£åœ¨å„ªé›…é—œé–‰...`);
  
  try {
    // é—œé–‰ Agent ç³»çµ±
    if (agentSystem) {
      console.log('ğŸ¤– æ­£åœ¨é—œé–‰ Agent ç³»çµ±...');
      await agentSystem.shutdown();
    }
    
    // é—œé–‰è³‡æ–™åº«é€£ç·š
    if (pool && typeof pool.end === 'function') {
      console.log('ğŸ”Œ æ­£åœ¨é—œé–‰è³‡æ–™åº«é€£ç·š...');
      await pool.end();
    }
    
    console.log('âœ… ç³»çµ±å·²å„ªé›…é—œé–‰');
    process.exit(0);
    
  } catch (error) {
    console.error('âŒ é—œé–‰éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
    process.exit(1);
  }
};

// ç›£è½é—œé–‰ä¿¡è™Ÿ
process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));
process.on('uncaughtException', (error) => {
  console.error('âŒ æœªæ•ç²çš„ä¾‹å¤–:', error);
  gracefulShutdown('uncaughtException');
});
process.on('unhandledRejection', (reason, promise) => {
  console.error('âŒ æœªè™•ç†çš„ Promise æ‹’çµ•:', reason);
  gracefulShutdown('unhandledRejection');
});

// å•Ÿå‹•ä¼ºæœå™¨
const server = app.listen(port, () => {
  console.log(`ğŸš€ chengyivegetable ç³»çµ±æ­£åœ¨ç›£è½åŸ è™Ÿ ${port}`);
  console.log(`ğŸ“± å‰å°ç¶²å€: http://localhost:${port}`);
  console.log(`âš™ï¸  ç®¡ç†å¾Œå°: http://localhost:${port}/admin`);
  console.log(`ğŸ¤– Agent ç®¡ç†: http://localhost:${port}/api/admin/agents/status`);
  console.log(`ğŸŒ ç’°å¢ƒ: ${process.env.NODE_ENV || 'development'}`);
});