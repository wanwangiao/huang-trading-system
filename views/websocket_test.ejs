<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket åŠŸèƒ½æ¸¬è©¦</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .panel {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: #f9f9f9;
    }
    
    .status {
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      font-weight: bold;
    }
    
    .status.connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status.disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status.connecting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
    
    .log {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    
    .log-entry {
      margin-bottom: 2px;
      padding: 2px 0;
    }
    
    .log-time {
      color: #666;
      font-size: 11px;
    }
    
    .log-type {
      font-weight: bold;
      margin: 0 5px;
    }
    
    .log-type.info { color: #007bff; }
    .log-type.success { color: #28a745; }
    .log-type.warning { color: #ffc107; }
    .log-type.error { color: #dc3545; }
  </style>
</head>
<body>
  <h1>ğŸ”Œ WebSocket åŠŸèƒ½æ¸¬è©¦</h1>
  
  <div id="connectionStatus" class="status disconnected">
    æœªé€£æ¥åˆ°WebSocketæœå‹™
  </div>
  
  <div class="container">
    <!-- é€£æ¥æ§åˆ¶ -->
    <div class="panel">
      <h3>é€£æ¥æ§åˆ¶</h3>
      
      <div class="form-group">
        <label for="userType">ç”¨æˆ¶é¡å‹:</label>
        <select id="userType">
          <option value="admin">ç®¡ç†å“¡</option>
          <option value="driver">å¤–é€å“¡</option>
          <option value="customer">å®¢æˆ¶</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="userId">ç”¨æˆ¶ID:</label>
        <input type="text" id="userId" value="test_user_1" placeholder="è¼¸å…¥ç”¨æˆ¶ID">
      </div>
      
      <button id="connectBtn" class="btn btn-primary">é€£æ¥WebSocket</button>
      <button id="disconnectBtn" class="btn btn-danger" disabled>æ–·é–‹é€£æ¥</button>
      <button id="authenticateBtn" class="btn btn-success" disabled>èº«ä»½é©—è­‰</button>
    </div>
    
    <!-- æˆ¿é–“ç®¡ç† -->
    <div class="panel">
      <h3>æˆ¿é–“ç®¡ç†</h3>
      
      <div class="form-group">
        <label for="roomName">æˆ¿é–“åç¨±:</label>
        <input type="text" id="roomName" value="test_room" placeholder="è¼¸å…¥æˆ¿é–“åç¨±">
      </div>
      
      <button id="joinRoomBtn" class="btn btn-primary" disabled>åŠ å…¥æˆ¿é–“</button>
      <button id="leaveRoomBtn" class="btn btn-warning" disabled>é›¢é–‹æˆ¿é–“</button>
      
      <div style="margin-top: 15px;">
        <strong>é è¨­æˆ¿é–“:</strong>
        <button class="btn btn-primary room-btn" data-room="admin_global" disabled>ç®¡ç†å“¡å…¨åŸŸ</button>
        <button class="btn btn-primary room-btn" data-room="drivers_global" disabled>å¤–é€å“¡å¤§å»³</button>
        <button class="btn btn-primary room-btn" data-room="system_monitoring" disabled>ç³»çµ±ç›£æ§</button>
      </div>
    </div>
    
    <!-- è¨Šæ¯ç™¼é€ -->
    <div class="panel">
      <h3>è¨Šæ¯ç™¼é€</h3>
      
      <div class="form-group">
        <label for="broadcastRoom">å»£æ’­æˆ¿é–“:</label>
        <input type="text" id="broadcastRoom" value="test_room" placeholder="æˆ¿é–“åç¨±">
      </div>
      
      <div class="form-group">
        <label for="broadcastMessage">å»£æ’­è¨Šæ¯:</label>
        <textarea id="broadcastMessage" rows="3" placeholder="è¼¸å…¥è¦å»£æ’­çš„è¨Šæ¯..."></textarea>
      </div>
      
      <button id="sendBroadcastBtn" class="btn btn-primary" disabled>ç™¼é€å»£æ’­</button>
      
      <hr style="margin: 20px 0;">
      
      <div class="form-group">
        <label for="privateTargetType">ç§è¨Šç›®æ¨™é¡å‹:</label>
        <select id="privateTargetType">
          <option value="admin">ç®¡ç†å“¡</option>
          <option value="driver">å¤–é€å“¡</option>
          <option value="customer">å®¢æˆ¶</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="privateTargetId">ç§è¨Šç›®æ¨™ID:</label>
        <input type="text" id="privateTargetId" value="test_user_2" placeholder="ç›®æ¨™ç”¨æˆ¶ID">
      </div>
      
      <div class="form-group">
        <label for="privateMessage">ç§äººè¨Šæ¯:</label>
        <textarea id="privateMessage" rows="2" placeholder="è¼¸å…¥ç§äººè¨Šæ¯..."></textarea>
      </div>
      
      <button id="sendPrivateBtn" class="btn btn-success" disabled>ç™¼é€ç§è¨Š</button>
    </div>
    
    <!-- ä½ç½®æ¸¬è©¦ -->
    <div class="panel">
      <h3>ä½ç½®æ¸¬è©¦ (å¤–é€å“¡)</h3>
      
      <div class="form-group">
        <label for="lat">ç·¯åº¦:</label>
        <input type="number" id="lat" value="25.0330" step="0.000001" placeholder="ç·¯åº¦">
      </div>
      
      <div class="form-group">
        <label for="lng">ç¶“åº¦:</label>
        <input type="number" id="lng" value="121.5654" step="0.000001" placeholder="ç¶“åº¦">
      </div>
      
      <button id="sendLocationBtn" class="btn btn-warning" disabled>ç™¼é€ä½ç½®</button>
      <button id="startLocationBtn" class="btn btn-success" disabled>é–‹å§‹æ¨¡æ“¬ä½ç½®</button>
      <button id="stopLocationBtn" class="btn btn-danger" disabled>åœæ­¢æ¨¡æ“¬</button>
    </div>
  </div>
  
  <!-- æ—¥èªŒ -->
  <div class="panel" style="margin-top: 20px;">
    <h3>ğŸ“‹ è¨Šæ¯æ—¥èªŒ</h3>
    <div id="messageLog" class="log">
      <div class="log-entry">
        <span class="log-time">[åˆå§‹åŒ–]</span>
        <span class="log-type info">[INFO]</span>
        WebSocketæ¸¬è©¦å·¥å…·å·²è¼‰å…¥
      </div>
    </div>
    <button id="clearLogBtn" class="btn btn-warning" style="margin-top: 10px;">æ¸…é™¤æ—¥èªŒ</button>
  </div>

  <script src="/js/websocket-client.js"></script>
  <script>
    class WebSocketTester {
      constructor() {
        this.wsClient = new WebSocketClient();
        this.locationTimer = null;
        
        this.initializeElements();
        this.initializeEventHandlers();
        this.initializeWebSocketHandlers();
        
        this.log('info', 'WebSocketæ¸¬è©¦å·¥å…·å·²åˆå§‹åŒ–');
      }

      initializeElements() {
        this.connectionStatus = document.getElementById('connectionStatus');
        this.connectBtn = document.getElementById('connectBtn');
        this.disconnectBtn = document.getElementById('disconnectBtn');
        this.authenticateBtn = document.getElementById('authenticateBtn');
        this.userType = document.getElementById('userType');
        this.userId = document.getElementById('userId');
        
        this.roomName = document.getElementById('roomName');
        this.joinRoomBtn = document.getElementById('joinRoomBtn');
        this.leaveRoomBtn = document.getElementById('leaveRoomBtn');
        this.roomBtns = document.querySelectorAll('.room-btn');
        
        this.broadcastRoom = document.getElementById('broadcastRoom');
        this.broadcastMessage = document.getElementById('broadcastMessage');
        this.sendBroadcastBtn = document.getElementById('sendBroadcastBtn');
        
        this.privateTargetType = document.getElementById('privateTargetType');
        this.privateTargetId = document.getElementById('privateTargetId');
        this.privateMessage = document.getElementById('privateMessage');
        this.sendPrivateBtn = document.getElementById('sendPrivateBtn');
        
        this.lat = document.getElementById('lat');
        this.lng = document.getElementById('lng');
        this.sendLocationBtn = document.getElementById('sendLocationBtn');
        this.startLocationBtn = document.getElementById('startLocationBtn');
        this.stopLocationBtn = document.getElementById('stopLocationBtn');
        
        this.messageLog = document.getElementById('messageLog');
        this.clearLogBtn = document.getElementById('clearLogBtn');
      }

      initializeEventHandlers() {
        this.connectBtn.addEventListener('click', () => this.connect());
        this.disconnectBtn.addEventListener('click', () => this.disconnect());
        this.authenticateBtn.addEventListener('click', () => this.authenticate());
        
        this.joinRoomBtn.addEventListener('click', () => this.joinRoom());
        this.leaveRoomBtn.addEventListener('click', () => this.leaveRoom());
        
        this.roomBtns.forEach(btn => {
          btn.addEventListener('click', () => {
            this.roomName.value = btn.dataset.room;
            this.joinRoom();
          });
        });
        
        this.sendBroadcastBtn.addEventListener('click', () => this.sendBroadcast());
        this.sendPrivateBtn.addEventListener('click', () => this.sendPrivate());
        
        this.sendLocationBtn.addEventListener('click', () => this.sendLocation());
        this.startLocationBtn.addEventListener('click', () => this.startLocationSimulation());
        this.stopLocationBtn.addEventListener('click', () => this.stopLocationSimulation());
        
        this.clearLogBtn.addEventListener('click', () => this.clearLog());
      }

      initializeWebSocketHandlers() {
        this.wsClient.on('connected', () => {
          this.updateConnectionStatus('connected', 'å·²é€£æ¥åˆ°WebSocketæœå‹™');
          this.updateButtonStates(true, false, true);
          this.log('success', 'WebSocketé€£æ¥æˆåŠŸ');
        });

        this.wsClient.on('authenticated', (data) => {
          this.log('success', `èº«ä»½é©—è­‰æˆåŠŸ: ${data.userType}_${data.userId}`);
          this.updateButtonStates(true, true, false);
        });

        this.wsClient.on('disconnected', () => {
          this.updateConnectionStatus('disconnected', 'WebSocketé€£æ¥å·²æ–·é–‹');
          this.updateButtonStates(false, false, false);
          this.log('warning', 'WebSocketé€£æ¥æ–·é–‹');
        });

        this.wsClient.on('join_room_result', (data) => {
          if (data.success) {
            this.log('success', `æˆåŠŸåŠ å…¥æˆ¿é–“: ${data.room}`);
          } else {
            this.log('error', `åŠ å…¥æˆ¿é–“å¤±æ•—: ${data.room} - ${data.message}`);
          }
        });

        this.wsClient.on('broadcast_message', (data) => {
          this.log('info', `æ”¶åˆ°å»£æ’­ [${data.room}]: ${data.content}`);
        });

        this.wsClient.on('private_message', (data) => {
          this.log('info', `æ”¶åˆ°ç§è¨Šä¾†è‡ª ${data.sender.userType}_${data.sender.userId}: ${data.content}`);
        });

        this.wsClient.on('driver_location_update', (data) => {
          this.log('info', `å¤–é€å“¡ä½ç½®æ›´æ–°: driver_${data.driverId} (${data.location.lat}, ${data.location.lng})`);
        });

        this.wsClient.on('server_error', (data) => {
          this.log('error', `ä¼ºæœå™¨éŒ¯èª¤: ${data.message}`);
        });
      }

      async connect() {
        this.updateConnectionStatus('connecting', 'æ­£åœ¨é€£æ¥WebSocketæœå‹™...');
        this.log('info', 'å˜—è©¦é€£æ¥WebSocket...');
        
        try {
          await this.wsClient.connect();
        } catch (error) {
          this.updateConnectionStatus('disconnected', 'é€£æ¥å¤±æ•—');
          this.log('error', `é€£æ¥å¤±æ•—: ${error.message}`);
        }
      }

      disconnect() {
        this.wsClient.disconnect();
        this.stopLocationSimulation();
      }

      authenticate() {
        const userType = this.userType.value;
        const userId = this.userId.value.trim();
        
        if (!userId) {
          alert('è«‹è¼¸å…¥ç”¨æˆ¶ID');
          return;
        }
        
        this.wsClient.authenticate(userType, userId);
        this.log('info', `ç™¼é€èº«ä»½é©—è­‰: ${userType}_${userId}`);
      }

      joinRoom() {
        const room = this.roomName.value.trim();
        if (!room) {
          alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±');
          return;
        }
        
        this.wsClient.joinRoom(room);
        this.log('info', `å˜—è©¦åŠ å…¥æˆ¿é–“: ${room}`);
      }

      leaveRoom() {
        const room = this.roomName.value.trim();
        if (!room) {
          alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±');
          return;
        }
        
        this.wsClient.leaveRoom(room);
        this.log('info', `å˜—è©¦é›¢é–‹æˆ¿é–“: ${room}`);
      }

      sendBroadcast() {
        const room = this.broadcastRoom.value.trim();
        const message = this.broadcastMessage.value.trim();
        
        if (!room || !message) {
          alert('è«‹è¼¸å…¥æˆ¿é–“åç¨±å’Œè¨Šæ¯å…§å®¹');
          return;
        }
        
        this.wsClient.broadcast(room, message);
        this.log('info', `ç™¼é€å»£æ’­åˆ° ${room}: ${message}`);
        this.broadcastMessage.value = '';
      }

      sendPrivate() {
        const targetType = this.privateTargetType.value;
        const targetId = this.privateTargetId.value.trim();
        const message = this.privateMessage.value.trim();
        
        if (!targetId || !message) {
          alert('è«‹è¼¸å…¥ç›®æ¨™ç”¨æˆ¶IDå’Œè¨Šæ¯å…§å®¹');
          return;
        }
        
        this.wsClient.sendPrivateMessage(targetType, targetId, message);
        this.log('info', `ç™¼é€ç§è¨Šåˆ° ${targetType}_${targetId}: ${message}`);
        this.privateMessage.value = '';
      }

      sendLocation() {
        const lat = parseFloat(this.lat.value);
        const lng = parseFloat(this.lng.value);
        
        if (isNaN(lat) || isNaN(lng)) {
          alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„åº§æ¨™');
          return;
        }
        
        this.wsClient.updateDriverLocation(lat, lng, 10, 0);
        this.log('info', `ç™¼é€ä½ç½®: (${lat}, ${lng})`);
      }

      startLocationSimulation() {
        if (this.locationTimer) {
          this.stopLocationSimulation();
        }
        
        let lat = parseFloat(this.lat.value);
        let lng = parseFloat(this.lng.value);
        
        this.locationTimer = setInterval(() => {
          // æ¨¡æ“¬ç§»å‹•ï¼šéš¨æ©Ÿåç§»åº§æ¨™
          lat += (Math.random() - 0.5) * 0.001;
          lng += (Math.random() - 0.5) * 0.001;
          
          this.lat.value = lat.toFixed(6);
          this.lng.value = lng.toFixed(6);
          
          this.wsClient.updateDriverLocation(lat, lng, 10, 50);
        }, 3000);
        
        this.log('info', 'é–‹å§‹ä½ç½®æ¨¡æ“¬ (æ¯3ç§’æ›´æ–°ä¸€æ¬¡)');
        this.startLocationBtn.disabled = true;
        this.stopLocationBtn.disabled = false;
      }

      stopLocationSimulation() {
        if (this.locationTimer) {
          clearInterval(this.locationTimer);
          this.locationTimer = null;
          this.log('info', 'åœæ­¢ä½ç½®æ¨¡æ“¬');
          this.startLocationBtn.disabled = false;
          this.stopLocationBtn.disabled = true;
        }
      }

      updateConnectionStatus(status, message) {
        this.connectionStatus.className = `status ${status}`;
        this.connectionStatus.textContent = message;
      }

      updateButtonStates(connected, authenticated, needAuth) {
        this.connectBtn.disabled = connected;
        this.disconnectBtn.disabled = !connected;
        this.authenticateBtn.disabled = !needAuth;
        
        this.joinRoomBtn.disabled = !authenticated;
        this.leaveRoomBtn.disabled = !authenticated;
        this.sendBroadcastBtn.disabled = !authenticated;
        this.sendPrivateBtn.disabled = !authenticated;
        this.sendLocationBtn.disabled = !authenticated;
        this.startLocationBtn.disabled = !authenticated;
        
        this.roomBtns.forEach(btn => {
          btn.disabled = !authenticated;
        });
      }

      log(type, message) {
        const timestamp = new Date().toLocaleTimeString('zh-TW');
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
          <span class="log-time">[${timestamp}]</span>
          <span class="log-type ${type}">[${type.toUpperCase()}]</span>
          ${message}
        `;
        
        this.messageLog.appendChild(logEntry);
        this.messageLog.scrollTop = this.messageLog.scrollHeight;
        
        // é™åˆ¶æ—¥èªŒæ¢ç›®æ•¸é‡
        const entries = this.messageLog.children;
        if (entries.length > 100) {
          this.messageLog.removeChild(entries[0]);
        }
      }

      clearLog() {
        this.messageLog.innerHTML = '';
        this.log('info', 'æ—¥èªŒå·²æ¸…é™¤');
      }
    }

    // åˆå§‹åŒ–æ¸¬è©¦å·¥å…·
    document.addEventListener('DOMContentLoaded', () => {
      new WebSocketTester();
    });
  </script>
</body>
</html>