<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å¤–é€å“¡é€šè¨Šä¸­å¿ƒ</title>
  <link rel="stylesheet" href="/css/driver-portal.css">
  <style>
    .chat-container {
      display: flex;
      height: 80vh;
      gap: 20px;
      margin-top: 20px;
    }
    
    .chat-sidebar {
      width: 250px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      overflow-y: auto;
    }
    
    .chat-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chat-header {
      padding: 15px 20px;
      border-bottom: 1px solid #e9ecef;
      background: #007bff;
      color: white;
      border-radius: 8px 8px 0 0;
    }
    
    .chat-messages {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      max-height: 400px;
    }
    
    .chat-input {
      padding: 15px 20px;
      border-top: 1px solid #e9ecef;
      background: #f8f9fa;
      border-radius: 0 0 8px 8px;
    }
    
    .message {
      margin-bottom: 15px;
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 70%;
    }
    
    .message.sent {
      background: #007bff;
      color: white;
      margin-left: auto;
      text-align: right;
    }
    
    .message.received {
      background: #e9ecef;
      color: #333;
    }
    
    .message.system {
      background: #fff3cd;
      color: #856404;
      text-align: center;
      max-width: 100%;
    }
    
    .message-time {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 5px;
    }
    
    .message-sender {
      font-weight: bold;
      font-size: 12px;
      margin-bottom: 5px;
    }
    
    .input-group {
      display: flex;
      gap: 10px;
    }
    
    .input-group input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .input-group button {
      padding: 10px 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .status-indicator {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 8px;
    }
    
    .status-online { background: #28a745; }
    .status-offline { background: #dc3545; }
    .status-connecting { background: #ffc107; }
    
    .room-list {
      margin-bottom: 20px;
    }
    
    .room-item {
      padding: 10px;
      margin-bottom: 5px;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #e9ecef;
    }
    
    .room-item:hover {
      background: #e9ecef;
    }
    
    .room-item.active {
      background: #007bff;
      color: white;
    }
    
    .notification-badge {
      background: #dc3545;
      color: white;
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 11px;
      margin-left: 8px;
    }
    
    .connection-status {
      padding: 10px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 15px;
      border-radius: 4px;
    }
    
    .location-controls {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .location-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-warning { background: #ffc107; color: #212529; }
    .btn-danger { background: #dc3545; color: white; }
  </style>
</head>
<body>
  <div class="driver-header">
    <h1>å¤–é€å“¡é€šè¨Šä¸­å¿ƒ</h1>
    <nav>
      <a href="/driver/dashboard">å·¥ä½œå°</a> |
      <a href="/driver/orders">æˆ‘çš„è¨‚å–®</a> |
      <a href="/driver/profile">å€‹äººè³‡æ–™</a> |
      <a href="/driver/logout">ç™»å‡º</a>
    </nav>
  </div>

  <div class="container">
    <!-- é€£æ¥ç‹€æ…‹ -->
    <div id="connectionStatus" class="connection-status">
      <span class="status-indicator status-connecting"></span>
      æ­£åœ¨é€£æ¥é€šè¨Šæœå‹™...
    </div>

    <!-- ä½ç½®æ§åˆ¶ -->
    <div class="location-controls">
      <div class="location-status">
        <span>ä½ç½®è¿½è¹¤: <span id="locationStatus">æœªå•Ÿç”¨</span></span>
        <button id="toggleLocation" class="btn btn-primary">å•Ÿç”¨ä½ç½®è¿½è¹¤</button>
      </div>
      <div id="locationInfo" style="font-size: 12px; color: #666; display: none;">
        <span id="coordinatesDisplay">åº§æ¨™: --</span> |
        <span id="accuracyDisplay">ç²¾åº¦: --</span>
      </div>
    </div>

    <div class="chat-container">
      <!-- å´é‚Šæ¬„ -->
      <div class="chat-sidebar">
        <h3>é€šè¨Šæˆ¿é–“</h3>
        <div class="room-list" id="roomList">
          <div class="room-item" data-room="drivers_global">
            ğŸ“¢ å¤–é€å“¡å¤§å»³
            <span class="notification-badge" id="badge_drivers_global" style="display: none;">0</span>
          </div>
          <div class="room-item" data-room="admin_global">
            ğŸ‘¥ ç®¡ç†ä¸­å¿ƒ
            <span class="notification-badge" id="badge_admin_global" style="display: none;">0</span>
          </div>
        </div>

        <h3>å¤–é€å“¡åˆ—è¡¨</h3>
        <div id="driverList">
          <div style="text-align: center; color: #666; padding: 20px;">
            è¼‰å…¥ä¸­...
          </div>
        </div>
      </div>

      <!-- ä¸»èŠå¤©å€åŸŸ -->
      <div class="chat-main">
        <div class="chat-header">
          <h3 id="chatTitle">é¸æ“‡ä¸€å€‹æˆ¿é–“é–‹å§‹èŠå¤©</h3>
          <small id="chatSubtitle"></small>
        </div>
        
        <div class="chat-messages" id="chatMessages">
          <div class="message system">
            æ­¡è¿ä½¿ç”¨å¤–é€å“¡é€šè¨Šç³»çµ±ï¼è«‹é¸æ“‡å·¦å´çš„æˆ¿é–“é–‹å§‹èŠå¤©ã€‚
          </div>
        </div>
        
        <div class="chat-input">
          <div class="input-group">
            <input type="text" id="messageInput" placeholder="è¼¸å…¥è¨Šæ¯..." disabled>
            <button id="sendButton" disabled>ç™¼é€</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- å¤–é€å“¡è³‡è¨Š -->
  <script>
    const driverInfo = {
      id: '<%= driver.id %>',
      name: '<%= driver.name %>',
      phone: '<%= driver.phone %>'
    };
  </script>

  <script src="/js/websocket-client.js"></script>
  <script>
    class DriverChatApp {
      constructor() {
        this.wsClient = new WebSocketClient();
        this.currentRoom = null;
        this.unreadCounts = new Map();
        this.locationWatcher = null;
        this.isLocationTracking = false;
        
        this.initializeElements();
        this.initializeWebSocket();
        this.initializeLocationTracking();
        
        console.log('ğŸšš å¤–é€å“¡é€šè¨Šæ‡‰ç”¨å·²å•Ÿå‹•');
      }

      initializeElements() {
        this.connectionStatus = document.getElementById('connectionStatus');
        this.roomList = document.getElementById('roomList');
        this.chatTitle = document.getElementById('chatTitle');
        this.chatSubtitle = document.getElementById('chatSubtitle');
        this.chatMessages = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendButton = document.getElementById('sendButton');
        this.toggleLocationBtn = document.getElementById('toggleLocation');
        this.locationStatus = document.getElementById('locationStatus');
        this.locationInfo = document.getElementById('locationInfo');
        this.coordinatesDisplay = document.getElementById('coordinatesDisplay');
        this.accuracyDisplay = document.getElementById('accuracyDisplay');

        // äº‹ä»¶ç›£è½
        this.sendButton.addEventListener('click', () => this.sendMessage());
        this.messageInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') this.sendMessage();
        });
        this.toggleLocationBtn.addEventListener('click', () => this.toggleLocationTracking());

        // æˆ¿é–“é»æ“Šäº‹ä»¶
        this.roomList.addEventListener('click', (e) => {
          const roomItem = e.target.closest('.room-item');
          if (roomItem) {
            this.switchRoom(roomItem.dataset.room);
          }
        });
      }

      async initializeWebSocket() {
        this.updateConnectionStatus('connecting', 'æ­£åœ¨é€£æ¥é€šè¨Šæœå‹™...');

        // è¨­å®šäº‹ä»¶ç›£è½
        this.wsClient.on('connected', () => {
          this.updateConnectionStatus('connected', 'å·²é€£æ¥åˆ°é€šè¨Šæœå‹™');
          // è‡ªå‹•é€²è¡Œèº«ä»½é©—è­‰
          this.wsClient.authenticate('driver', driverInfo.id);
        });

        this.wsClient.on('authenticated', () => {
          this.updateConnectionStatus('online', `${driverInfo.name} å·²ä¸Šç·š`);
          this.enableChatInterface();
        });

        this.wsClient.on('disconnected', () => {
          this.updateConnectionStatus('offline', 'é€šè¨Šæœå‹™å·²æ–·ç·š');
          this.disableChatInterface();
        });

        this.wsClient.on('broadcast_message', (data) => {
          this.handleBroadcastMessage(data);
        });

        this.wsClient.on('private_message', (data) => {
          this.handlePrivateMessage(data);
        });

        this.wsClient.on('server_error', (data) => {
          this.addSystemMessage(`ä¼ºæœå™¨éŒ¯èª¤: ${data.message}`);
        });

        // é€£æ¥åˆ°WebSocket
        try {
          await this.wsClient.connect();
        } catch (error) {
          this.updateConnectionStatus('error', 'é€£æ¥å¤±æ•—');
          console.error('WebSocketé€£æ¥å¤±æ•—:', error);
        }
      }

      updateConnectionStatus(status, message) {
        const indicator = this.connectionStatus.querySelector('.status-indicator');
        indicator.className = `status-indicator status-${status}`;
        this.connectionStatus.innerHTML = `<span class="status-indicator status-${status}"></span>${message}`;
      }

      enableChatInterface() {
        this.messageInput.disabled = false;
        this.sendButton.disabled = false;
        this.messageInput.placeholder = 'è¼¸å…¥è¨Šæ¯...';
        
        // è‡ªå‹•åŠ å…¥å¤–é€å“¡å¤§å»³
        this.switchRoom('drivers_global');
      }

      disableChatInterface() {
        this.messageInput.disabled = true;
        this.sendButton.disabled = true;
        this.messageInput.placeholder = 'é€šè¨Šæœå‹™æœªé€£æ¥';
      }

      switchRoom(roomName) {
        if (this.currentRoom === roomName) return;

        // æ›´æ–°UI
        document.querySelectorAll('.room-item').forEach(item => {
          item.classList.remove('active');
        });
        document.querySelector(`[data-room="${roomName}"]`).classList.add('active');

        // æ¸…é™¤æœªè®€è¨ˆæ•¸
        this.clearUnreadCount(roomName);

        // æ›´æ–°èŠå¤©æ¨™é¡Œ
        const roomTitles = {
          'drivers_global': 'å¤–é€å“¡å¤§å»³',
          'admin_global': 'ç®¡ç†ä¸­å¿ƒ'
        };
        
        this.chatTitle.textContent = roomTitles[roomName] || roomName;
        this.chatSubtitle.textContent = `æˆ¿é–“: ${roomName}`;

        // æ¸…ç©ºè¨Šæ¯å€åŸŸ
        this.chatMessages.innerHTML = '';
        
        // åŠ å…¥æˆ¿é–“
        if (this.currentRoom) {
          this.wsClient.leaveRoom(this.currentRoom);
        }
        
        this.wsClient.joinRoom(roomName);
        this.currentRoom = roomName;

        this.addSystemMessage(`å·²åŠ å…¥ ${roomTitles[roomName] || roomName}`);
      }

      sendMessage() {
        const message = this.messageInput.value.trim();
        if (!message || !this.currentRoom) return;

        // ç™¼é€å»£æ’­è¨Šæ¯
        this.wsClient.broadcast(this.currentRoom, message);
        
        // é¡¯ç¤ºåœ¨èŠå¤©å€åŸŸ
        this.addMessage({
          type: 'sent',
          content: message,
          sender: { userType: 'driver', userId: driverInfo.id },
          timestamp: new Date().toISOString()
        });

        this.messageInput.value = '';
      }

      handleBroadcastMessage(data) {
        if (data.room === this.currentRoom) {
          this.addMessage({
            type: 'received',
            content: data.content,
            sender: data.sender,
            timestamp: data.timestamp
          });
        } else {
          // æ›´æ–°æœªè®€è¨ˆæ•¸
          this.incrementUnreadCount(data.room);
        }
      }

      handlePrivateMessage(data) {
        this.addMessage({
          type: 'private',
          content: data.content,
          sender: data.sender,
          timestamp: data.timestamp
        });
      }

      addMessage(messageData) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${messageData.type}`;

        let senderInfo = '';
        if (messageData.type === 'received' || messageData.type === 'private') {
          senderInfo = `<div class="message-sender">${messageData.sender.userType}_${messageData.sender.userId}</div>`;
        }

        messageDiv.innerHTML = `
          ${senderInfo}
          <div class="message-content">${this.escapeHtml(messageData.content)}</div>
          <div class="message-time">${new Date(messageData.timestamp).toLocaleTimeString('zh-TW')}</div>
        `;

        this.chatMessages.appendChild(messageDiv);
        this.scrollToBottom();
      }

      addSystemMessage(message) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message system';
        messageDiv.innerHTML = `
          <div class="message-content">${this.escapeHtml(message)}</div>
          <div class="message-time">${new Date().toLocaleTimeString('zh-TW')}</div>
        `;
        this.chatMessages.appendChild(messageDiv);
        this.scrollToBottom();
      }

      incrementUnreadCount(room) {
        const current = this.unreadCounts.get(room) || 0;
        this.unreadCounts.set(room, current + 1);
        this.updateUnreadBadge(room);
      }

      clearUnreadCount(room) {
        this.unreadCounts.set(room, 0);
        this.updateUnreadBadge(room);
      }

      updateUnreadBadge(room) {
        const badge = document.getElementById(`badge_${room}`);
        const count = this.unreadCounts.get(room) || 0;
        
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline';
        } else {
          badge.style.display = 'none';
        }
      }

      initializeLocationTracking() {
        if (!navigator.geolocation) {
          this.locationStatus.textContent = 'ç€è¦½å™¨ä¸æ”¯æ´ä½ç½®æœå‹™';
          this.toggleLocationBtn.disabled = true;
          return;
        }
      }

      toggleLocationTracking() {
        if (this.isLocationTracking) {
          this.stopLocationTracking();
        } else {
          this.startLocationTracking();
        }
      }

      startLocationTracking() {
        const options = {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 30000
        };

        this.locationWatcher = navigator.geolocation.watchPosition(
          (position) => {
            const { latitude, longitude, accuracy, speed } = position.coords;
            
            // æ›´æ–°é¡¯ç¤º
            this.coordinatesDisplay.textContent = `åº§æ¨™: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            this.accuracyDisplay.textContent = `ç²¾åº¦: ${Math.round(accuracy)}m`;
            this.locationInfo.style.display = 'block';
            
            // ç™¼é€ä½ç½®æ›´æ–°
            this.wsClient.updateDriverLocation(latitude, longitude, accuracy, speed);
          },
          (error) => {
            console.error('ä½ç½®è¿½è¹¤éŒ¯èª¤:', error);
            this.locationStatus.textContent = 'ä½ç½®è¿½è¹¤å¤±æ•—';
          },
          options
        );

        this.isLocationTracking = true;
        this.locationStatus.textContent = 'è¿½è¹¤ä¸­';
        this.toggleLocationBtn.textContent = 'åœæ­¢ä½ç½®è¿½è¹¤';
        this.toggleLocationBtn.className = 'btn btn-danger';
      }

      stopLocationTracking() {
        if (this.locationWatcher) {
          navigator.geolocation.clearWatch(this.locationWatcher);
          this.locationWatcher = null;
        }

        this.isLocationTracking = false;
        this.locationStatus.textContent = 'å·²åœæ­¢';
        this.toggleLocationBtn.textContent = 'å•Ÿç”¨ä½ç½®è¿½è¹¤';
        this.toggleLocationBtn.className = 'btn btn-primary';
        this.locationInfo.style.display = 'none';
      }

      scrollToBottom() {
        this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
      }

      escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }
    }

    // åˆå§‹åŒ–æ‡‰ç”¨
    document.addEventListener('DOMContentLoaded', () => {
      new DriverChatApp();
    });
  </script>
</body>
</html>