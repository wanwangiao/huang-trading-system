<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>網站基本設定 - 誠意鮮蔬後台</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Microsoft YaHei', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }
    
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 20px 0;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }
    
    h1 {
      text-align: center;
      color: #4a5568;
      font-size: 2.5em;
      margin-bottom: 10px;
    }
    
    .subtitle {
      text-align: center;
      color: #718096;
      font-size: 1.1em;
      margin-bottom: 20px;
    }
    
    .section {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
    }
    
    .section h2 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 1.8em;
      border-bottom: 3px solid #4299e1;
      padding-bottom: 10px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.full-width {
      grid-column: span 2;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #4a5568;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #4299e1;
    }
    
    .form-control textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .file-upload-area {
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: rgba(247, 250, 252, 0.5);
    }
    
    .file-upload-area:hover {
      border-color: #4299e1;
      background: rgba(66, 153, 225, 0.05);
    }
    
    .file-upload-area.dragover {
      border-color: #38a169;
      background: rgba(56, 161, 105, 0.1);
    }
    
    .upload-icon {
      font-size: 3em;
      color: #cbd5e0;
      margin-bottom: 10px;
    }
    
    .upload-text {
      color: #718096;
      margin-bottom: 10px;
    }
    
    .current-image {
      margin-top: 15px;
      text-align: center;
    }
    
    .current-image img {
      max-width: 300px;
      max-height: 150px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .hours-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .day-hours {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
    }
    
    .day-name {
      font-weight: bold;
      color: #2d3748;
      margin-bottom: 10px;
    }
    
    .time-inputs {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .time-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 0.9em;
    }
    
    .closed-checkbox {
      display: flex;
      align-items: center;
      gap: 5px;
      margin-top: 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      transition: all 0.3s ease;
      margin: 5px;
    }
    
    .btn-primary { background: #4299e1; color: white; }
    .btn-success { background: #38a169; color: white; }
    .btn-warning { background: #d69e2e; color: white; }
    .btn-secondary { background: #718096; color: white; }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .current-settings {
      background: #e6fffa;
      border: 1px solid #38b2ac;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .current-settings h3 {
      color: #234e52;
      margin-bottom: 15px;
    }
    
    .setting-item {
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .setting-label {
      font-weight: 500;
      color: #2d3748;
    }
    
    .setting-value {
      color: #4a5568;
    }
    
    /* 📱 手機端響應式優化 */
    @media (max-width: 768px) {
      .container {
        padding: 0 15px;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .section {
        padding: 20px 15px;
        margin-bottom: 20px;
        border-radius: 12px;
      }
      
      .section h2 {
        font-size: 1.5em;
      }
      
      .form-row {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .hours-grid {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .day-hours {
        padding: 12px;
      }
      
      .time-inputs {
        gap: 8px;
      }
      
      .time-input {
        padding: 6px;
        font-size: 0.85em;
      }
      
      .btn {
        padding: 10px 20px;
        font-size: 0.9em;
        margin: 3px;
      }
      
      .file-upload-area {
        padding: 20px;
      }
      
      .upload-icon {
        font-size: 2.5em;
      }
      
      .current-image img {
        max-width: 250px;
        max-height: 125px;
      }
    }
    
    @media (max-width: 480px) {
      .container {
        padding: 0 10px;
      }
      
      h1 {
        font-size: 1.8em;
      }
      
      .section {
        padding: 15px 10px;
      }
      
      .section h2 {
        font-size: 1.3em;
      }
      
      .btn {
        width: 100%;
        margin: 2px 0;
      }
      
      .setting-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="container">
      <h1>⚙️ 網站基本設定</h1>
      <p class="subtitle">設定網站名稱、說明、首頁橫排圖檔和營業時間</p>
    </div>
  </div>

  <div class="container">
    <!-- 目前設定狀況 -->
    <div class="section">
      <h2>📋 目前設定狀況</h2>
      <div class="current-settings" id="currentSettings">
        <h3>載入中...</h3>
      </div>
    </div>

    <!-- 網站基本資訊 -->
    <div class="section">
      <h2>🏪 網站基本資訊</h2>
      
      <form id="basicInfoForm">
        <div class="form-row">
          <div class="form-group">
            <label>網站名稱：</label>
            <input type="text" id="siteName" class="form-control" 
                   placeholder="例如：誠意鮮蔬" required>
          </div>
          
          <div class="form-group">
            <label>聯絡電話：</label>
            <input type="tel" id="contactPhone" class="form-control" 
                   placeholder="例如：02-1234-5678">
          </div>
        </div>
        
        <div class="form-group full-width">
          <label>網站說明：</label>
          <textarea id="siteDescription" class="form-control" rows="3"
                    placeholder="例如：新鮮蔬果外送服務，當日現採配送到府"></textarea>
        </div>
        
        <div class="form-group full-width">
          <label>服務地區：</label>
          <input type="text" id="serviceArea" class="form-control" 
                 placeholder="例如：三峽、北大特區、鶯歌、樹林、土城">
        </div>
        
        <button type="submit" class="btn btn-success">💾 儲存基本資訊</button>
      </form>
    </div>

    <!-- 首頁橫排圖檔設定 -->
    <div class="section">
      <h2>🖼️ 首頁橫排圖檔</h2>
      
      <div class="form-group">
        <label>上傳橫排圖檔：</label>
        <div class="file-upload-area" id="bannerUploadArea">
          <div class="upload-icon">📷</div>
          <div class="upload-text">
            <strong>點擊選擇檔案</strong> 或拖放圖檔到此區域<br>
            <small>建議尺寸：1200x300px，支援 JPG、PNG 格式</small>
          </div>
          <input type="file" id="bannerFile" accept="image/*" style="display: none;">
        </div>
        
        <div class="current-image" id="currentBannerImage">
          <!-- 動態顯示目前的橫排圖檔 -->
        </div>
      </div>
      
      <button type="button" class="btn btn-primary" onclick="uploadBannerImage()">🚀 上傳圖檔</button>
      <button type="button" class="btn btn-warning" onclick="removeBannerImage()">🗑️ 移除圖檔</button>
    </div>

    <!-- 營業時間設定 -->
    <div class="section">
      <h2>🕐 營業時間設定</h2>
      
      <form id="businessHoursForm">
        <div class="hours-grid">
          <div class="day-hours">
            <div class="day-name">星期一</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="monday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="monday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="monday_closed" id="monday_closed">
              <label for="monday_closed">公休</label>
            </div>
          </div>
          
          <div class="day-hours">
            <div class="day-name">星期二</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="tuesday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="tuesday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="tuesday_closed" id="tuesday_closed">
              <label for="tuesday_closed">公休</label>
            </div>
          </div>
          
          <div class="day-hours">
            <div class="day-name">星期三</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="wednesday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="wednesday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="wednesday_closed" id="wednesday_closed">
              <label for="wednesday_closed">公休</label>
            </div>
          </div>
          
          <div class="day-hours">
            <div class="day-name">星期四</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="thursday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="thursday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="thursday_closed" id="thursday_closed">
              <label for="thursday_closed">公休</label>
            </div>
          </div>
          
          <div class="day-hours">
            <div class="day-name">星期五</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="friday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="friday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="friday_closed" id="friday_closed">
              <label for="friday_closed">公休</label>
            </div>
          </div>
          
          <div class="day-hours">
            <div class="day-name">星期六</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="saturday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="saturday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="saturday_closed" id="saturday_closed">
              <label for="saturday_closed">公休</label>
            </div>
          </div>
          
          <div class="day-hours">
            <div class="day-name">星期日</div>
            <div class="time-inputs">
              <input type="time" class="time-input" name="sunday_open" value="06:00">
              <span>-</span>
              <input type="time" class="time-input" name="sunday_close" value="13:00">
            </div>
            <div class="closed-checkbox">
              <input type="checkbox" name="sunday_closed" id="sunday_closed" checked>
              <label for="sunday_closed">公休</label>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <button type="submit" class="btn btn-success">💾 儲存營業時間</button>
          <button type="button" class="btn btn-warning" onclick="resetBusinessHours()">🔄 重置為預設</button>
        </div>
      </form>
    </div>

    <!-- 返回按鈕 -->
    <div class="section">
      <a href="/admin/dashboard" class="btn btn-secondary">← 返回後台主頁</a>
      <a href="/admin/order-management" class="btn btn-primary">📋 訂單管理</a>
      <a href="/admin/bank-settings" class="btn btn-primary">🏦 銀行設定</a>
    </div>
  </div>

  <script>
    let currentBannerFile = null;

    // 頁面載入時初始化
    document.addEventListener('DOMContentLoaded', function() {
      loadCurrentSettings();
      setupFileUpload();
      setupBusinessHourHandlers();
    });

    // 載入目前設定
    async function loadCurrentSettings() {
      try {
        const response = await fetch('/api/admin/site-settings');
        const data = await response.json();
        
        const container = document.getElementById('currentSettings');
        
        if (data.success) {
          const settings = data.settings;
          
          container.innerHTML = `
            <h3>📊 目前設定總覽</h3>
            <div class="setting-item">
              <span class="setting-label">網站名稱：</span>
              <span class="setting-value">${settings.siteName || '未設定'}</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">聯絡電話：</span>
              <span class="setting-value">${settings.contactPhone || '未設定'}</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">服務地區：</span>
              <span class="setting-value">${settings.serviceArea || '未設定'}</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">橫排圖檔：</span>
              <span class="setting-value">${settings.bannerImage ? '已設定' : '未設定'}</span>
            </div>
            <div class="setting-item">
              <span class="setting-label">營業時間：</span>
              <span class="setting-value">${settings.businessHours ? '已設定' : '使用預設'}</span>
            </div>
          `;
          
          // 填充表單
          if (settings.siteName) document.getElementById('siteName').value = settings.siteName;
          if (settings.contactPhone) document.getElementById('contactPhone').value = settings.contactPhone;
          if (settings.siteDescription) document.getElementById('siteDescription').value = settings.siteDescription;
          if (settings.serviceArea) document.getElementById('serviceArea').value = settings.serviceArea;
          
          // 顯示目前橫排圖檔
          if (settings.bannerImage) {
            document.getElementById('currentBannerImage').innerHTML = `
              <p style="margin-bottom: 10px; color: #38a169; font-weight: bold;">目前橫排圖檔：</p>
              <img src="${settings.bannerImage}" alt="目前橫排圖檔">
            `;
          }
          
          // 載入營業時間
          if (settings.businessHours) {
            loadBusinessHours(settings.businessHours);
          }
          
        } else {
          container.innerHTML = `
            <h3>⚠️ 載入設定失敗</h3>
            <p>請重新整理頁面或檢查網路連線</p>
          `;
        }
      } catch (error) {
        console.error('載入設定失敗:', error);
        document.getElementById('currentSettings').innerHTML = `
          <h3>❌ 載入錯誤</h3>
          <p>無法載入目前設定，請稍後再試</p>
        `;
      }
    }

    // 設定檔案上傳
    function setupFileUpload() {
      const uploadArea = document.getElementById('bannerUploadArea');
      const fileInput = document.getElementById('bannerFile');
      
      uploadArea.addEventListener('click', () => fileInput.click());
      
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
          handleFileSelect(files[0]);
        }
      });
      
      fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e.target.files[0]);
        }
      });
    }

    // 處理檔案選擇
    function handleFileSelect(file) {
      if (!file.type.startsWith('image/')) {
        alert('請選擇圖片檔案');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        alert('檔案大小不能超過 5MB');
        return;
      }
      
      currentBannerFile = file;
      
      // 預覽圖片
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('currentBannerImage').innerHTML = `
          <p style="margin-bottom: 10px; color: #d69e2e; font-weight: bold;">預覽新圖檔（尚未儲存）：</p>
          <img src="${e.target.result}" alt="預覽圖檔">
        `;
      };
      reader.readAsDataURL(file);
    }

    // 上傳橫排圖檔
    async function uploadBannerImage() {
      if (!currentBannerFile) {
        alert('請先選擇圖檔');
        return;
      }
      
      const formData = new FormData();
      formData.append('banner', currentBannerFile);
      
      try {
        const response = await fetch('/api/admin/upload-banner', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✅ 橫排圖檔上傳成功！');
          loadCurrentSettings();
          currentBannerFile = null;
        } else {
          alert('❌ 上傳失敗：' + result.message);
        }
      } catch (error) {
        alert('❌ 上傳時發生錯誤');
        console.error(error);
      }
    }

    // 移除橫排圖檔
    async function removeBannerImage() {
      if (!confirm('確定要移除橫排圖檔嗎？')) {
        return;
      }
      
      try {
        const response = await fetch('/api/admin/remove-banner', {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✅ 橫排圖檔已移除');
          loadCurrentSettings();
        } else {
          alert('❌ 移除失敗：' + result.message);
        }
      } catch (error) {
        alert('❌ 移除時發生錯誤');
        console.error(error);
      }
    }

    // 儲存基本資訊
    document.getElementById('basicInfoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = {
        siteName: document.getElementById('siteName').value,
        contactPhone: document.getElementById('contactPhone').value,
        siteDescription: document.getElementById('siteDescription').value,
        serviceArea: document.getElementById('serviceArea').value
      };
      
      try {
        const response = await fetch('/api/admin/site-settings/basic', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✅ 基本資訊儲存成功！');
          loadCurrentSettings();
        } else {
          alert('❌ 儲存失敗：' + result.message);
        }
      } catch (error) {
        alert('❌ 儲存時發生錯誤');
        console.error(error);
      }
    });

    // 設定營業時間處理
    function setupBusinessHourHandlers() {
      const checkboxes = document.querySelectorAll('input[type="checkbox"][name$="_closed"]');
      
      checkboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const day = this.name.replace('_closed', '');
          const openInput = document.querySelector(`input[name="${day}_open"]`);
          const closeInput = document.querySelector(`input[name="${day}_close"]`);
          
          if (this.checked) {
            openInput.disabled = true;
            closeInput.disabled = true;
            openInput.style.opacity = '0.5';
            closeInput.style.opacity = '0.5';
          } else {
            openInput.disabled = false;
            closeInput.disabled = false;
            openInput.style.opacity = '1';
            closeInput.style.opacity = '1';
          }
        });
        
        // 初始化狀態
        checkbox.dispatchEvent(new Event('change'));
      });
    }

    // 載入營業時間到表單
    function loadBusinessHours(businessHours) {
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      
      days.forEach(day => {
        const dayData = businessHours[day];
        if (dayData) {
          document.querySelector(`input[name="${day}_open"]`).value = dayData.open || '06:00';
          document.querySelector(`input[name="${day}_close"]`).value = dayData.close || '13:00';
          document.querySelector(`input[name="${day}_closed"]`).checked = dayData.closed || false;
        }
      });
      
      // 重新觸發change事件以更新UI狀態
      setupBusinessHourHandlers();
    }

    // 儲存營業時間
    document.getElementById('businessHoursForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
      const businessHours = {};
      
      days.forEach(day => {
        businessHours[day] = {
          open: document.querySelector(`input[name="${day}_open"]`).value,
          close: document.querySelector(`input[name="${day}_close"]`).value,
          closed: document.querySelector(`input[name="${day}_closed"]`).checked
        };
      });
      
      try {
        const response = await fetch('/api/admin/site-settings/hours', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ businessHours })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('✅ 營業時間儲存成功！');
          loadCurrentSettings();
        } else {
          alert('❌ 儲存失敗：' + result.message);
        }
      } catch (error) {
        alert('❌ 儲存時發生錯誤');
        console.error(error);
      }
    });

    // 重置營業時間為預設
    function resetBusinessHours() {
      if (!confirm('確定要重置營業時間為預設設定嗎？')) {
        return;
      }
      
      const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
      
      days.forEach(day => {
        document.querySelector(`input[name="${day}_open"]`).value = '06:00';
        document.querySelector(`input[name="${day}_close"]`).value = '13:00';
        document.querySelector(`input[name="${day}_closed"]`).checked = false;
      });
      
      // 星期日設為公休
      document.querySelector('input[name="sunday_open"]').value = '06:00';
      document.querySelector('input[name="sunday_close"]').value = '13:00';
      document.querySelector('input[name="sunday_closed"]').checked = true;
      
      setupBusinessHourHandlers();
      
      alert('✅ 營業時間已重置為預設設定');
    }
  </script>
</body>
</html>