<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤–é€å“¡å·¥ä½œå° - èª æ„é®®è”¬</title>
    <link rel="stylesheet" href="/css/driver-portal.css">
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <header class="driver-header">
        <div class="header-content">
            <div class="driver-info">
                <h1>ğŸƒ èª æ„é®®è”¬</h1>
                <p>å¤–é€å“¡ï¼š<%= driver.name %></p>
            </div>
            <div class="header-actions">
                <span class="status online">ğŸŸ¢ ä¸Šç·šä¸­</span>
                <a href="/driver/logout" class="logout-btn">ç™»å‡º</a>
            </div>
        </div>
    </header>

    <!-- ä¸»è¦å…§å®¹ -->
    <main class="driver-main">
        <!-- å¿«é€Ÿçµ±è¨ˆ -->
        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“¦</div>
                <div class="stat-content">
                    <h3>ä»Šæ—¥å®Œæˆ</h3>
                    <p class="stat-number" id="today-completed">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸš›</div>
                <div class="stat-content">
                    <h3>é€²è¡Œä¸­</h3>
                    <p class="stat-number" id="ongoing-deliveries">0</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’°</div>
                <div class="stat-content">
                    <h3>ä»Šæ—¥æ”¶å…¥</h3>
                    <p class="stat-number" id="today-earnings">$0</p>
                </div>
            </div>
        </div>

        <!-- æ¨™ç±¤åˆ‡æ› -->
        <div class="tabs-section">
            <div class="tabs">
                <button class="tab active" data-tab="available">
                    ğŸ“¦ å¯æ¥è¨‚å–® <span class="badge" id="available-count">0</span>
                </button>
                <button class="tab" data-tab="my-orders">
                    ğŸš› æˆ‘çš„é…é€ <span class="badge" id="my-orders-count">0</span>
                </button>
                <button class="tab" data-tab="completed">
                    âœ… å·²å®Œæˆ <span class="badge" id="completed-count">0</span>
                </button>
            </div>
        </div>

        <!-- å¯æ¥è¨‚å–®åˆ—è¡¨ -->
        <div class="tab-content active" id="available-tab">
            <div class="section-header">
                <h2>ğŸ“¦ å¯æ¥è¨‚å–®</h2>
                <div class="header-actions">
                    <button class="batch-select-btn" onclick="showBatchRecommendation()">ğŸ¯ æ™ºèƒ½æ‰¹æ¬¡æ¨è–¦</button>
                    <button class="refresh-btn" onclick="refreshAvailableOrders()">ğŸ”„ é‡æ–°æ•´ç†</button>
                </div>
            </div>
            
            <div class="orders-list" id="available-orders">
                <!-- å‹•æ…‹è¼‰å…¥è¨‚å–® -->
            </div>
        </div>

        <!-- æˆ‘çš„é…é€åˆ—è¡¨ -->
        <div class="tab-content" id="my-orders-tab">
            <div class="section-header">
                <h2>ğŸš› æˆ‘çš„é…é€</h2>
            </div>
            
            <div class="orders-list" id="my-orders">
                <!-- å‹•æ…‹è¼‰å…¥æˆ‘çš„è¨‚å–® -->
            </div>
        </div>

        <!-- å·²å®Œæˆåˆ—è¡¨ -->
        <div class="tab-content" id="completed-tab">
            <div class="section-header">
                <h2>âœ… ä»Šæ—¥å·²å®Œæˆ</h2>
            </div>
            
            <div class="orders-list" id="completed-orders">
                <!-- å‹•æ…‹è¼‰å…¥å·²å®Œæˆè¨‚å–® -->
            </div>
        </div>
    </main>

    <!-- è¨‚å–®è©³æƒ…å½ˆçª— -->
    <div class="modal" id="order-detail-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ“¦ è¨‚å–®è©³æƒ…</h3>
                <button class="modal-close" onclick="closeOrderModal()">&times;</button>
            </div>
            <div class="modal-body" id="order-detail-content">
                <!-- å‹•æ…‹è¼‰å…¥è¨‚å–®è©³æƒ… -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeOrderModal()">é—œé–‰</button>
                <button class="btn-primary" id="modal-action-btn" onclick="handleOrderAction()">æ¥å–è¨‚å–®</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        const driverId = <%= driver.id %>;
        let currentOrderId = null;
        let currentAction = null;

        // é é¢è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            initDriverDashboard();
            loadAvailableOrders();
            loadMyOrders();
            loadCompletedOrders();
            updateStats();
            
            // æ¯30ç§’è‡ªå‹•æ›´æ–°
            setInterval(function() {
                loadAvailableOrders();
                updateStats();
            }, 30000);
        });

        // åˆå§‹åŒ–å„€è¡¨æ¿
        function initDriverDashboard() {
            // æ¨™ç±¤åˆ‡æ›åŠŸèƒ½
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    switchTab(tabName);
                });
            });
        }

        // åˆ‡æ›æ¨™ç±¤
        function switchTab(tabName) {
            // ç§»é™¤æ‰€æœ‰activeé¡
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            // æ·»åŠ activeåˆ°é¸ä¸­çš„æ¨™ç±¤
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        // æ™ºèƒ½è·¯ç·šæ¨è–¦ç®—æ³• - æ‰¹æ¬¡é…é€å„ªåŒ–ï¼ˆæœ€å¤š15ç­†ï¼‰
        function smartRouteRecommendation(orders) {
            // å€åŸŸé…é€æ•ˆç‡åˆ†æ
            const areaEfficiency = {
                'ä¸‰å³½å€': { 
                    priority: 1, 
                    avgTime: 8,      // å¹³å‡æ¯ç­†8åˆ†é˜
                    capacity: 5,     // å»ºè­°åŒå€åŸŸæœ€å¤š5ç­†
                    efficiency: 10   // æ•ˆç‡è©•åˆ†
                },
                'åŒ—å¤§ç‰¹å€': { 
                    priority: 2, 
                    avgTime: 12, 
                    capacity: 4, 
                    efficiency: 8 
                },
                'æ¨¹æ—å€': { 
                    priority: 3, 
                    avgTime: 15, 
                    capacity: 3, 
                    efficiency: 6 
                },
                'é¶¯æ­Œå€': { 
                    priority: 4, 
                    avgTime: 18, 
                    capacity: 2, 
                    efficiency: 4 
                },
                'åœŸåŸå€': { 
                    priority: 5, 
                    avgTime: 22, 
                    capacity: 2, 
                    efficiency: 3 
                }
            };
            
            // æŒ‰å€åŸŸåˆ†çµ„çµ±è¨ˆ
            const areaGroups = {};
            orders.forEach(order => {
                const area = getAreaFromAddress(order.address);
                if (!areaGroups[area]) {
                    areaGroups[area] = [];
                }
                areaGroups[area].push(order);
            });
            
            // ç‚ºæ¯å€‹è¨‚å–®è¨ˆç®—ç¶œåˆæ¨è–¦åˆ†æ•¸
            orders.forEach(order => {
                const area = getAreaFromAddress(order.address);
                const areaInfo = areaEfficiency[area] || { priority: 6, avgTime: 25, capacity: 1, efficiency: 2 };
                const areaOrderCount = areaGroups[area].length;
                
                // æ™‚é–“å› ç´ è¨ˆç®—
                const waitTime = (Date.now() - new Date(order.packed_at).getTime()) / (1000 * 60); // åˆ†é˜
                const urgencyScore = Math.min(waitTime / 15, 8); // 15åˆ†é˜å¾Œé–‹å§‹ç·Šæ€¥
                
                // é‡‘é¡æ•ˆç‡è¨ˆç®—
                const valueEfficiency = order.total / areaInfo.avgTime; // æ¯åˆ†é˜æ”¶ç›Š
                
                // æ‰¹æ¬¡æ•ˆç‡çå‹µ
                const batchBonus = Math.min(areaOrderCount, areaInfo.capacity) * 2;
                
                // ç¸½æ•ˆç‡åˆ†æ•¸è¨ˆç®—
                order.recommendScore = (
                    areaInfo.efficiency * 2 +           // å€åŸŸåŸºç¤æ•ˆç‡ (20åˆ†)
                    urgencyScore +                      // ç­‰å¾…ç·Šæ€¥åº¦ (8åˆ†)
                    Math.min(valueEfficiency / 10, 5) + // åƒ¹å€¼æ•ˆç‡ (5åˆ†)
                    batchBonus                          // æ‰¹æ¬¡çå‹µ (10åˆ†)
                );
                
                // ç”Ÿæˆæ™ºèƒ½æ¨è–¦åŸå› 
                order.recommendReason = generateRecommendReason(order, area, areaInfo, areaOrderCount, waitTime, valueEfficiency);
                order.batchInfo = `${area} (${areaOrderCount}ç­†)`;
                order.estimatedTime = areaInfo.avgTime;
            });
            
            // æ™ºèƒ½æ’åºï¼šå„ªå…ˆæ¨è–¦èƒ½å½¢æˆé«˜æ•ˆæ‰¹æ¬¡çš„è¨‚å–®
            return optimizeBatchDelivery(orders, areaEfficiency);
        }
        
        // ç”Ÿæˆæ¨è–¦åŸå› 
        function generateRecommendReason(order, area, areaInfo, areaCount, waitTime, valueEfficiency) {
            let reasons = [];
            
            // æ•ˆç‡åŸå› 
            if (areaInfo.efficiency >= 8) {
                reasons.push(`${area}é«˜æ•ˆå€åŸŸ`);
            } else if (areaInfo.efficiency >= 5) {
                reasons.push(`${area}ä¸­æ•ˆå€åŸŸ`);
            } else {
                reasons.push(`${area}é ç¨‹é…é€`);
            }
            
            // æ‰¹æ¬¡åŸå› 
            if (areaCount >= 3) {
                reasons.push(`å¯æ‰¹æ¬¡é…é€${areaCount}ç­†`);
            } else if (areaCount === 2) {
                reasons.push(`å¯æ­é…åŒå€1ç­†`);
            }
            
            // ç·Šæ€¥åŸå› 
            if (waitTime > 45) {
                reasons.push(`åŒ…è£è¶…é45åˆ†é˜ï¼Œæ€¥éœ€é…é€`);
            } else if (waitTime > 30) {
                reasons.push(`åŒ…è£å·²ä¹…ï¼Œå»ºè­°å„ªå…ˆ`);
            }
            
            // åƒ¹å€¼åŸå› 
            if (valueEfficiency > 20) {
                reasons.push(`é«˜æ”¶ç›Šè¨‚å–®`);
            } else if (order.total > 300) {
                reasons.push(`é«˜åƒ¹å€¼è¨‚å–®`);
            }
            
            // æ™‚é–“æ•ˆç‡
            if (areaInfo.avgTime <= 10) {
                reasons.push(`é è¨ˆ${areaInfo.avgTime}åˆ†é˜å®Œæˆ`);
            }
            
            return reasons.slice(0, 3).join('ï¼Œ'); // æœ€å¤šé¡¯ç¤º3å€‹åŸå› 
        }
        
        // æ‰¹æ¬¡é…é€å„ªåŒ–ç®—æ³•
        function optimizeBatchDelivery(orders, areaEfficiency) {
            const result = [];
            const processedAreas = new Set();
            
            // æŒ‰å€åŸŸæ•ˆç‡æ’åºæ‰€æœ‰å€åŸŸ
            const areasByEfficiency = Object.entries(areaEfficiency)
                .sort((a, b) => b[1].efficiency - a[1].efficiency)
                .map(([area]) => area);
            
            // å„ªå…ˆè™•ç†é«˜æ•ˆå€åŸŸçš„æ‰¹æ¬¡
            areasByEfficiency.forEach(area => {
                if (processedAreas.has(area)) return;
                
                const areaOrders = orders.filter(order => 
                    getAreaFromAddress(order.address) === area
                );
                
                if (areaOrders.length > 0) {
                    // åŒå€åŸŸå…§æŒ‰åˆ†æ•¸æ’åº
                    areaOrders.sort((a, b) => b.recommendScore - a.recommendScore);
                    
                    // æ·»åŠ æ‰¹æ¬¡æ¨™è¨˜
                    areaOrders.forEach((order, index) => {
                        if (index === 0 && areaOrders.length >= 2) {
                            order.batchLeader = true;
                            order.batchSize = areaOrders.length;
                        }
                    });
                    
                    result.push(...areaOrders);
                    processedAreas.add(area);
                }
            });
            
            // æ·»åŠ å‰©é¤˜è¨‚å–®
            const remainingOrders = orders.filter(order => 
                !processedAreas.has(getAreaFromAddress(order.address))
            );
            result.push(...remainingOrders.sort((a, b) => b.recommendScore - a.recommendScore));
            
            return result;
        }

        // è¼‰å…¥å¯æ¥è¨‚å–®
        async function loadAvailableOrders() {
            try {
                const response = await fetch('/api/driver/available-orders');
                const data = await response.json();
                
                const container = document.getElementById('available-orders');
                const countBadge = document.getElementById('available-count');
                
                countBadge.textContent = data.orders.length;
                
                if (data.orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“­</div>
                            <p>ç›®å‰æ²’æœ‰å¯æ¥çš„è¨‚å–®</p>
                            <button onclick="refreshAvailableOrders()" class="refresh-btn">ğŸ”„ é‡æ–°æ•´ç†</button>
                        </div>
                    `;
                } else {
                    // æ™ºèƒ½è·¯ç·šæ¨è–¦æ’åº
                    const sortedOrders = smartRouteRecommendation(data.orders);
                    
                    container.innerHTML = sortedOrders.map((order, index) => `
                        <div class="order-card available ${index === 0 ? 'recommended' : ''} ${order.batchLeader ? 'batch-leader' : ''}" onclick="showOrderDetail(${order.id}, 'take')">
                            ${index === 0 ? '<div class="recommend-badge">ğŸ¯ æ¨è–¦å„ªå…ˆ</div>' : ''}
                            ${order.batchLeader ? `<div class="batch-badge">ğŸ“¦ æ‰¹æ¬¡é…é€ ${order.batchSize}ç­†</div>` : ''}
                            <div class="order-header">
                                <span class="order-number">#${order.id}</span>
                                <span class="order-area">${getAreaFromAddress(order.address)}</span>
                                <span class="order-amount">$${order.total}</span>
                            </div>
                            <div class="order-customer">
                                <span class="customer-name">ğŸ‘¤ ${order.customer_name}</span>
                                <span class="customer-phone">ğŸ“ ${order.customer_phone}</span>
                            </div>
                            <div class="order-address">
                                ğŸ“ ${order.address}
                            </div>
                            <div class="order-items">
                                ${order.items.map(item => `
                                    <span class="item">${item.product_name} x${item.quantity}</span>
                                `).join(', ')}
                            </div>
                            ${order.recommendReason ? `<div class="recommend-reason">ğŸ’¡ ${order.recommendReason}</div>` : ''}
                            <div class="order-efficiency">
                                <span class="batch-info">ğŸ¯ ${order.batchInfo}</span>
                                <span class="time-estimate">â±ï¸ é è¨ˆ${order.estimatedTime}åˆ†é˜</span>
                                <span class="efficiency-score">ğŸ† æ•ˆç‡åˆ†æ•¸: ${Math.round(order.recommendScore)}</span>
                            </div>
                            <div class="order-footer">
                                <span class="delivery-fee">é…é€è²»: $${order.delivery_fee || 0}</span>
                                <span class="packed-time">åŒ…è£å®Œæˆ: ${formatTime(order.packed_at)}</span>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥å¯æ¥è¨‚å–®å¤±æ•—:', error);
                showNotification('è¼‰å…¥è¨‚å–®å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†', 'error');
            }
        }

        // è¼‰å…¥æˆ‘çš„é…é€è¨‚å–®
        async function loadMyOrders() {
            try {
                const response = await fetch('/api/driver/my-orders');
                const data = await response.json();
                
                const container = document.getElementById('my-orders');
                const countBadge = document.getElementById('my-orders-count');
                
                countBadge.textContent = data.orders.length;
                document.getElementById('ongoing-deliveries').textContent = data.orders.length;
                
                if (data.orders.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸš›</div>
                            <p>ç›®å‰æ²’æœ‰é…é€ä¸­çš„è¨‚å–®</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.orders.map(order => `
                        <div class="order-card my-order" onclick="showOrderDetail(${order.id}, 'complete')">
                            <div class="order-header">
                                <span class="order-number">#${order.id}</span>
                                <span class="order-status delivering">ğŸš› é…é€ä¸­</span>
                                <span class="order-amount">$${order.total}</span>
                            </div>
                            <div class="order-customer">
                                <span class="customer-name">ğŸ‘¤ ${order.customer_name}</span>
                                <span class="customer-phone">ğŸ“ ${order.customer_phone}</span>
                            </div>
                            <div class="order-address">
                                ğŸ“ ${order.address}
                            </div>
                            <div class="order-footer">
                                <span class="taken-time">æ¥å–®æ™‚é–“: ${formatTime(order.taken_at)}</span>
                                <button class="complete-btn" onclick="completeOrder(${order.id}); event.stopPropagation();">
                                    âœ… å®Œæˆé…é€
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('è¼‰å…¥æˆ‘çš„è¨‚å–®å¤±æ•—:', error);
            }
        }

        // è¼‰å…¥å·²å®Œæˆè¨‚å–®
        async function loadCompletedOrders() {
            try {
                const response = await fetch('/api/driver/completed-orders');
                const data = await response.json();
                
                const container = document.getElementById('completed-orders');
                const countBadge = document.getElementById('completed-count');
                
                countBadge.textContent = data.orders.length;
                document.getElementById('today-completed').textContent = data.orders.length;
                
                container.innerHTML = data.orders.map(order => `
                    <div class="order-card completed">
                        <div class="order-header">
                            <span class="order-number">#${order.id}</span>
                            <span class="order-status completed">âœ… å·²å®Œæˆ</span>
                            <span class="order-amount">$${order.total}</span>
                        </div>
                        <div class="order-customer">
                            <span class="customer-name">ğŸ‘¤ ${order.customer_name}</span>
                        </div>
                        <div class="order-footer">
                            <span class="completed-time">å®Œæˆæ™‚é–“: ${formatTime(order.completed_at)}</span>
                            <span class="earning">+$${order.delivery_fee || 50}</span>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('è¼‰å…¥å·²å®Œæˆè¨‚å–®å¤±æ•—:', error);
            }
        }

        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        async function updateStats() {
            try {
                const response = await fetch('/api/driver/stats');
                const data = await response.json();
                
                document.getElementById('today-earnings').textContent = '$' + data.todayEarnings;
            } catch (error) {
                console.error('æ›´æ–°çµ±è¨ˆå¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºè¨‚å–®è©³æƒ…
        async function showOrderDetail(orderId, action) {
            try {
                const response = await fetch(`/api/driver/order/${orderId}`);
                const order = await response.json();
                
                currentOrderId = orderId;
                currentAction = action;
                
                const content = document.getElementById('order-detail-content');
                const actionBtn = document.getElementById('modal-action-btn');
                
                content.innerHTML = `
                    <div class="order-detail">
                        <div class="detail-section">
                            <h4>ğŸ“¦ è¨‚å–®è³‡è¨Š</h4>
                            <p><strong>è¨‚å–®ç·¨è™Ÿ:</strong> #${order.id}</p>
                            <p><strong>ä¸‹å–®æ™‚é–“:</strong> ${formatTime(order.created_at)}</p>
                            <p><strong>è¨‚å–®é‡‘é¡:</strong> $${order.total}</p>
                            <p><strong>ä»˜æ¬¾æ–¹å¼:</strong> ${order.payment_method}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>ğŸ‘¤ å®¢æˆ¶è³‡è¨Š</h4>
                            <p><strong>å§“å:</strong> ${order.customer_name}</p>
                            <p><strong>é›»è©±:</strong> ${order.customer_phone}</p>
                            <p><strong>åœ°å€:</strong> ${order.address}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h4>ğŸ›’ å•†å“æ¸…å–®</h4>
                            ${order.items.map(item => `
                                <div class="item-row">
                                    <span>${item.product_name}</span>
                                    <span>x${item.quantity}</span>
                                    <span>$${item.price * item.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="detail-section">
                            <h4>ğŸ’° è²»ç”¨æ˜ç´°</h4>
                            <div class="fee-row">
                                <span>å•†å“é‡‘é¡:</span>
                                <span>$${order.subtotal}</span>
                            </div>
                            <div class="fee-row">
                                <span>é…é€è²»:</span>
                                <span>$${order.delivery_fee || 0}</span>
                            </div>
                            <div class="fee-row total">
                                <span>ç¸½é‡‘é¡:</span>
                                <span>$${order.total}</span>
                            </div>
                        </div>
                    </div>
                `;
                
                if (action === 'take') {
                    actionBtn.textContent = 'ğŸš› æ¥å–é€™å€‹è¨‚å–®';
                    actionBtn.className = 'btn-primary';
                } else if (action === 'complete') {
                    actionBtn.textContent = 'âœ… å®Œæˆé…é€';
                    actionBtn.className = 'btn-success';
                }
                
                document.getElementById('order-detail-modal').style.display = 'flex';
            } catch (error) {
                console.error('è¼‰å…¥è¨‚å–®è©³æƒ…å¤±æ•—:', error);
                showNotification('è¼‰å…¥è¨‚å–®è©³æƒ…å¤±æ•—', 'error');
            }
        }

        // è™•ç†è¨‚å–®æ“ä½œ
        async function handleOrderAction() {
            if (!currentOrderId || !currentAction) return;
            
            // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
            const confirmed = await showConfirmDialog(currentAction, currentOrderId);
            if (!confirmed) return;
            
            try {
                let response;
                if (currentAction === 'take') {
                    response = await fetch(`/api/driver/take-order/${currentOrderId}`, {
                        method: 'POST'
                    });
                } else if (currentAction === 'complete') {
                    response = await fetch(`/api/driver/complete-order/${currentOrderId}`, {
                        method: 'POST'
                    });
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification(
                        currentAction === 'take' ? 'âœ… è¨‚å–®æ¥å–æˆåŠŸï¼' : 'ğŸ‰ é…é€å®Œæˆï¼å®¢æˆ¶å·²æ”¶åˆ°é€šçŸ¥',
                        'success'
                    );
                    closeOrderModal();
                    
                    // é‡æ–°è¼‰å…¥æ‰€æœ‰è¨‚å–®åˆ—è¡¨
                    await Promise.all([
                        loadAvailableOrders(),
                        loadMyOrders(), 
                        loadCompletedOrders()
                    ]);
                    updateStats();
                } else {
                    showNotification(result.message || 'æ“ä½œå¤±æ•—', 'error');
                }
            } catch (error) {
                console.error('æ“ä½œå¤±æ•—:', error);
                showNotification('âŒ æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦', 'error');
            }
        }

        // é¡¯ç¤ºç¢ºèªå°è©±æ¡†
        function showConfirmDialog(action, orderId) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'confirm-modal';
                modal.innerHTML = `
                    <div class="confirm-content">
                        <div class="confirm-header">
                            <h3>${action === 'take' ? 'ğŸš› ç¢ºèªæ¥å–è¨‚å–®' : 'âœ… ç¢ºèªå®Œæˆé…é€'}</h3>
                        </div>
                        <div class="confirm-body">
                            <p>
                                ${action === 'take' 
                                    ? `ç¢ºå®šè¦æ¥å–è¨‚å–® #${orderId} å—ï¼Ÿ<br>æ¥å–å¾Œè¨‚å–®å°‡ç§»åˆ°ã€Œæˆ‘çš„é…é€ã€` 
                                    : `ç¢ºå®šå·²å®Œæˆè¨‚å–® #${orderId} çš„é…é€å—ï¼Ÿ<br>ç³»çµ±å°‡è‡ªå‹•ç™¼é€é€šçŸ¥çµ¦å®¢æˆ¶<br><strong>æ­¤æ“ä½œç„¡æ³•æ’¤éŠ·</strong>`
                                }
                            </p>
                        </div>
                        <div class="confirm-footer">
                            <button class="btn-secondary" onclick="closeConfirm(false)">å–æ¶ˆ</button>
                            <button class="${action === 'take' ? 'btn-primary' : 'btn-success'}" onclick="closeConfirm(true)">
                                ${action === 'take' ? 'ğŸš› ç¢ºèªæ¥å–' : 'âœ… ç¢ºèªå®Œæˆ'}
                            </button>
                        </div>
                    </div>
                `;
                
                // æ¨£å¼
                modal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.6);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 10000;
                    padding: 20px;
                `;
                
                const content = modal.querySelector('.confirm-content');
                content.style.cssText = `
                    background: white;
                    border-radius: 12px;
                    max-width: 400px;
                    width: 100%;
                    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
                    animation: confirmSlideIn 0.3s ease;
                `;
                
                // æ·»åŠ å‹•ç•«CSS
                if (!document.getElementById('confirm-animations')) {
                    const style = document.createElement('style');
                    style.id = 'confirm-animations';
                    style.textContent = `
                        @keyframes confirmSlideIn {
                            from { transform: scale(0.8); opacity: 0; }
                            to { transform: scale(1); opacity: 1; }
                        }
                        .confirm-header { padding: 20px 20px 10px; text-align: center; }
                        .confirm-header h3 { margin: 0; color: #2c3e50; }
                        .confirm-body { padding: 10px 20px 20px; text-align: center; color: #34495e; line-height: 1.5; }
                        .confirm-footer { padding: 0 20px 20px; display: flex; gap: 10px; justify-content: center; }
                        .confirm-footer button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; min-width: 80px; }
                        .btn-success { background: #27ae60; color: white; }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(modal);
                
                // é—œé–‰å‡½æ•¸
                window.closeConfirm = (result) => {
                    modal.remove();
                    delete window.closeConfirm;
                    resolve(result);
                };
            });
        }

        // å®Œæˆé…é€ (ä½¿ç”¨æ–°çš„ç¢ºèªå°è©±æ¡†)
        async function completeOrder(orderId) {
            const confirmed = await showConfirmDialog('complete', orderId);
            if (confirmed) {
                try {
                    const response = await fetch(`/api/driver/complete-order/${orderId}`, {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showNotification('ğŸ‰ é…é€å®Œæˆï¼å®¢æˆ¶å·²æ”¶åˆ°é€šçŸ¥', 'success');
                        await Promise.all([
                            loadMyOrders(),
                            loadCompletedOrders()
                        ]);
                        updateStats();
                    } else {
                        showNotification(result.message || 'æ“ä½œå¤±æ•—', 'error');
                    }
                } catch (error) {
                    console.error('å®Œæˆé…é€å¤±æ•—:', error);
                    showNotification('âŒ æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šå¾Œé‡è©¦', 'error');
                }
            }
        }

        // é—œé–‰è¨‚å–®å½ˆçª—
        function closeOrderModal() {
            document.getElementById('order-detail-modal').style.display = 'none';
            currentOrderId = null;
            currentAction = null;
        }

        // é‡æ–°æ•´ç†å¯æ¥è¨‚å–®
        function refreshAvailableOrders() {
            loadAvailableOrders();
            showNotification('è¨‚å–®åˆ—è¡¨å·²æ›´æ–°', 'info');
        }

        // æ™ºèƒ½æ‰¹æ¬¡æ¨è–¦
        async function showBatchRecommendation() {
            try {
                const response = await fetch('/api/driver/available-orders');
                const data = await response.json();
                
                if (data.orders.length === 0) {
                    showNotification('ç›®å‰æ²’æœ‰å¯æ¥çš„è¨‚å–®', 'info');
                    return;
                }
                
                const sortedOrders = smartRouteRecommendation(data.orders);
                const optimalBatch = selectOptimalBatch(sortedOrders);
                
                showBatchModal(optimalBatch);
            } catch (error) {
                console.error('ç”Ÿæˆæ‰¹æ¬¡æ¨è–¦å¤±æ•—:', error);
                showNotification('æ‰¹æ¬¡æ¨è–¦å¤±æ•—ï¼Œè«‹é‡è©¦', 'error');
            }
        }
        
        // é¸æ“‡æœ€ä½³æ‰¹æ¬¡ï¼ˆæœ€å¤š15ç­†ï¼‰
        function selectOptimalBatch(orders) {
            const maxOrders = 15;
            const batch = [];
            const areaGroups = {};
            let totalTime = 0;
            let totalValue = 0;
            
            // æŒ‰å€åŸŸåˆ†çµ„
            orders.forEach(order => {
                const area = getAreaFromAddress(order.address);
                if (!areaGroups[area]) areaGroups[area] = [];
                areaGroups[area].push(order);
            });
            
            // å„ªå…ˆé¸æ“‡é«˜æ•ˆç‡å€åŸŸçš„æ‰¹æ¬¡
            const areaEfficiency = {
                'ä¸‰å³½å€': { avgTime: 8, capacity: 5 },
                'åŒ—å¤§ç‰¹å€': { avgTime: 12, capacity: 4 },
                'æ¨¹æ—å€': { avgTime: 15, capacity: 3 },
                'é¶¯æ­Œå€': { avgTime: 18, capacity: 2 },
                'åœŸåŸå€': { avgTime: 22, capacity: 2 }
            };
            
            // æŒ‰æ•ˆç‡æ’åºå€åŸŸä¸¦é¸æ“‡è¨‚å–®
            Object.entries(areaGroups)
                .sort(([areaA], [areaB]) => {
                    const effA = areaEfficiency[areaA]?.avgTime || 25;
                    const effB = areaEfficiency[areaB]?.avgTime || 25;
                    return effA - effB;
                })
                .forEach(([area, areaOrders]) => {
                    const capacity = areaEfficiency[area]?.capacity || 1;
                    const avgTime = areaEfficiency[area]?.avgTime || 25;
                    
                    // å¾è©²å€åŸŸé¸æ“‡æœ€å¤šcapacityç­†è¨‚å–®
                    const selectedFromArea = areaOrders
                        .sort((a, b) => b.recommendScore - a.recommendScore)
                        .slice(0, Math.min(capacity, maxOrders - batch.length));
                    
                    selectedFromArea.forEach(order => {
                        if (batch.length < maxOrders) {
                            batch.push(order);
                            totalTime += avgTime;
                            totalValue += order.total;
                        }
                    });
                });
            
            return {
                orders: batch,
                totalTime: totalTime,
                totalValue: totalValue,
                efficiency: totalValue / totalTime,
                areaCount: Object.keys(areaGroups).length
            };
        }
        
        // é¡¯ç¤ºæ‰¹æ¬¡æ¨è–¦å½ˆçª—
        function showBatchModal(batchData) {
            const modal = document.createElement('div');
            modal.className = 'batch-modal';
            modal.innerHTML = `
                <div class="batch-modal-content">
                    <div class="batch-header">
                        <h3>ğŸ¯ æ™ºèƒ½æ‰¹æ¬¡æ¨è–¦</h3>
                        <button class="modal-close" onclick="closeBatchModal()">&times;</button>
                    </div>
                    <div class="batch-summary">
                        <div class="summary-stats">
                            <div class="stat">
                                <span class="stat-label">ğŸ“¦ æ¨è–¦è¨‚å–®æ•¸</span>
                                <span class="stat-value">${batchData.orders.length} ç­†</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">â±ï¸ é è¨ˆç¸½æ™‚é–“</span>
                                <span class="stat-value">${Math.round(batchData.totalTime)} åˆ†é˜</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">ğŸ’° ç¸½æ”¶ç›Š</span>
                                <span class="stat-value">$${batchData.totalValue}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-label">ğŸ† æ•ˆç‡æŒ‡æ•¸</span>
                                <span class="stat-value">${batchData.efficiency.toFixed(1)}</span>
                            </div>
                        </div>
                        <div class="batch-efficiency">
                            <h4>ğŸ“Š æ•ˆç‡åˆ†æ</h4>
                            <p>âœ… æ¶µè“‹ ${batchData.areaCount} å€‹é…é€å€åŸŸ</p>
                            <p>âœ… å¹³å‡æ¯ç­†è¨‚å–® ${(batchData.totalTime / batchData.orders.length).toFixed(1)} åˆ†é˜</p>
                            <p>âœ… æ¯åˆ†é˜æ”¶ç›Š $${batchData.efficiency.toFixed(2)}</p>
                        </div>
                    </div>
                    <div class="batch-orders">
                        <h4>ğŸ“‹ æ¨è–¦è¨‚å–®æ¸…å–®</h4>
                        <div class="batch-order-list">
                            ${batchData.orders.map((order, index) => `
                                <div class="batch-order-item">
                                    <span class="order-rank">${index + 1}</span>
                                    <div class="order-info">
                                        <strong>#${order.id}</strong> - ${getAreaFromAddress(order.address)}
                                        <br><small>ğŸ‘¤ ${order.customer_name} | ğŸ’° $${order.total}</small>
                                    </div>
                                    <div class="order-reason">
                                        <small>ğŸ’¡ ${order.recommendReason}</small>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="batch-footer">
                        <button class="btn-secondary" onclick="closeBatchModal()">å–æ¶ˆ</button>
                        <button class="btn-primary" onclick="acceptBatchRecommendation()">ğŸ¯ æ¥å—æ¨è–¦ä¸¦é–‹å§‹é…é€</button>
                    </div>
                </div>
            `;
            
            // æ·»åŠ æ¨£å¼
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0, 0, 0, 0.6); display: flex;
                align-items: center; justify-content: center; z-index: 10000; padding: 20px;
            `;
            
            document.body.appendChild(modal);
            window.currentBatchModal = modal;
            window.currentBatchData = batchData;
        }
        
        function closeBatchModal() {
            if (window.currentBatchModal) {
                window.currentBatchModal.remove();
                delete window.currentBatchModal;
                delete window.currentBatchData;
            }
        }
        
        function acceptBatchRecommendation() {
            if (window.currentBatchData) {
                showNotification(`ğŸ¯ é–‹å§‹æ‰¹æ¬¡é…é€ ${window.currentBatchData.orders.length} ç­†è¨‚å–®`, 'success');
                // é€™è£¡å¯ä»¥å¯¦ä½œæ‰¹æ¬¡æ¥å–æ‰€æœ‰æ¨è–¦è¨‚å–®çš„é‚è¼¯
                closeBatchModal();
            }
        }

        // å·¥å…·å‡½æ•¸
        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString('zh-TW', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function getAreaFromAddress(address) {
            if (address.includes('ä¸‰å³½')) return 'ä¸‰å³½å€';
            if (address.includes('åŒ—å¤§')) return 'åŒ—å¤§ç‰¹å€';
            if (address.includes('æ¨¹æ—')) return 'æ¨¹æ—å€';
            if (address.includes('é¶¯æ­Œ')) return 'é¶¯æ­Œå€';
            if (address.includes('åœŸåŸ')) return 'åœŸåŸå€';
            return 'å…¶ä»–å€åŸŸ';
        }

        // é€šçŸ¥ç³»çµ±
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
                    </span>
                    <span class="notification-message">${message}</span>
                </div>
            `;
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#27ae60' : type === 'error' ? '#e74c3c' : '#3498db'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                max-width: 350px;
                font-size: 14px;
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }
    </script>
</body>
</html>