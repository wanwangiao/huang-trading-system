<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <title>çµå¸³</title>
    <link rel="stylesheet" href="/css/styles.css">
  </head>
  <body>
    <header>
      <div class="container">
        <h1>ğŸ›’ çµå¸³</h1>
        <p><a href="/" style="color: #ffeb3b;">â† è¿”å›å•†å“åˆ—è¡¨</a></p>
      </div>
    </header>
    
    <div class="container">
      <section id="order-section" class="order-summary"></section>
      
      <section class="checkout-section">
        <h2>ğŸ“‹ å¡«å¯«è¨‚è³¼è³‡æ–™</h2>
        <form id="checkout-form" class="checkout-form">
          <div class="form-row">
            <div class="form-group">
              <label for="name">ğŸ‘¤ å§“å *</label>
              <input type="text" id="name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
            </div>
            <div class="form-group">
              <label for="phone">ğŸ“± æ‰‹æ©Ÿ *</label>
              <input type="tel" id="phone" required placeholder="09xxxxxxxx" pattern="09[0-9]{8}">
            </div>
          </div>
          
          <div class="form-group">
            <label for="address">ğŸ“ é€è²¨åœ°å€ *</label>
            <input type="text" id="address" required placeholder="è«‹è¼¸å…¥å®Œæ•´åœ°å€ï¼ˆå«ç¸£å¸‚å€ï¼‰">
          </div>
          
          <div class="form-group">
            <label for="notes">ğŸ’¬ å‚™è¨»</label>
            <textarea id="notes" rows="3" placeholder="æœ‰ä»»ä½•ç‰¹æ®Šéœ€æ±‚è«‹åœ¨æ­¤è¨»æ˜"></textarea>
          </div>
          
          <div class="form-group">
          </div>
          
          <div class="form-group">
            <label for="paymentMethod">ğŸ’³ ä»˜æ¬¾æ–¹å¼ *</label>
            <select id="paymentMethod" required>
              <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
              <option value="cash">ğŸ’° ç¾é‡‘ä»˜æ¬¾</option>
              <option value="linepay">ğŸ“± LINE Pay</option>
              <option value="bank_transfer">ğŸ¦ éŠ€è¡Œè½‰å¸³</option>
            </select>
          </div>
          
          <div class="info-box">
            <p>ğŸ“‹ <strong>æ³¨æ„äº‹é …ï¼š</strong></p>
            <ul>
              <li>ğŸ’° è¨ˆåƒ¹å•†å“å°‡æ–¼ç§¤é‡å¾Œæ›´æ–°é‡‘é¡ä¸¦é€šçŸ¥æ‚¨</li>
              <li>ğŸšš æ»¿$200å…é‹è²»ï¼Œæœªæ»¿æ”¶å–$50é‹è²»</li>
              <li>â° é è¨ˆ2-3å°æ™‚å…§é€é”</li>
            </ul>
          </div>
          
          <button type="submit" class="submit-btn">
            <span id="submit-text">ğŸš€ ç¢ºèªé€å‡ºè¨‚å–®</span>
            <span id="loading-text" style="display: none;">â³ è™•ç†ä¸­...</span>
          </button>
        </form>
        <div id="checkout-message" class="message"></div>
      </section>
    </div>
    <script>
      // å¾ localStorage å–å¾—è³¼ç‰©è»Š
      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      function renderOrder() {
        const orderSection = document.getElementById('order-section');
        if (!cart || cart.length === 0) {
          orderSection.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <h2>ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„</h2>
              <p>å¿«å»é¸è³¼æ–°é®®è”¬æœå§ï¼</p>
              <a href="/" class="btn">ğŸ›ï¸ å›å•†å“åˆ—è¡¨</a>
            </div>
          `;
          document.getElementById('checkout-form').style.display = 'none';
          return;
        }
        
        // å¾ä¼ºæœå™¨å–å¾—æœ€æ–°ç”¢å“è³‡è¨Š
        fetch('/api/products')
          .then(resp => resp.json())
          .then(data => {
            const products = data.products;
            let html = '<h2>ğŸ“¦ è¨‚è³¼æ¸…å–®</h2><div class="order-items">';
            let subtotal = 0;
            let hasVariableItems = false;
            
            cart.forEach(item => {
              const p = products.find(x => x.id === item.productId);
              if (!p) return;
              
              html += `<div class="order-item">
                <div class="item-info">
                  <span class="item-name">${p.name}</span>
                  <span class="item-quantity">æ•¸é‡: ${item.quantity}</span>
                </div>
                <div class="item-price">`;
              
              if (p.is_priced_item) {
                html += '<span class="variable-price">ğŸ’° å¾…ç¢ºèª</span>';
                hasVariableItems = true;
              } else {
                const lineTotal = Number(p.price) * Number(item.quantity);
                subtotal += lineTotal;
                html += `<span class="fixed-price">$${lineTotal}</span>`;
              }
              
              html += '</div></div>';
            });
            
            html += '</div>';
            
            // è¨ˆç®—é‹è²»
            const deliveryFee = subtotal >= 200 ? 0 : 50;
            const total = subtotal + deliveryFee;
            
            html += `
              <div class="order-total">
                <div class="total-line">
                  <span>å°è¨ˆï¼ˆå›ºå®šåƒ¹å•†å“ï¼‰ï¼š</span>
                  <span>$${subtotal}</span>
                </div>
                <div class="total-line">
                  <span>é‹è²»ï¼š</span>
                  <span>${deliveryFee === 0 ? 'å…é‹è²»' : '$' + deliveryFee}</span>
                </div>
                <div class="total-line final-total">
                  <span>é ä¼°ç¸½è¨ˆï¼š</span>
                  <span>$${total}</span>
                </div>
                ${hasVariableItems ? '<p class="note">ğŸ’¡ æœ€çµ‚é‡‘é¡å°‡æ–¼ç§¤é‡å¾Œç¢ºèª</p>' : ''}
              </div>
            `;
            
            orderSection.innerHTML = html;
          })
          .catch(err => {
            orderSection.innerHTML = '<p class="error">è¼‰å…¥å•†å“è³‡è¨Šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢</p>';
          });
      }
      renderOrder();

      document.getElementById('checkout-form').addEventListener('submit', function (e) {
        e.preventDefault();
        
        if (!cart || cart.length === 0) {
          showMessage('è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹å…ˆé¸è³¼å•†å“', 'error');
          return;
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        const submitBtn = document.querySelector('.submit-btn');
        const submitText = document.getElementById('submit-text');
        const loadingText = document.getElementById('loading-text');
        
        submitBtn.disabled = true;
        submitText.style.display = 'none';
        loadingText.style.display = 'inline';
        
        const name = document.getElementById('name').value.trim();
        const phone = document.getElementById('phone').value.trim();
        const address = document.getElementById('address').value.trim();
        const notes = document.getElementById('notes').value.trim();
        const paymentMethod = document.getElementById('paymentMethod').value;
        
        // å‰ç«¯é©—è­‰
        if (!name || name.length < 2) {
          showMessage('å§“åè‡³å°‘éœ€è¦2å€‹å­—å…ƒ', 'error');
          resetButton();
          return;
        }
        
        if (!phone.match(/^09\d{8}$/)) {
          showMessage('è«‹è¼¸å…¥æ­£ç¢ºçš„æ‰‹æ©Ÿè™Ÿç¢¼æ ¼å¼ï¼ˆ09xxxxxxxxï¼‰', 'error');
          resetButton();
          return;
        }
        
        if (!address || address.length < 5) {
          showMessage('åœ°å€è‡³å°‘éœ€è¦5å€‹å­—å…ƒ', 'error');
          resetButton();
          return;
        }
        
        if (!paymentMethod) {
          showMessage('è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼', 'error');
          resetButton();
          return;
        }
        
        const items = cart.map(it => ({ 
          productId: it.productId, 
          quantity: it.unitQuantity || it.quantity,
          selectedUnit: it.selectedUnit
        }));
        
        fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, phone, address, notes, paymentMethod, items })
        })
        .then(resp => resp.json())
        .then(data => {
          if (data.success) {
            localStorage.removeItem('cart');
            document.getElementById('checkout-form').style.display = 'none';
            showMessage(`
              ğŸ‰ è¨‚å–®å·²æˆåŠŸé€å‡ºï¼<br>
              ğŸ“ è¨‚å–®ç·¨è™Ÿï¼š${data.orderId}<br>
              ğŸ’° é ä¼°é‡‘é¡ï¼š${data.data ? '$' + data.data.total : 'å¾…ç¢ºèª'}<br>
              â° é è¨ˆé€é”ï¼š${data.data ? data.data.estimatedDelivery : '2-3å°æ™‚å…§'}<br>
              ğŸ“± æˆ‘å€‘æœƒé€éLINEæˆ–é›»è©±é€šçŸ¥æ‚¨æœ€æ–°ç‹€æ…‹
            `, 'success');
            
            // 3ç§’å¾Œè·³è½‰åˆ°é¦–é 
            setTimeout(() => {
              window.location.href = '/';
            }, 5000);
          } else {
            showMessage(data.message || 'è¨‚å–®é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
            resetButton();
          }
        })
        .catch(err => {
          console.error('Submit error:', err);
          showMessage('ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯å¾Œé‡è©¦', 'error');
          resetButton();
        });
        
        function resetButton() {
          submitBtn.disabled = false;
          submitText.style.display = 'inline';
          loadingText.style.display = 'none';
        }
        
        function showMessage(message, type) {
          const messageEl = document.getElementById('checkout-message');
          messageEl.innerHTML = message;
          messageEl.className = `message ${type}`;
          messageEl.scrollIntoView({ behavior: 'smooth' });
        }
      });
    </script>
  </body>
</html>