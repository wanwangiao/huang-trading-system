<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°å¢å•†å“ - èª æ„é®®è”¬ç®¡ç†å¾Œå°</title>
    <link rel="stylesheet" href="/css/admin-dashboard.css">
    <style>
        .product-form-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .form-header {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .form-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
        }
        
        .form-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #bdc3c7;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }
        
        .help-text {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-secondary {
            background: #95a5a6;
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .error-message {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .breadcrumb {
            margin-bottom: 20px;
            color: #7f8c8d;
        }
        
        .breadcrumb a {
            color: #3498db;
            text-decoration: none;
        }
        
        /* å•†å“é¸é …æ¨£å¼ */
        .option-group {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }
        
        .option-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .option-group-title {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .remove-group-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .option-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }
        
        .option-item input {
            flex: 1;
            margin: 0;
        }
        
        .remove-option-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .btn-outline {
            background: white;
            border: 2px solid #3498db;
            color: #3498db;
        }
        
        .btn-outline:hover {
            background: #3498db;
            color: white;
        }
        
        /* åœ–ç‰‡ä¸Šå‚³æ¨£å¼ */
        .image-upload-container {
            border: 2px dashed #bdc3c7;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: #f8f9fa;
        }
        
        .image-preview {
            width: 300px;
            height: 300px;
            margin: 0 auto 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            overflow: hidden;
            position: relative;
        }
        
        .preview-placeholder {
            color: #7f8c8d;
            text-align: center;
            font-size: 14px;
        }
        
        .preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-upload-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        #productImage {
            display: none;
        }
        
        .image-upload-container.drag-over {
            border-color: #3498db;
            background: #e8f4fd;
        }
        
        /* åœ–ç‰‡ç·¨è¼¯æ§åˆ¶æ¨£å¼ */
        .image-edit-controls {
            margin: 15px 0;
            padding: 15px;
            background: #f1f2f6;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        
        .zoom-controls, .position-controls {
            margin-bottom: 15px;
        }
        
        .zoom-controls label, .position-controls label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .zoom-controls label {
            margin-bottom: 0;
            margin-right: 10px;
        }
        
        #zoomSlider {
            flex: 1;
            min-width: 150px;
        }
        
        .zoom-btn, .pos-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .zoom-btn:hover, .pos-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .position-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .position-buttons > div {
            display: flex;
            gap: 5px;
        }
        
        #zoomValue {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .preview-edit-mode {
            position: relative;
            overflow: hidden;
        }
        
        .preview-edit-mode img {
            transition: transform 0.2s ease;
            cursor: move;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="product-form-container">
        <!-- éºµåŒ…å±‘å°èˆª -->
        <div class="breadcrumb">
            <a href="/admin/dashboard">ç®¡ç†å¾Œå°</a> > 
            <a href="/admin/products">å•†å“ç®¡ç†</a> > 
            <span>æ–°å¢å•†å“</span>
        </div>
        
        <!-- è¡¨å–®æ¨™é¡Œ -->
        <div class="form-header">
            <h1>ğŸ¥¬ æ–°å¢å•†å“</h1>
            <p>å»ºç«‹æ–°å•†å“ä¸¦è¨­å®šåˆå§‹åº«å­˜è³‡è¨Š</p>
        </div>
        
        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <% if (typeof error !== 'undefined' && error) { %>
            <div class="error-message">
                âŒ <%= error %>
            </div>
        <% } %>
        
        <!-- å•†å“è¡¨å–® -->
        <div class="form-card">
            <form method="post" action="/admin/products/new">
                <!-- å•†å“åŸºæœ¬è³‡è¨Š -->
                <div class="form-section">
                    <h3>ğŸ“ å•†å“åŸºæœ¬è³‡è¨Š</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">å•†å“åç¨± *</label>
                            <input type="text" id="name" name="name" required 
                                   placeholder="ä¾‹å¦‚: ğŸ¥¬ æœ‰æ©Ÿé«˜éº—èœ"
                                   value="<%= typeof formData !== 'undefined' && formData.name ? formData.name : '' %>">
                            <div class="help-text">è«‹è¼¸å…¥å•†å“çš„å®Œæ•´åç¨±ï¼Œå»ºè­°åŠ ä¸Šemojiè¡¨æƒ…</div>
                        </div>
                        <div class="form-group">
                            <label for="categoryId">å•†å“é¡åˆ¥ *</label>
                            <select id="categoryId" name="categoryId" required>
                                <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                                <% if (typeof categories !== 'undefined') { %>
                                    <% categories.forEach(category => { %>
                                        <option value="<%= category.id %>" 
                                                <%= typeof formData !== 'undefined' && formData.categoryId == category.id ? 'selected' : '' %>>
                                            <%= category.icon %> <%= category.display_name %>
                                        </option>
                                    <% }) %>
                                <% } %>
                            </select>
                            <div class="help-text">é¸æ“‡å•†å“æ‰€å±¬çš„é¡åˆ¥</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="unitHint">å–®ä½èªªæ˜</label>
                            <input type="text" id="unitHint" name="unitHint" 
                                   placeholder="ä¾‹å¦‚: æ¯é¡†ã€æ¯åŒ…ã€æ¯å…¬æ–¤"
                                   value="<%= typeof formData !== 'undefined' && formData.unitHint ? formData.unitHint : '' %>">
                            <div class="help-text">èªªæ˜å•†å“çš„éŠ·å”®å–®ä½</div>
                        </div>
                        <div class="form-group">
                            <!-- é ç•™ç©ºé–“ -->
                        </div>
                    </div>
                    
                    <!-- å•†å“åœ–ç‰‡ä¸Šå‚³ -->
                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="productImage">å•†å“åœ–ç‰‡</label>
                            <div class="image-upload-container">
                                <input type="file" id="productImage" name="productImage" 
                                       accept="image/*" capture="environment">
                                <div class="image-preview" id="imagePreview">
                                    <div class="preview-placeholder">
                                        ğŸ“·<br>
                                        é»æ“Šé¸æ“‡åœ–ç‰‡<br>
                                        <small>æ”¯æ´æ‰‹æ©Ÿæ‹ç…§æˆ–ç›¸ç°¿é¸æ“‡</small>
                                    </div>
                                </div>
                                
                                <!-- åœ–ç‰‡ç·¨è¼¯æ§åˆ¶ -->
                                <div class="image-edit-controls" id="imageEditControls" style="display: none;">
                                    <div class="zoom-controls">
                                        <label>ç¸®æ”¾èª¿æ•´ï¼š</label>
                                        <button type="button" class="zoom-btn" onclick="adjustZoom(-0.1)">ğŸ”â–</button>
                                        <input type="range" id="zoomSlider" min="0.5" max="3" step="0.1" value="1" oninput="updateZoom(this.value)">
                                        <button type="button" class="zoom-btn" onclick="adjustZoom(0.1)">ğŸ”â•</button>
                                        <span id="zoomValue">100%</span>
                                    </div>
                                    <div class="position-controls">
                                        <label>ä½ç½®èª¿æ•´ï¼š</label>
                                        <div class="position-buttons">
                                            <button type="button" class="pos-btn" onclick="adjustPosition(0, -10)">â¬†ï¸</button>
                                            <div>
                                                <button type="button" class="pos-btn" onclick="adjustPosition(-10, 0)">â¬…ï¸</button>
                                                <button type="button" class="pos-btn" onclick="resetPosition()">ğŸ¯</button>
                                                <button type="button" class="pos-btn" onclick="adjustPosition(10, 0)">â¡ï¸</button>
                                            </div>
                                            <button type="button" class="pos-btn" onclick="adjustPosition(0, 10)">â¬‡ï¸</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="image-upload-controls">
                                    <button type="button" class="btn btn-outline" onclick="document.getElementById('productImage').click()">
                                        ğŸ“± é¸æ“‡åœ–ç‰‡
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="confirmImage()" id="confirmImageBtn" style="display: none;">
                                        âœ… ç¢ºèªä½¿ç”¨
                                    </button>
                                    <button type="button" class="btn btn-outline" onclick="clearImage()" id="clearImageBtn" style="display: none;">
                                        ğŸ—‘ï¸ é‡æ–°é¸æ“‡
                                    </button>
                                </div>
                            </div>
                            <div class="help-text">å»ºè­°ä½¿ç”¨æ­£æ–¹å½¢åœ–ç‰‡ï¼Œç³»çµ±æœƒè‡ªå‹•èª¿æ•´ç‚º300x300åƒç´ </div>
                        </div>
                    </div>
                </div>
                
                <!-- åƒ¹æ ¼è¨­å®š -->
                <div class="form-section">
                    <h3>ğŸ’° åƒ¹æ ¼è¨­å®š</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="isPricedItem" name="isPricedItem" 
                                       <%= typeof formData !== 'undefined' && formData.isPricedItem ? 'checked' : '' %>>
                                <label for="isPricedItem">è¨ˆåƒ¹å•†å“ï¼ˆæŒ‰é‡é‡è¨ˆåƒ¹ï¼‰</label>
                            </div>
                            <div class="help-text">å‹¾é¸æ­¤é …è¡¨ç¤ºå•†å“éœ€è¦åœ¨çµå¸³æ™‚ä¾é‡é‡è¨ˆç®—åƒ¹æ ¼</div>
                        </div>
                        <div class="form-group">
                            <label for="price">å›ºå®šåƒ¹æ ¼</label>
                            <input type="number" step="0.01" id="price" name="price" 
                                   placeholder="0.00"
                                   value="<%= typeof formData !== 'undefined' && formData.price ? formData.price : '' %>">
                            <div class="help-text">å›ºå®šåƒ¹æ ¼å•†å“å¡«å¯«æ­¤æ¬„ä½ï¼Œè¨ˆåƒ¹å•†å“å¯ç•™ç©º</div>
                        </div>
                    </div>
                </div>
                
                <!-- å•†å“é¸é …è¨­å®š -->
                <div class="form-section">
                    <h3>âš™ï¸ å•†å“é¸é …è¨­å®š</h3>
                    <div class="help-text">ç‚ºå•†å“è¨­å®šä¸åŒçš„è¦æ ¼é¸é …ï¼ˆå¦‚å°ä»½ã€ä¸­ä»½ã€å¤§ä»½ç­‰ï¼‰</div>
                    
                    <!-- é¸é …ç¾¤çµ„ -->
                    <div id="option-groups">
                        <!-- å‹•æ…‹ç”Ÿæˆçš„é¸é …ç¾¤çµ„æœƒå‡ºç¾åœ¨é€™è£¡ -->
                    </div>
                    
                    <button type="button" class="btn btn-outline" onclick="addOptionGroup()">
                        â• æ–°å¢é¸é …ç¾¤çµ„
                    </button>
                </div>
                
                <!-- åº«å­˜è¨­å®š -->
                <div class="form-section">
                    <h3>ğŸ“¦ åˆå§‹åº«å­˜è¨­å®š</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="initialStock">åˆå§‹åº«å­˜æ•¸é‡</label>
                            <input type="number" id="initialStock" name="initialStock" min="0" 
                                   placeholder="0"
                                   value="<%= typeof formData !== 'undefined' && formData.initialStock ? formData.initialStock : '0' %>">
                            <div class="help-text">è¨­å®šå•†å“çš„åˆå§‹åº«å­˜æ•¸é‡</div>
                        </div>
                        <div class="form-group">
                            <label for="minStockAlert">æœ€ä½åº«å­˜è­¦å ±</label>
                            <input type="number" id="minStockAlert" name="minStockAlert" min="1" 
                                   placeholder="10"
                                   value="<%= typeof formData !== 'undefined' && formData.minStockAlert ? formData.minStockAlert : '10' %>">
                            <div class="help-text">ç•¶åº«å­˜ä½æ–¼æ­¤æ•¸é‡æ™‚æœƒç™¼å‡ºè­¦å ±</div>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label for="supplierName">ä¾›æ‡‰å•†åç¨±</label>
                        <input type="text" id="supplierName" name="supplierName" 
                               placeholder="ä¾‹å¦‚: æ–°é®®è¾²å ´"
                               value="<%= typeof formData !== 'undefined' && formData.supplierName ? formData.supplierName : '' %>">
                        <div class="help-text">è¨˜éŒ„å•†å“çš„ä¸»è¦ä¾›æ‡‰å•†</div>
                    </div>
                </div>
                
                <!-- æäº¤æŒ‰éˆ• -->
                <div class="button-group">
                    <a href="/admin/products" class="btn btn-secondary">ğŸš« å–æ¶ˆ</a>
                    <button type="submit" class="btn btn-primary">âœ… æ–°å¢å•†å“</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // ç•¶é¸æ“‡è¨ˆåƒ¹å•†å“æ™‚ï¼Œåƒ¹æ ¼æ¬„ä½è®Šç‚ºéå¿…å¡«
        document.getElementById('isPricedItem').addEventListener('change', function() {
            const priceField = document.getElementById('price');
            if (this.checked) {
                priceField.placeholder = 'è¨ˆåƒ¹å•†å“å¯ç•™ç©º';
                priceField.style.backgroundColor = '#f8f9fa';
            } else {
                priceField.placeholder = 'è«‹è¼¸å…¥å›ºå®šåƒ¹æ ¼';
                priceField.style.backgroundColor = '';
            }
        });
        
        // è¡¨å–®é©—è­‰
        document.querySelector('form').addEventListener('submit', function(e) {
            const name = document.getElementById('name').value.trim();
            const isPriced = document.getElementById('isPricedItem').checked;
            const price = document.getElementById('price').value;
            
            if (!name) {
                alert('è«‹è¼¸å…¥å•†å“åç¨±');
                e.preventDefault();
                return;
            }
            
            if (!isPriced && !price) {
                if (!confirm('æœªè¨­å®šè¨ˆåƒ¹å•†å“ä¹Ÿæœªå¡«å¯«å›ºå®šåƒ¹æ ¼ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ')) {
                    e.preventDefault();
                    return;
                }
            }
        });
        
        // å•†å“é¸é …ç®¡ç†
        let optionGroupCounter = 0;
        
        function addOptionGroup() {
            optionGroupCounter++;
            const container = document.getElementById('option-groups');
            
            const groupHtml = `
                <div class="option-group" id="group-${optionGroupCounter}">
                    <div class="option-group-header">
                        <div class="option-group-title">é¸é …ç¾¤çµ„ ${optionGroupCounter}</div>
                        <button type="button" class="remove-group-btn" onclick="removeOptionGroup(${optionGroupCounter})">
                            ğŸ—‘ï¸ ç§»é™¤ç¾¤çµ„
                        </button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç¾¤çµ„åç¨± *</label>
                            <input type="text" name="optionGroups[${optionGroupCounter}][name]" 
                                   placeholder="ä¾‹å¦‚: ä»½é‡é¸æ“‡" required>
                        </div>
                        <div class="form-group">
                            <label>ç¾¤çµ„èªªæ˜</label>
                            <input type="text" name="optionGroups[${optionGroupCounter}][description]" 
                                   placeholder="ä¾‹å¦‚: é¸æ“‡å•†å“çš„ä»½é‡å¤§å°">
                        </div>
                    </div>
                    
                    <div class="option-items" id="options-${optionGroupCounter}">
                        <!-- é¸é …æœƒå‹•æ…‹æ·»åŠ åˆ°é€™è£¡ -->
                    </div>
                    
                    <button type="button" class="btn btn-outline" onclick="addOption(${optionGroupCounter})">
                        â• æ–°å¢é¸é …
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', groupHtml);
            
            // è‡ªå‹•æ·»åŠ ç¬¬ä¸€å€‹é¸é …
            addOption(optionGroupCounter);
        }
        
        function removeOptionGroup(groupId) {
            const group = document.getElementById(`group-${groupId}`);
            if (group && confirm('ç¢ºå®šè¦ç§»é™¤é€™å€‹é¸é …ç¾¤çµ„å—ï¼Ÿ')) {
                group.remove();
            }
        }
        
        function addOption(groupId) {
            const container = document.getElementById(`options-${groupId}`);
            const optionCount = container.children.length;
            
            const optionHtml = `
                <div class="option-item">
                    <input type="text" name="optionGroups[${groupId}][options][${optionCount}][name]" 
                           placeholder="é¸é …åç¨± (ä¾‹å¦‚: å°ä»½)" required>
                    <input type="text" name="optionGroups[${groupId}][options][${optionCount}][description]" 
                           placeholder="èªªæ˜ (ä¾‹å¦‚: ç´„300å…‹)">
                    <input type="number" step="0.01" name="optionGroups[${groupId}][options][${optionCount}][priceModifier]" 
                           placeholder="åŠ åƒ¹é‡‘é¡" value="0">
                    <label>
                        <input type="checkbox" name="optionGroups[${groupId}][options][${optionCount}][isDefault]">
                        é è¨­
                    </label>
                    <button type="button" class="remove-option-btn" onclick="removeOption(this)">
                        ğŸ—‘ï¸
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', optionHtml);
        }
        
        function removeOption(button) {
            const optionItem = button.closest('.option-item');
            if (optionItem) {
                optionItem.remove();
            }
        }
        
        // åœ–ç‰‡ä¸Šå‚³è™•ç†
        let selectedImage = null;
        let originalImage = null;
        let currentZoom = 1;
        let currentX = 0;
        let currentY = 0;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        
        document.getElementById('productImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });
        
        function handleImageUpload(file) {
            // æª¢æŸ¥æª”æ¡ˆé¡å‹
            if (!file.type.startsWith('image/')) {
                alert('è«‹é¸æ“‡åœ–ç‰‡æª”æ¡ˆï¼');
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å° (é™åˆ¶5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('åœ–ç‰‡æª”æ¡ˆä¸èƒ½è¶…é5MBï¼');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    originalImage = img;
                    showImageEditor(img);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        function showImageEditor(img) {
            // é‡ç½®ç·¨è¼¯åƒæ•¸
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            
            // é¡¯ç¤ºé è¦½åœ–ç‰‡
            const preview = document.getElementById('imagePreview');
            preview.className = 'image-preview preview-edit-mode';
            
            // è¨ˆç®—åˆå§‹é¡¯ç¤ºå°ºå¯¸
            const previewSize = 300;
            const imgAspect = img.width / img.height;
            let displayWidth, displayHeight;
            
            if (imgAspect > 1) {
                // å¯¬åœ–
                displayHeight = previewSize;
                displayWidth = previewSize * imgAspect;
            } else {
                // é«˜åœ–
                displayWidth = previewSize;
                displayHeight = previewSize / imgAspect;
            }
            
            preview.innerHTML = `<img src="${img.src}" class="preview-image-edit" alt="ç·¨è¼¯é è¦½" 
                                      style="width: ${displayWidth}px; height: ${displayHeight}px;">`;
            
            // æ·»åŠ æ‹–ç§»äº‹ä»¶
            const previewImg = preview.querySelector('img');
            addDragEvents(previewImg);
            
            // é¡¯ç¤ºç·¨è¼¯æ§åˆ¶
            document.getElementById('imageEditControls').style.display = 'block';
            document.getElementById('confirmImageBtn').style.display = 'inline-block';
            document.getElementById('clearImageBtn').style.display = 'inline-block';
            
            // æ›´æ–°æ»‘æ¡¿
            document.getElementById('zoomSlider').value = currentZoom;
            document.getElementById('zoomValue').textContent = Math.round(currentZoom * 100) + '%';
            
            // æ›´æ–°é è¦½
            updatePreview();
        }
        
        function addDragEvents(img) {
            img.addEventListener('mousedown', startDrag);
            img.addEventListener('touchstart', startDrag);
            
            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag);
            
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }
        
        function startDrag(e) {
            isDragging = true;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            lastMouseX = clientX;
            lastMouseY = clientY;
            e.preventDefault();
        }
        
        function drag(e) {
            if (!isDragging) return;
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            const deltaX = clientX - lastMouseX;
            const deltaY = clientY - lastMouseY;
            
            currentX += deltaX;
            currentY += deltaY;
            
            lastMouseX = clientX;
            lastMouseY = clientY;
            
            updatePreview();
            e.preventDefault();
        }
        
        function endDrag() {
            isDragging = false;
        }
        
        function updatePreview() {
            const preview = document.getElementById('imagePreview');
            const img = preview.querySelector('img');
            if (img) {
                const transform = `translate(${currentX}px, ${currentY}px) scale(${currentZoom})`;
                img.style.transform = transform;
            }
        }
        
        function updateZoom(value) {
            currentZoom = parseFloat(value);
            document.getElementById('zoomValue').textContent = Math.round(currentZoom * 100) + '%';
            updatePreview();
        }
        
        function adjustZoom(delta) {
            const newZoom = Math.max(0.5, Math.min(3, currentZoom + delta));
            currentZoom = newZoom;
            document.getElementById('zoomSlider').value = newZoom;
            document.getElementById('zoomValue').textContent = Math.round(newZoom * 100) + '%';
            updatePreview();
        }
        
        function adjustPosition(deltaX, deltaY) {
            currentX += deltaX;
            currentY += deltaY;
            updatePreview();
        }
        
        function resetPosition() {
            currentX = 0;
            currentY = 0;
            currentZoom = 1;
            document.getElementById('zoomSlider').value = 1;
            document.getElementById('zoomValue').textContent = '100%';
            updatePreview();
        }
        
        function confirmImage() {
            if (!originalImage) return;
            
            // å»ºç«‹canvasé€²è¡Œæœ€çµ‚è£åˆ‡
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // è¨­å®šè¼¸å‡ºå°ºå¯¸ç‚º300x300
            const targetSize = 300;
            canvas.width = targetSize;
            canvas.height = targetSize;
            
            // è¨ˆç®—è£åˆ‡åƒæ•¸
            const previewSize = 300;
            const scale = Math.min(originalImage.width, originalImage.height) / previewSize;
            
            // è¨ˆç®—å¯¦éš›åœ–ç‰‡ä¸Šçš„è£åˆ‡å€åŸŸ
            const cropSize = targetSize / currentZoom * scale;
            const cropX = (originalImage.width / 2) - (cropSize / 2) - (currentX * scale / currentZoom);
            const cropY = (originalImage.height / 2) - (cropSize / 2) - (currentY * scale / currentZoom);
            
            // ç¹ªè£½è£åˆ‡å¾Œçš„åœ–ç‰‡
            ctx.drawImage(originalImage, cropX, cropY, cropSize, cropSize, 0, 0, targetSize, targetSize);
            
            // è½‰æ›ç‚ºbase64
            const processedImageData = canvas.toDataURL('image/jpeg', 0.8);
            selectedImage = processedImageData;
            
            // é¡¯ç¤ºæœ€çµ‚é è¦½
            const preview = document.getElementById('imagePreview');
            preview.className = 'image-preview';
            preview.innerHTML = `<img src="${processedImageData}" class="preview-image" alt="å•†å“åœ–ç‰‡é è¦½">`;
            
            // éš±è—ç·¨è¼¯æ§åˆ¶
            document.getElementById('imageEditControls').style.display = 'none';
            document.getElementById('confirmImageBtn').style.display = 'none';
            
            // æ›´æ–°æŒ‰éˆ•æ–‡å­—
            document.getElementById('clearImageBtn').textContent = 'ğŸ—‘ï¸ é‡æ–°é¸æ“‡';
        }
        
        function clearImage() {
            selectedImage = null;
            originalImage = null;
            currentZoom = 1;
            currentX = 0;
            currentY = 0;
            
            const preview = document.getElementById('imagePreview');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <div class="preview-placeholder">
                    ğŸ“·<br>
                    é»æ“Šé¸æ“‡åœ–ç‰‡<br>
                    <small>æ”¯æ´æ‰‹æ©Ÿæ‹ç…§æˆ–ç›¸ç°¿é¸æ“‡</small>
                </div>
            `;
            
            document.getElementById('productImage').value = '';
            document.getElementById('imageEditControls').style.display = 'none';
            document.getElementById('confirmImageBtn').style.display = 'none';
            document.getElementById('clearImageBtn').style.display = 'none';
        }
        
        // æ‹–æ”¾ä¸Šå‚³æ”¯æ´
        const uploadContainer = document.querySelector('.image-upload-container');
        
        uploadContainer.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadContainer.classList.add('drag-over');
        });
        
        uploadContainer.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadContainer.classList.remove('drag-over');
        });
        
        uploadContainer.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadContainer.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleImageUpload(files[0]);
            }
        });
        
        // è¡¨å–®æäº¤æ™‚æ·»åŠ åœ–ç‰‡è³‡æ–™
        document.querySelector('form').addEventListener('submit', function(e) {
            if (selectedImage) {
                // å»ºç«‹éš±è—æ¬„ä½ä¾†å‚³é€åœ–ç‰‡è³‡æ–™
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'imageData';
                hiddenInput.value = selectedImage;
                this.appendChild(hiddenInput);
            }
        });
    </script>
</body>
</html>