<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <title>å¾Œå°ï½œåœ°åœ–è¦–åœ–</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
      .map-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
      }
      .map-controls {
        width: 300px;
        background: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        height: fit-content;
      }
      #map {
        flex: 1;
        height: 600px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }
      .control-group {
        margin-bottom: 20px;
      }
      .control-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      .control-group select, .control-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
        margin-bottom: 10px;
      }
      .btn:hover { background: #0056b3; }
      .btn-secondary { background: #6c757d; }
      .btn-secondary:hover { background: #545b62; }
      .btn-success { background: #28a745; }
      .btn-success:hover { background: #1e7e34; }
      .status-legend {
        margin-top: 15px;
      }
      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }
      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }
      .stats-panel {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      .route-info {
        background: #e7f3ff;
        padding: 10px;
        border-radius: 4px;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <h1>è¨‚å–®åœ°åœ–ç®¡ç†</h1>
    <p>
      <a href="/admin/dashboard">å„€è¡¨æ¿</a> |
      <a href="/admin/orders">è¨‚å–®åˆ—è¡¨</a> |
      <a href="/admin/products">å•†å“ç®¡ç†</a> |
      <a href="/admin/logout">ç™»å‡º</a>
    </p>
    
    <div class="map-container">
      <div class="map-controls">
        <!-- çµ±è¨ˆé¢æ¿ -->
        <div class="stats-panel">
          <h3>è¨‚å–®çµ±è¨ˆ</h3>
          <div id="orderStats">
            <div>ç¸½è¨‚å–®: <span id="totalOrders">-</span></div>
            <div>å¾…è™•ç†: <span id="pendingOrders">-</span></div>
            <div>é…é€ä¸­: <span id="deliveringOrders">-</span></div>
            <div>å·²å®Œæˆ: <span id="completedOrders">-</span></div>
          </div>
        </div>

        <!-- ç¯©é¸æ§åˆ¶ -->
        <div class="control-group">
          <label for="statusFilter">è¨‚å–®ç‹€æ…‹ç¯©é¸:</label>
          <select id="statusFilter">
            <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
            <option value="placed">å·²ä¸‹å–®</option>
            <option value="quoted">å·²å ±åƒ¹</option>
            <option value="paid">å·²ä»˜æ¬¾</option>
            <option value="out_for_delivery">é…é€ä¸­</option>
            <option value="delivered">å·²é€é”</option>
            <option value="canceled">å·²å–æ¶ˆ</option>
          </select>
        </div>

        <div class="control-group">
          <label for="dateFilter">æ—¥æœŸç¯„åœ:</label>
          <input type="date" id="dateFrom" placeholder="é–‹å§‹æ—¥æœŸ">
          <input type="date" id="dateTo" placeholder="çµæŸæ—¥æœŸ" style="margin-top: 5px;">
        </div>

        <!-- åŠŸèƒ½æŒ‰éˆ• -->
        <button class="btn" onclick="refreshMap()">ğŸ”„ é‡æ–°è¼‰å…¥</button>
        <button class="btn btn-secondary" onclick="clearMap()">ğŸ—‘ï¸ æ¸…é™¤åœ°åœ–</button>
        <button class="btn btn-success" onclick="planRoute()">ğŸ›£ï¸ è¦åŠƒè·¯ç·š</button>
        <button class="btn btn-secondary" onclick="geocodeOrders()">ğŸ“ æ‰¹é‡åœ°ç†ç·¨ç¢¼</button>
        
        <!-- ç‹€æ…‹åœ–ä¾‹ -->
        <div class="status-legend">
          <h4>ç‹€æ…‹åœ–ä¾‹:</h4>
          <div class="legend-item">
            <div class="legend-color" style="background: #888888;"></div>
            <span>å·²ä¸‹å–®</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #2f54eb;"></div>
            <span>å·²å ±åƒ¹</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #52c41a;"></div>
            <span>å·²ä»˜æ¬¾</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #fa8c16;"></div>
            <span>é…é€ä¸­</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #237804;"></div>
            <span>å·²é€é”</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #f5222d;"></div>
            <span>å·²å–æ¶ˆ</span>
          </div>
        </div>

        <!-- è·¯ç·šè³‡è¨Š -->
        <div id="routeInfo" class="route-info">
          <h4>è·¯ç·šè³‡è¨Š:</h4>
          <div id="routeDetails"></div>
        </div>
      </div>
      
      <div id="map"></div>
    </div>
    <script>
      let map;
      let markers = [];
      let currentOrders = [];
      let routeRenderer = null;
      
      const statusColors = {
        placed: '#888888',
        quoted: '#2f54eb', 
        paid: '#52c41a',
        out_for_delivery: '#fa8c16',
        delivered: '#237804',
        canceled: '#f5222d'
      };
      
      const statusNames = {
        placed: 'å·²ä¸‹å–®',
        quoted: 'å·²å ±åƒ¹',
        paid: 'å·²ä»˜æ¬¾', 
        out_for_delivery: 'é…é€ä¸­',
        delivered: 'å·²é€é”',
        canceled: 'å·²å–æ¶ˆ'
      };
      
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 25.0330, lng: 121.5654 },
          zoom: 12,
          mapTypeControl: true,
          streetViewControl: true,
          fullscreenControl: true
        });
        
        // åˆå§‹è¼‰å…¥åœ°åœ–è³‡æ–™
        loadMapData();
        
        // è¨­å®šäº‹ä»¶ç›£è½å™¨
        document.getElementById('statusFilter').addEventListener('change', loadMapData);
        document.getElementById('dateFrom').addEventListener('change', loadMapData);
        document.getElementById('dateTo').addEventListener('change', loadMapData);
      }
      
      function loadMapData() {
        const status = document.getElementById('statusFilter').value;
        const dateFrom = document.getElementById('dateFrom').value;
        const dateTo = document.getElementById('dateTo').value;
        
        const params = new URLSearchParams();
        if (status !== 'all') params.append('status', status);
        if (dateFrom) params.append('dateFrom', dateFrom);
        if (dateTo) params.append('dateTo', dateTo);
        
        fetch(`/api/maps/orders-map-data?${params}`)
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              updateMap(data.data.orders);
              updateStats(data.data.orders);
            } else {
              console.error('è¼‰å…¥åœ°åœ–è³‡æ–™å¤±æ•—:', data.message);
            }
          })
          .catch(error => {
            console.error('è¼‰å…¥åœ°åœ–è³‡æ–™éŒ¯èª¤:', error);
            // é™ç´šåˆ°åŸæœ‰API
            loadLegacyMapData();
          });
      }
      
      function loadLegacyMapData() {
        fetch('/api/admin/orders-geo')
          .then(res => res.json())
          .then(data => {
            const orders = data.orders || [];
            updateMap(orders);
            updateStats(orders);
          })
          .catch(error => {
            console.error('è¼‰å…¥åœ°åœ–è³‡æ–™éŒ¯èª¤:', error);
          });
      }
      
      function updateMap(orders) {
        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        clearMarkers();
        
        currentOrders = orders;
        
        if (!orders || orders.length === 0) {
          console.log('æ²’æœ‰è¨‚å–®è³‡æ–™å¯é¡¯ç¤º');
          return;
        }
        
        const bounds = new google.maps.LatLngBounds();
        
        orders.forEach(order => {
          if (order.lat === null || order.lng === null) return;
          
          const pos = { lat: parseFloat(order.lat), lng: parseFloat(order.lng) };
          bounds.extend(pos);
          
          const color = statusColors[order.status] || '#888888';
          const marker = new google.maps.Marker({
            position: pos,
            map: map,
            title: `è¨‚å–® #${order.id}`,
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 8,
              fillColor: color,
              fillOpacity: 0.8,
              strokeColor: '#ffffff',
              strokeWeight: 2
            }
          });
          
          const content = `
            <div style="max-width: 300px;">
              <h4>è¨‚å–® #${order.id}</h4>
              <p><strong>å®¢æˆ¶ï¼š</strong>${order.contact_name}</p>
              <p><strong>é›»è©±ï¼š</strong>${order.contact_phone}</p>
              <p><strong>ç‹€æ…‹ï¼š</strong><span style="color: ${color}">${statusNames[order.status] || order.status}</span></p>
              <p><strong>é‡‘é¡ï¼š</strong>$${order.total}</p>
              <p><strong>åœ°å€ï¼š</strong>${order.address}</p>
              ${order.formatted_address ? `<p><strong>æ ¼å¼åŒ–åœ°å€ï¼š</strong>${order.formatted_address}</p>` : ''}
              <p><small>å»ºç«‹æ™‚é–“ï¼š${new Date(order.created_at).toLocaleString('zh-TW')}</small></p>
              ${order.geocoded_at ? `<p><small>åœ°ç†ç·¨ç¢¼æ™‚é–“ï¼š${new Date(order.geocoded_at).toLocaleString('zh-TW')}</small></p>` : ''}
            </div>
          `;
          
          const infoWindow = new google.maps.InfoWindow({ content });
          
          marker.addListener('click', () => {
            // é—œé–‰å…¶ä»–è³‡è¨Šçª—
            markers.forEach(m => {
              if (m.infoWindow) {
                m.infoWindow.close();
              }
            });
            infoWindow.open(map, marker);
          });
          
          marker.infoWindow = infoWindow;
          markers.push(marker);
        });
        
        // èª¿æ•´åœ°åœ–è¦–è§’ä»¥åŒ…å«æ‰€æœ‰æ¨™è¨˜
        if (markers.length > 0) {
          map.fitBounds(bounds);
          // é˜²æ­¢éåº¦æ”¾å¤§
          google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
            if (map.getZoom() > 16) {
              map.setZoom(16);
            }
          });
        }
      }
      
      function updateStats(orders) {
        const stats = {
          total: orders.length,
          placed: orders.filter(o => o.status === 'placed').length,
          quoted: orders.filter(o => o.status === 'quoted').length,
          paid: orders.filter(o => o.status === 'paid').length,
          out_for_delivery: orders.filter(o => o.status === 'out_for_delivery').length,
          delivered: orders.filter(o => o.status === 'delivered').length,
          canceled: orders.filter(o => o.status === 'canceled').length
        };
        
        document.getElementById('totalOrders').textContent = stats.total;
        document.getElementById('pendingOrders').textContent = stats.placed + stats.quoted;
        document.getElementById('deliveringOrders').textContent = stats.out_for_delivery;
        document.getElementById('completedOrders').textContent = stats.delivered;
      }
      
      function clearMarkers() {
        markers.forEach(marker => {
          marker.setMap(null);
        });
        markers = [];
      }
      
      function refreshMap() {
        loadMapData();
      }
      
      function clearMap() {
        clearMarkers();
        if (routeRenderer) {
          routeRenderer.setMap(null);
          routeRenderer = null;
        }
        document.getElementById('routeInfo').style.display = 'none';
      }
      
      function planRoute() {
        const deliveryOrders = currentOrders.filter(o => 
          o.status === 'paid' || o.status === 'out_for_delivery'
        );
        
        if (deliveryOrders.length < 2) {
          alert('éœ€è¦è‡³å°‘2å€‹å¾…é…é€æˆ–é…é€ä¸­çš„è¨‚å–®æ‰èƒ½è¦åŠƒè·¯ç·š');
          return;
        }
        
        // å–å‰10å€‹è¨‚å–®ï¼ˆGoogle Mapsé™åˆ¶ï¼‰
        const ordersForRoute = deliveryOrders.slice(0, 10);
        
        const origin = { lat: ordersForRoute[0].lat, lng: ordersForRoute[0].lng };
        const destination = { lat: ordersForRoute[ordersForRoute.length - 1].lat, lng: ordersForRoute[ordersForRoute.length - 1].lng };
        const waypoints = ordersForRoute.slice(1, -1).map(order => ({
          lat: parseFloat(order.lat),
          lng: parseFloat(order.lng)
        }));
        
        fetch('/api/maps/plan-route', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ origin, destination, waypoints })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            displayRoute(data.data, ordersForRoute);
          } else {
            alert('è·¯ç·šè¦åŠƒå¤±æ•—: ' + data.message);
          }
        })
        .catch(error => {
          console.error('è·¯ç·šè¦åŠƒéŒ¯èª¤:', error);
          alert('è·¯ç·šè¦åŠƒæœå‹™éŒ¯èª¤');
        });
      }
      
      function displayRoute(routeData, orders) {
        // æ¸…é™¤èˆŠè·¯ç·š
        if (routeRenderer) {
          routeRenderer.setMap(null);
        }
        
        // å»ºç«‹æ–°çš„è·¯ç·šæ¸²æŸ“å™¨
        routeRenderer = new google.maps.DirectionsRenderer({
          suppressMarkers: false,
          polylineOptions: {
            strokeColor: '#4285f4',
            strokeWeight: 4,
            strokeOpacity: 0.8
          }
        });
        
        // é¡¯ç¤ºè·¯ç·šè³‡è¨Š
        const routeInfo = document.getElementById('routeInfo');
        const routeDetails = document.getElementById('routeDetails');
        
        routeDetails.innerHTML = `
          <div><strong>ç¸½è·é›¢:</strong> ${routeData.totalDistance} km</div>
          <div><strong>é ä¼°æ™‚é–“:</strong> ${routeData.totalDuration} åˆ†é˜</div>
          <div><strong>è¨‚å–®æ•¸é‡:</strong> ${orders.length} å€‹</div>
          <div><strong>å„ªåŒ–é †åº:</strong> ${routeData.optimizedOrder ? 'å·²å„ªåŒ–' : 'åŸé †åº'}</div>
        `;
        
        routeInfo.style.display = 'block';
        
        console.log('è·¯ç·šè¦åŠƒçµæœ:', routeData);
      }
      
      function geocodeOrders() {
        const ungeocodedOrders = currentOrders.filter(o => !o.lat || !o.lng);
        
        if (ungeocodedOrders.length === 0) {
          alert('æ‰€æœ‰è¨‚å–®éƒ½å·²ç¶“æœ‰åœ°ç†åº§æ¨™äº†');
          return;
        }
        
        if (!confirm(`ç™¼ç¾ ${ungeocodedOrders.length} å€‹è¨‚å–®æ²’æœ‰åœ°ç†åº§æ¨™ï¼Œæ˜¯å¦é€²è¡Œæ‰¹é‡åœ°ç†ç·¨ç¢¼ï¼Ÿ`)) {
          return;
        }
        
        const orderIds = ungeocodedOrders.map(o => o.id);
        
        fetch('/api/maps/batch-geocode', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderIds })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert(`æ‰¹é‡åœ°ç†ç·¨ç¢¼å®Œæˆï¼æˆåŠŸ: ${data.stats.successful}, å¤±æ•—: ${data.stats.failed}`);
            loadMapData(); // é‡æ–°è¼‰å…¥åœ°åœ–
          } else {
            alert('æ‰¹é‡åœ°ç†ç·¨ç¢¼å¤±æ•—: ' + data.message);
          }
        })
        .catch(error => {
          console.error('æ‰¹é‡åœ°ç†ç·¨ç¢¼éŒ¯èª¤:', error);
          alert('æ‰¹é‡åœ°ç†ç·¨ç¢¼æœå‹™éŒ¯èª¤');
        });
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= googleMapsApiKey %>&callback=initMap"></script>
  </body>
</html>