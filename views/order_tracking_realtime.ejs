<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å³æ™‚è¨‚å–®è¿½è¹¤ - èª æ†¶é®®è”¬</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        .realtime-tracking-container {
            max-width: 900px;
            margin: 1rem auto;
            padding: 1rem;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tracking-header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 2px solid #e8f5e8;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 12px 12px 0 0;
            margin: -1rem -1rem 2rem -1rem;
            padding: 2rem 1rem;
        }

        .tracking-header h1 {
            color: #27ae60;
            margin: 0 0 1rem 0;
            font-size: 2rem;
        }

        .order-id {
            font-size: 1.5rem;
            color: #2c3e50;
            font-weight: bold;
            background: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            display: inline-block;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .realtime-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 0.8rem 1.2rem;
            border-radius: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .realtime-status.connected {
            color: #27ae60;
            border-left: 4px solid #27ae60;
        }

        .realtime-status.connecting {
            color: #f39c12;
            border-left: 4px solid #f39c12;
        }

        .realtime-status.disconnected {
            color: #e74c3c;
            border-left: 4px solid #e74c3c;
        }

        .status-pulse {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .pulse-green { background: #27ae60; }
        .pulse-orange { background: #f39c12; }
        .pulse-red { background: #e74c3c; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .tracking-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .tracking-panel {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #27ae60;
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-timeline {
            margin: 1rem 0;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            position: relative;
            padding-bottom: 1.5rem;
        }

        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 30px;
            bottom: 0;
            width: 2px;
            height: 1.5rem;
            background: #e0e0e0;
        }

        .timeline-item.active::after {
            background: #27ae60;
        }

        .timeline-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-right: 1rem;
            flex-shrink: 0;
            position: relative;
        }

        .timeline-icon.completed {
            background: #27ae60;
            color: white;
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .timeline-icon.current {
            background: #f39c12;
            color: white;
            animation: bounce 1s infinite;
            box-shadow: 0 4px 8px rgba(243, 156, 18, 0.3);
        }

        .timeline-icon.pending {
            background: #ecf0f1;
            color: #95a5a6;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: #2c3e50;
        }

        .timeline-description {
            color: #7f8c8d;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .timeline-time {
            color: #95a5a6;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .driver-panel {
            background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%);
            border-left-color: #2196f3;
        }

        .driver-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .driver-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2196f3;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .driver-details {
            flex: 1;
        }

        .driver-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 0.3rem;
        }

        .driver-phone {
            color: #7f8c8d;
            margin-bottom: 0.3rem;
        }

        .driver-vehicle {
            display: inline-block;
            background: #2196f3;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .location-info {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .location-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .location-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .location-value {
            font-weight: 500;
            color: #2c3e50;
        }

        .map-container {
            grid-column: 1 / -1;
            height: 450px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 2px solid #e8f5e8;
        }

        .map-overlay {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 0.8rem 1rem;
            font-size: 0.9rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            max-width: 280px;
        }

        .eta-panel {
            background: linear-gradient(135deg, #fff3e0 0%, #ffeaa7 100%);
            border-left-color: #ff9800;
            text-align: center;
        }

        .eta-time {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ef6c00;
            margin: 1rem 0;
        }

        .eta-countdown {
            font-size: 1.1rem;
            color: #f57c00;
            margin-top: 0.5rem;
        }

        .distance-info {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .distance-item {
            text-align: center;
        }

        .distance-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ff9800;
        }

        .distance-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 0.2rem;
        }

        .order-details-panel {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #9b59b6;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .detail-item {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .detail-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-bottom: 0.3rem;
        }

        .detail-value {
            color: #2c3e50;
            font-weight: 500;
            font-size: 1.1rem;
        }

        .refresh-button {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .refresh-button:hover {
            background: #219a52;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
        }

        .notification {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1001;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 350px;
            overflow: hidden;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification-content {
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }

        .notification-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .notification-text {
            flex: 1;
        }

        .notification-title {
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: #2c3e50;
        }

        .notification-message {
            color: #7f8c8d;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #95a5a6;
            padding: 0;
        }

        .notification-order { border-left: 4px solid #27ae60; }
        .notification-driver { border-left: 4px solid #2196f3; }
        .notification-warning { border-left: 4px solid #f39c12; }
        .notification-error { border-left: 4px solid #e74c3c; }

        @media (max-width: 768px) {
            .realtime-tracking-container {
                margin: 0.5rem;
                padding: 0.8rem;
            }
            
            .tracking-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .map-container {
                height: 350px;
            }
            
            .realtime-status {
                position: relative;
                top: auto;
                right: auto;
                margin-bottom: 1rem;
                justify-self: center;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .map-overlay {
                position: relative;
                top: auto;
                left: auto;
                margin-bottom: 1rem;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="realtime-tracking-container">
        <!-- å³æ™‚é€£æ¥ç‹€æ…‹ -->
        <div class="realtime-status connecting" id="realtimeStatus">
            <div class="status-pulse pulse-orange" id="statusPulse"></div>
            <span id="statusText">é€£æ¥ä¸­...</span>
        </div>

        <!-- è¿½è¹¤æ¨™é¡Œ -->
        <div class="tracking-header">
            <h1>ğŸ“ å³æ™‚è¨‚å–®è¿½è¹¤</h1>
            <div class="order-id">#<span id="orderId"><%= order.id %></span></div>
            <button class="refresh-button" onclick="refreshOrderStatus()">
                ğŸ”„ åˆ·æ–°ç‹€æ…‹
            </button>
        </div>

        <div class="tracking-grid">
            <!-- è¨‚å–®ç‹€æ…‹æ™‚é–“è»¸ -->
            <div class="tracking-panel">
                <div class="panel-title">
                    ğŸ“‹ è¨‚å–®ç‹€æ…‹
                </div>
                <div class="status-timeline" id="statusTimeline">
                    <!-- å‹•æ…‹ç”Ÿæˆæ™‚é–“è»¸ -->
                </div>
            </div>

            <!-- å¤–é€å“¡è³‡è¨Š -->
            <div class="tracking-panel driver-panel" id="driverPanel" style="display: none;">
                <div class="panel-title">
                    ğŸšš å¤–é€å“¡è³‡è¨Š
                </div>
                <div class="driver-info" id="driverInfo">
                    <div class="driver-avatar" id="driverAvatar">ğŸ‘¤</div>
                    <div class="driver-details">
                        <div class="driver-name" id="driverName">å°‹æ‰¾å¤–é€å“¡ä¸­...</div>
                        <div class="driver-phone" id="driverPhone">ğŸ“ --</div>
                        <div class="driver-vehicle" id="driverVehicle">ğŸ›µ --</div>
                    </div>
                </div>
                <div class="location-info" id="locationInfo" style="display: none;">
                    <div class="location-row">
                        <span class="location-label">æœ€å¾Œæ›´æ–°ï¼š</span>
                        <span class="location-value" id="lastLocationUpdate">--</span>
                    </div>
                    <div class="location-row">
                        <span class="location-label">GPSç²¾ç¢ºåº¦ï¼š</span>
                        <span class="location-value" id="gpsAccuracy">--</span>
                    </div>
                    <div class="location-row">
                        <span class="location-label">ç§»å‹•é€Ÿåº¦ï¼š</span>
                        <span class="location-value" id="driverSpeed">--</span>
                    </div>
                </div>
            </div>

            <!-- é è¨ˆé€é”æ™‚é–“ -->
            <div class="tracking-panel eta-panel" id="etaPanel" style="display: none;">
                <div class="panel-title">
                    â° é è¨ˆé€é”
                </div>
                <div class="eta-time" id="etaTime">--:--</div>
                <div class="eta-countdown" id="etaCountdown">è¨ˆç®—ä¸­...</div>
                <div class="distance-info" id="distanceInfo" style="display: none;">
                    <div class="distance-item">
                        <div class="distance-value" id="remainingDistance">--</div>
                        <div class="distance-label">å‰©é¤˜è·é›¢</div>
                    </div>
                    <div class="distance-item">
                        <div class="distance-value" id="estimatedTime">--</div>
                        <div class="distance-label">é è¨ˆæ™‚é–“</div>
                    </div>
                </div>
            </div>

            <!-- ç©ºçš„é¢æ¿ç”¨æ–¼å¹³è¡¡å¸ƒå±€ -->
            <div class="tracking-panel" id="additionalInfo" style="display: none;">
                <div class="panel-title">
                    â„¹ï¸ é…é€è³‡è¨Š
                </div>
                <div id="additionalContent">
                    <!-- å…¶ä»–è³‡è¨Š -->
                </div>
            </div>

            <!-- å³æ™‚åœ°åœ– -->
            <div class="map-container" id="mapContainer">
                <div class="map-overlay" id="mapOverlay">
                    ğŸ“ è¼‰å…¥å³æ™‚åœ°åœ–ä¸­...
                </div>
                <div id="trackingMap" style="height: 100%; width: 100%;"></div>
            </div>

            <!-- è¨‚å–®è©³æƒ… -->
            <div class="order-details-panel">
                <div class="panel-title">
                    ğŸ“„ è¨‚å–®è©³æƒ…
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <div class="detail-label">è¯çµ¡äºº</div>
                        <div class="detail-value"><%= order.contact_name %></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é›»è©±</div>
                        <div class="detail-value"><%= order.contact_phone %></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">é…é€åœ°å€</div>
                        <div class="detail-value"><%= order.address %></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">è¨‚å–®é‡‘é¡</div>
                        <div class="detail-value">$<%= order.total %></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä¸‹å–®æ™‚é–“</div>
                        <div class="detail-value"><%= new Date(order.created_at).toLocaleString('zh-TW') %></div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">ä»˜æ¬¾æ–¹å¼</div>
                        <div class="detail-value"><%= order.payment_method || 'ç¾é‡‘' %></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥ç³»çµ± -->
    <div class="notification" id="notification">
        <div class="notification-content">
            <div class="notification-icon" id="notificationIcon">ğŸ“¬</div>
            <div class="notification-text">
                <div class="notification-title" id="notificationTitle">é€šçŸ¥</div>
                <div class="notification-message" id="notificationMessage">è¨Šæ¯å…§å®¹</div>
            </div>
            <button class="notification-close" onclick="hideNotification()">Ã—</button>
        </div>
    </div>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=geometry&callback=initTrackingMap"></script>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        const orderData = <%- JSON.stringify(order) %>;
        const orderId = orderData.id;
        let trackingMap = null;
        let driverMarker = null;
        let orderMarker = null;
        let routePolyline = null;
        let websocket = null;
        let locationUpdateInterval = null;
        let etaCountdownInterval = null;

        // ç‹€æ…‹é…ç½®
        const statusConfig = {
            'placed': { icon: 'ğŸ“', title: 'è¨‚å–®æˆç«‹', description: 'æ‚¨çš„è¨‚å–®å·²æˆåŠŸå»ºç«‹ï¼Œæˆ‘å€‘æ­£åœ¨è™•ç†ä¸­' },
            'confirmed': { icon: 'âœ…', title: 'è¨‚å–®ç¢ºèª', description: 'æˆ‘å€‘å·²ç¢ºèªæ‚¨çš„è¨‚å–®ï¼Œé–‹å§‹æº–å‚™å•†å“' },
            'preparing': { icon: 'ğŸ‘¨â€ğŸ³', title: 'å•†å“æº–å‚™ä¸­', description: 'æ­£åœ¨ç‚ºæ‚¨æŒ‘é¸æœ€æ–°é®®çš„å•†å“' },
            'packed': { icon: 'ğŸ“¦', title: 'åŒ…è£å®Œæˆ', description: 'å•†å“å·²æ‰“åŒ…å®Œæˆï¼Œç­‰å¾…å¤–é€å“¡å–è²¨' },
            'assigned': { icon: 'ğŸšš', title: 'å¤–é€å“¡æ¥å–®', description: 'å¤–é€å“¡å·²æ¥å–®ï¼Œæº–å‚™å‰ä¾†å–è²¨' },
            'picked_up': { icon: 'ğŸƒâ€â™‚ï¸', title: 'å¤–é€å“¡å·²å–è²¨', description: 'å¤–é€å“¡å·²å–å¾—å•†å“ï¼Œæ­£åœ¨å‰å¾€æ‚¨çš„åœ°å€' },
            'delivering': { icon: 'ğŸ›µ', title: 'é…é€ä¸­', description: 'å¤–é€å“¡æ­£åœ¨è·¯ä¸Šï¼Œå³å°‡ç‚ºæ‚¨é€é”' },
            'delivered': { icon: 'ğŸ‰', title: 'å·²é€é”', description: 'å•†å“å·²æˆåŠŸé€é”ï¼Œæ„Ÿè¬æ‚¨çš„è¨‚è³¼ï¼' },
            'completed': { icon: 'âœ¨', title: 'è¨‚å–®å®Œæˆ', description: 'è¨‚å–®å·²å®Œæˆï¼ŒæœŸå¾…æ‚¨çš„å†æ¬¡å…‰è‡¨' }
        };

        const statusOrder = ['placed', 'confirmed', 'preparing', 'packed', 'assigned', 'picked_up', 'delivering', 'delivered', 'completed'];

        // é é¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ åˆå§‹åŒ–å³æ™‚è¨‚å–®è¿½è¹¤...');
            initializeTracking();
        });

        function initializeTracking() {
            renderStatusTimeline();
            connectWebSocket();
            startLocationUpdates();
        }

        // åˆå§‹åŒ–åœ°åœ–
        function initTrackingMap() {
            console.log('ğŸ—ºï¸ åˆå§‹åŒ–è¿½è¹¤åœ°åœ–...');

            const mapElement = document.getElementById('trackingMap');
            const defaultLocation = { lat: 24.9347, lng: 121.3681 }; // ä¸‰å³½é è¨­ä½ç½®

            // ä½¿ç”¨è¨‚å–®åº§æ¨™æˆ–é è¨­ä½ç½®
            const orderLocation = orderData.lat && orderData.lng 
                ? { lat: parseFloat(orderData.lat), lng: parseFloat(orderData.lng) }
                : defaultLocation;

            trackingMap = new google.maps.Map(mapElement, {
                zoom: 15,
                center: orderLocation,
                styles: [
                    {
                        featureType: 'poi',
                        elementType: 'labels.icon',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });

            // å‰µå»ºè¨‚å–®ä½ç½®æ¨™è¨˜
            orderMarker = new google.maps.Marker({
                position: orderLocation,
                map: trackingMap,
                title: 'é…é€åœ°å€',
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#27ae60" width="40px" height="40px">
                            <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            // å‰µå»ºå¤–é€å“¡ä½ç½®æ¨™è¨˜ï¼ˆåˆå§‹éš±è—ï¼‰
            driverMarker = new google.maps.Marker({
                map: trackingMap,
                title: 'å¤–é€å“¡ä½ç½®',
                visible: false,
                icon: {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#2196f3" width="40px" height="40px">
                            <path d="M12 2c-5.52 0-10 4.48-10 10s4.48 10 10 10 10-4.48 10-10-4.48-10-10-10zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                            <circle cx="12" cy="12" r="3" fill="white"/>
                        </svg>
                    `),
                    scaledSize: new google.maps.Size(40, 40)
                }
            });

            updateMapOverlay('åœ°åœ–å·²è¼‰å…¥ï¼Œç­‰å¾…å¤–é€å“¡ä½ç½®...');
        }

        // é€£æ¥WebSocket
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/customer/${orderData.contact_phone}`;
            
            websocket = new WebSocket(wsUrl);
            
            websocket.onopen = function() {
                console.log('ğŸ“¡ WebSocketé€£æ¥æˆåŠŸ');
                updateConnectionStatus('connected', 'å³æ™‚é€£æ¥ä¸­');
                
                // è¨‚é–±è¨‚å–®æ›´æ–°
                websocket.send(JSON.stringify({
                    type: 'subscribe_order',
                    orderId: orderId
                }));
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('ğŸ“¨ æ”¶åˆ°å³æ™‚æ›´æ–°:', data);
                handleRealtimeUpdate(data);
            };
            
            websocket.onclose = function() {
                console.log('ğŸ“¡ WebSocketé€£æ¥æ–·é–‹ï¼Œå˜—è©¦é‡é€£...');
                updateConnectionStatus('disconnected', 'é€£æ¥ä¸­æ–·');
                setTimeout(connectWebSocket, 3000);
            };
            
            websocket.onerror = function(error) {
                console.error('ğŸ“¡ WebSocketéŒ¯èª¤:', error);
                updateConnectionStatus('disconnected', 'é€£æ¥éŒ¯èª¤');
            };
        }

        // è™•ç†å³æ™‚æ›´æ–°
        function handleRealtimeUpdate(data) {
            switch(data.type) {
                case 'order_status_update':
                    handleOrderStatusUpdate(data);
                    break;
                case 'driver_location_update':
                    handleDriverLocationUpdate(data);
                    break;
                case 'driver_assigned':
                    handleDriverAssigned(data);
                    break;
                case 'delivery_eta_update':
                    handleETAUpdate(data);
                    break;
                default:
                    console.log('æœªçŸ¥çš„æ›´æ–°é¡å‹:', data.type);
            }
        }

        // è™•ç†è¨‚å–®ç‹€æ…‹æ›´æ–°
        function handleOrderStatusUpdate(data) {
            console.log('ğŸ“‹ è¨‚å–®ç‹€æ…‹æ›´æ–°:', data);
            
            if (data.orderId === orderId) {
                // æ›´æ–°å…¨åŸŸè¨‚å–®è³‡æ–™
                Object.assign(orderData, data);
                
                // é‡æ–°æ¸²æŸ“æ™‚é–“è»¸
                renderStatusTimeline();
                
                // é¡¯ç¤ºé€šçŸ¥
                showNotification(
                    'è¨‚å–®ç‹€æ…‹æ›´æ–°',
                    `æ‚¨çš„è¨‚å–®ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š${statusConfig[data.status]?.title || data.status}`,
                    'order'
                );
            }
        }

        // è™•ç†å¤–é€å“¡ä½ç½®æ›´æ–°
        function handleDriverLocationUpdate(data) {
            console.log('ğŸ“ å¤–é€å“¡ä½ç½®æ›´æ–°:', data);
            
            if (data.orderId === orderId) {
                updateDriverLocationOnMap(data.driverLocation);
                updateDriverLocationInfo(data.driverLocation);
                calculateAndDisplayRoute(data.driverLocation);
            }
        }

        // è™•ç†å¤–é€å“¡æŒ‡æ´¾
        function handleDriverAssigned(data) {
            console.log('ğŸšš å¤–é€å“¡å·²æŒ‡æ´¾:', data);
            
            if (data.orderId === orderId) {
                showDriverInfo(data.driverInfo);
                showNotification(
                    'å¤–é€å“¡å·²æŒ‡æ´¾',
                    `å¤–é€å“¡ ${data.driverInfo.name} å·²æ¥æ‚¨çš„è¨‚å–®`,
                    'driver'
                );
            }
        }

        // è™•ç†ETAæ›´æ–°
        function handleETAUpdate(data) {
            console.log('â° ETAæ›´æ–°:', data);
            
            if (data.orderId === orderId) {
                updateETADisplay(data.eta, data.distance);
            }
        }

        // æ›´æ–°é€£æ¥ç‹€æ…‹
        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('realtimeStatus');
            const pulseEl = document.getElementById('statusPulse');
            const textEl = document.getElementById('statusText');
            
            statusEl.className = `realtime-status ${status}`;
            textEl.textContent = message;
            
            switch(status) {
                case 'connected':
                    pulseEl.className = 'status-pulse pulse-green';
                    break;
                case 'connecting':
                    pulseEl.className = 'status-pulse pulse-orange';
                    break;
                case 'disconnected':
                    pulseEl.className = 'status-pulse pulse-red';
                    break;
            }
        }

        // æ¸²æŸ“ç‹€æ…‹æ™‚é–“è»¸
        function renderStatusTimeline() {
            const timelineContainer = document.getElementById('statusTimeline');
            const currentStatus = orderData.status;
            const currentIndex = statusOrder.indexOf(currentStatus);
            
            let html = '';
            
            statusOrder.forEach((status, index) => {
                const config = statusConfig[status];
                let iconClass = 'pending';
                
                if (index < currentIndex) {
                    iconClass = 'completed';
                } else if (index === currentIndex) {
                    iconClass = 'current';
                }
                
                html += `
                    <div class="timeline-item ${index <= currentIndex ? 'active' : ''}">
                        <div class="timeline-icon ${iconClass}">
                            ${config.icon}
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-title">${config.title}</div>
                            <div class="timeline-description">${config.description}</div>
                            <div class="timeline-time" id="time-${status}"></div>
                        </div>
                    </div>
                `;
            });
            
            timelineContainer.innerHTML = html;
        }

        // é¡¯ç¤ºå¤–é€å“¡è³‡è¨Š
        function showDriverInfo(driverInfo) {
            const driverPanel = document.getElementById('driverPanel');
            const driverName = document.getElementById('driverName');
            const driverPhone = document.getElementById('driverPhone');
            const driverAvatar = document.getElementById('driverAvatar');
            const driverVehicle = document.getElementById('driverVehicle');
            
            driverName.textContent = driverInfo.name || 'æœªçŸ¥å¤–é€å“¡';
            driverPhone.textContent = `ğŸ“ ${driverInfo.phone || '--'}`;
            driverAvatar.textContent = driverInfo.name ? driverInfo.name.charAt(0) : 'ğŸ‘¤';
            driverVehicle.textContent = `ğŸ›µ ${driverInfo.vehicleType || 'æ©Ÿè»Š'}`;
            
            driverPanel.style.display = 'block';
        }

        // æ›´æ–°å¤–é€å“¡åœ°åœ–ä½ç½®
        function updateDriverLocationOnMap(location) {
            if (!trackingMap || !driverMarker) return;
            
            const driverPosition = {
                lat: location.lat,
                lng: location.lng
            };
            
            driverMarker.setPosition(driverPosition);
            driverMarker.setVisible(true);
            
            // èª¿æ•´åœ°åœ–è¦–è§’åŒ…å«å…©å€‹æ¨™è¨˜
            const bounds = new google.maps.LatLngBounds();
            bounds.extend(driverPosition);
            bounds.extend(orderMarker.getPosition());
            trackingMap.fitBounds(bounds);
            
            updateMapOverlay(`å¤–é€å“¡ä½ç½®å·²æ›´æ–° - ${new Date(location.timestamp).toLocaleTimeString('zh-TW')}`);
        }

        // æ›´æ–°å¤–é€å“¡ä½ç½®è³‡è¨Š
        function updateDriverLocationInfo(location) {
            const locationInfo = document.getElementById('locationInfo');
            const lastUpdate = document.getElementById('lastLocationUpdate');
            const gpsAccuracy = document.getElementById('gpsAccuracy');
            const driverSpeed = document.getElementById('driverSpeed');
            
            lastUpdate.textContent = new Date(location.timestamp).toLocaleTimeString('zh-TW');
            gpsAccuracy.textContent = location.accuracy ? `Â±${Math.round(location.accuracy)}m` : 'æœªçŸ¥';
            driverSpeed.textContent = location.speed ? `${Math.round(location.speed)} km/h` : 'éœæ­¢';
            
            locationInfo.style.display = 'block';
        }

        // è¨ˆç®—ä¸¦é¡¯ç¤ºè·¯ç·š
        function calculateAndDisplayRoute(driverLocation) {
            if (!trackingMap) return;
            
            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true,
                polylineOptions: {
                    strokeColor: '#2196f3',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });
            
            directionsRenderer.setMap(trackingMap);
            
            directionsService.route({
                origin: { lat: driverLocation.lat, lng: driverLocation.lng },
                destination: orderMarker.getPosition(),
                travelMode: google.maps.TravelMode.DRIVING,
                avoidHighways: false,
                avoidTolls: true
            }, (response, status) => {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                    
                    const route = response.routes[0];
                    const leg = route.legs[0];
                    
                    // æ›´æ–°è·é›¢å’Œæ™‚é–“è³‡è¨Š
                    updateDistanceInfo({
                        distance: leg.distance.text,
                        duration: leg.duration.text
                    });
                }
            });
        }

        // æ›´æ–°è·é›¢è³‡è¨Š
        function updateDistanceInfo(info) {
            const distanceInfo = document.getElementById('distanceInfo');
            const remainingDistance = document.getElementById('remainingDistance');
            const estimatedTime = document.getElementById('estimatedTime');
            
            remainingDistance.textContent = info.distance;
            estimatedTime.textContent = info.duration;
            
            distanceInfo.style.display = 'flex';
        }

        // æ›´æ–°ETAé¡¯ç¤º
        function updateETADisplay(eta, distance) {
            const etaPanel = document.getElementById('etaPanel');
            const etaTime = document.getElementById('etaTime');
            const etaCountdown = document.getElementById('etaCountdown');
            
            if (eta) {
                const etaDate = new Date(eta);
                etaTime.textContent = etaDate.toLocaleTimeString('zh-TW');
                
                // é–‹å§‹å€’æ•¸
                startETACountdown(etaDate);
                
                etaPanel.style.display = 'block';
            }
        }

        // é–‹å§‹ETAå€’æ•¸
        function startETACountdown(targetDate) {
            if (etaCountdownInterval) {
                clearInterval(etaCountdownInterval);
            }
            
            etaCountdownInterval = setInterval(() => {
                const now = new Date();
                const timeDiff = targetDate - now;
                
                const etaCountdown = document.getElementById('etaCountdown');
                
                if (timeDiff > 0) {
                    const minutes = Math.floor(timeDiff / (1000 * 60));
                    const seconds = Math.floor((timeDiff % (1000 * 60)) / 1000);
                    etaCountdown.textContent = `é‚„æœ‰ ${minutes} åˆ† ${seconds} ç§’`;
                } else {
                    etaCountdown.textContent = 'å¤–é€å“¡æ‡‰è©²å·²ç¶“åˆ°é”ï¼';
                    clearInterval(etaCountdownInterval);
                }
            }, 1000);
        }

        // æ›´æ–°åœ°åœ–è¦†è“‹è³‡è¨Š
        function updateMapOverlay(message) {
            const mapOverlay = document.getElementById('mapOverlay');
            mapOverlay.textContent = message;
        }

        // é–‹å§‹ä½ç½®æ›´æ–°
        function startLocationUpdates() {
            // æ¯30ç§’è«‹æ±‚ä¸€æ¬¡æœ€æ–°çš„è¨‚å–®ç‹€æ…‹
            locationUpdateInterval = setInterval(refreshOrderStatus, 30000);
        }

        // åˆ·æ–°è¨‚å–®ç‹€æ…‹
        async function refreshOrderStatus() {
            try {
                const response = await fetch(`/api/orders/${orderId}/status`);
                if (response.ok) {
                    const data = await response.json();
                    console.log('ğŸ“Š è¨‚å–®ç‹€æ…‹å·²æ›´æ–°:', data);
                    
                    // æ›´æ–°è¨‚å–®è³‡æ–™
                    Object.assign(orderData, data);
                    renderStatusTimeline();
                    
                    // å¦‚æœæœ‰å¤–é€å“¡è³‡è¨Šï¼Œé¡¯ç¤ºå®ƒ
                    if (data.driver) {
                        showDriverInfo(data.driver);
                    }
                    
                    // å¦‚æœæœ‰ä½ç½®è³‡è¨Šï¼Œæ›´æ–°åœ°åœ–
                    if (data.driver && data.driver.currentLocation) {
                        updateDriverLocationOnMap(data.driver.currentLocation);
                    }
                }
            } catch (error) {
                console.error('ğŸ“Š åˆ·æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—:', error);
            }
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(title, message, type = 'order') {
            const notification = document.getElementById('notification');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // è¨­ç½®åœ–ç¤ºå’Œæ¨£å¼
            notification.className = `notification notification-${type} show`;
            
            switch(type) {
                case 'order':
                    iconEl.textContent = 'ğŸ“‹';
                    break;
                case 'driver':
                    iconEl.textContent = 'ğŸšš';
                    break;
                case 'warning':
                    iconEl.textContent = 'âš ï¸';
                    break;
                case 'error':
                    iconEl.textContent = 'âŒ';
                    break;
                default:
                    iconEl.textContent = 'ğŸ“¬';
            }
            
            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // éš±è—é€šçŸ¥
        function hideNotification() {
            const notification = document.getElementById('notification');
            notification.classList.remove('show');
        }

        // æ¸…ç†è³‡æº
        window.addEventListener('beforeunload', function() {
            if (websocket) {
                websocket.close();
            }
            if (locationUpdateInterval) {
                clearInterval(locationUpdateInterval);
            }
            if (etaCountdownInterval) {
                clearInterval(etaCountdownInterval);
            }
        });
    </script>
</body>
</html>