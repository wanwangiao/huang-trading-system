<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>誠意鮮蔬｜新鮮蔬果外送 - 手機版</title>
    <link rel="stylesheet" href="/css/styles.css">
  </head>
  <body>
    <!-- 頂部導航 -->
    <header class="main-header">
      <div class="header-content">
        <div class="store-info">
          <h1 class="store-name">誠意鮮蔬</h1>
          <div class="store-stats">
            <span class="views">👁 5489 views</span>
            <span class="store-badge">店家資訊</span>
          </div>
        </div>
        <% if (sessionLine) { %>
          <div class="line-status connected">
            ✅ LINE 已綁定（<%= sessionLine.displayName %>）
          </div>
        <% } else { %>
          <div class="line-status">
            <a href="/auth/line/login" class="line-connect">📱 綁定 LINE</a>
          </div>
        <% } %>
      </div>
    </header>

    <!-- 搜尋功能 -->
    <div class="search-section">
      <div class="search-container">
        <div class="search-input-wrapper">
          <input type="text" id="search-input" placeholder="🔍 搜尋商品名稱..." class="search-input">
          <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">✕</button>
        </div>
      </div>
    </div>

    <!-- 商品分類導航 -->
    <nav class="category-nav">
      <div class="category-tabs">
        <button class="category-tab active" data-category="all">推薦</button>
        <button class="category-tab" data-category="vegetables">一般蔬菜</button>
        <button class="category-tab" data-category="leafy">葉菜類</button>
        <button class="category-tab" data-category="fruits">水果</button>
        <button class="category-tab" data-category="proxy">代購</button>
      </div>
    </nav>
    
    <!-- 主要內容區域 -->
    <main class="main-content">
      <!-- 服務公告區 -->
      <div class="service-announcement">
        <h3>📢 訊息公告</h3>
        <div class="announcement-content">
          <p><strong>服務範圍：</strong>三峽、北大特區、鶯歌、樹林、土城</p>
          <p><strong>外送門檻：</strong>單筆訂單滿200元即可外送喔！！(免外送費)</p>
          <p><strong>結帳方式：</strong>現金、LINEPAY、銀行轉帳</p>
          <p><strong>預約服務：</strong>當天11點前下單當天送達！每日下午14點後開放隔日預約</p>
        </div>
      </div>

      <!-- 商品區域 -->
      <div class="products-section">
        <% if (!products || products.length === 0) { %>
          <div class="empty-products">
            <p>目前沒有商品，請稍後再試。</p>
          </div>
        <% } else { %>
          <div class="products-list mobile-layout">
            <% products.forEach(function(product) { %>
              <div class="product-item mobile-item" data-category="<%= product.is_priced_item ? 'proxy' : 'vegetables' %>" onclick="openProductModal(<%= product.id %>)">
                <!-- 左側圖片 -->
                <div class="product-image-left">
                  <div class="product-image-container">
                    <% if (product.image_url && product.image_url.startsWith('/uploads/')) { %>
                      <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                    <% } else if (product.image_url) { %>
                      <%= product.image_url %>
                    <% } else if (product.name.includes('高麗菜')) { %>
                      🥬
                    <% } else if (product.name.includes('番茄')) { %>
                      🍅
                    <% } else if (product.name.includes('胡蘿蔔')) { %>
                      🥕
                    <% } else if (product.name.includes('小黃瓜')) { %>
                      🥒
                    <% } else if (product.name.includes('洋蔥')) { %>
                      🧅
                    <% } else if (product.name.includes('玉米')) { %>
                      🌽
                    <% } else if (product.name.includes('馬鈴薯')) { %>
                      🥔
                    <% } else { %>
                      🥬
                    <% } %>
                  </div>
                  <!-- 商品標籤 -->
                  <% if (product.id % 4 === 1) { %>
                    <div class="product-badge hot">熱銷</div>
                  <% } else if (product.id % 4 === 2) { %>
                    <div class="product-badge new">新品</div>
                  <% } else if (product.id % 4 === 3) { %>
                    <div class="product-badge limited">限量</div>
                  <% } else if (product.id % 4 === 0) { %>
                    <div class="product-badge recommend">推薦</div>
                  <% } %>
                </div>
                
                <!-- 右側內容 -->
                <div class="product-content-right">
                  <h3 class="product-title-mobile"><%= product.name %></h3>
                  
                  <!-- 價格區域 -->
                  <div class="product-price-mobile">
                    <% if (product.is_priced_item) { %>
                      <!-- 計價商品 -->
                      <div class="price-range">
                        <span class="price-from">1斤約<%= Math.floor(Math.random() * 50) + 100 %>~</span>
                      </div>
                      <div class="price-note">幫您秤重好後告知您金額~</div>
                    <% } else { %>
                      <!-- 固定價格商品，模擬多規格 -->
                      <% if (product.id % 3 === 1) { %>
                        <div class="multi-price">
                          <span class="price-option">1斤:<%= product.price %></span>
                        </div>
                      <% } else if (product.id % 3 === 2) { %>
                        <div class="multi-price">
                          <span class="price-option">5顆:<%= Math.floor(product.price * 0.8) %></span>
                          <span class="price-option">10顆:<%= Math.floor(product.price * 1.5) %></span>
                        </div>
                      <% } else { %>
                        <div class="multi-price">
                          <span class="price-option">半斤:<%= Math.floor(product.price * 0.6) %></span>
                          <span class="price-option">1斤:<%= product.price %></span>
                        </div>
                      <% } %>
                    <% } %>
                  </div>
                  
                  <!-- 商品描述 -->
                  <div class="product-description">
                    <% if (product.is_priced_item) { %>
                      新鮮計價商品，秤重後確認價格
                    <% } else { %>
                      新鮮優質，精選品質保證！
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </main>
    <!-- 固定底部購物車 -->
    <div class="cart-bottom" id="cart-bottom" style="display: none;">
      <div class="cart-summary">
        <div class="cart-info">
          <span class="cart-total">合計: $<span id="cart-subtotal">0</span> 元</span>
          <span class="cart-note">來去結帳</span>
        </div>
        <button class="checkout-btn" id="checkout-btn" onclick="goToCheckout()">
          <span class="checkout-arrow">▶</span>
        </button>
      </div>
    </div>

    <!-- 購物車詳情彈窗（隱藏） -->
    <div class="cart-details" id="cart-details" style="display: none;">
      <div class="cart-header">
        <h3>購物車明細</h3>
        <button class="close-cart" onclick="closeCartDetails()">✕</button>
      </div>
      <ul id="cart-list" class="cart-items"></ul>
      <div class="cart-footer">
        <p class="cart-note-text">（計價商品將於秤重後更新金額）</p>
      </div>
    </div>

    <!-- 🕰️ 營業時間彈出視窗 -->
    <div class="business-hours-modal" id="business-hours-modal">
      <div class="business-hours-content">
        <div class="hours-title">
          🕰️ 營業時間
        </div>
        <div class="hours-list" id="hours-list">
          <div class="hours-item">
            <span class="day-name">星期一</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">星期二</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">星期三</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">星期四</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">星期五</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">星期六</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">星期日</span>
            <span class="day-hours closed">公休</span>
          </div>
        </div>
        <button class="hours-close-btn" onclick="closeBusinessHours()">
          知道了
        </button>
      </div>
    </div>
    <!-- 📱 商品詳情彈出視窗 -->
    <div class="product-modal" id="product-modal" style="display: none;" onclick="closeProductModal()">
      <div class="product-modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <button class="modal-close" onclick="closeProductModal()">✕</button>
        </div>
        
        <div class="modal-product-image">
          <div class="modal-image-container" id="modal-image">
            <!-- 動態更新商品圖片 -->
          </div>
          <div class="modal-badge" id="modal-badge">新品</div>
        </div>
        
        <div class="modal-product-info">
          <h3 class="modal-title" id="modal-title">商品名稱</h3>
          <div class="modal-description" id="modal-description">
            新鮮優質，精選品質保證！當季最新鮮的蔬果，為您的餐桌增添健康與美味。
          </div>
        </div>
        
        <div class="modal-price-section">
          <div class="modal-price-options" id="modal-price-options">
            <!-- 動態生成價格選項 -->
          </div>
        </div>
        
        <div class="modal-quantity-section">
          <div class="modal-quantity-label">數量選擇</div>
          <div class="modal-quantity-selector">
            <button class="modal-qty-btn" onclick="modalDecreaseQty()">-</button>
            <input type="number" id="modal-qty" value="1" min="1" max="99" readonly>
            <button class="modal-qty-btn" onclick="modalIncreaseQty()">+</button>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="modal-add-cart" onclick="addToCartFromModal()">
            🛒 加入購物車
          </button>
        </div>
      </div>
    </div>
    
    <script>
      // 從伺服端複製 products 至前端使用
      const products = <%- JSON.stringify(products) %>;
      let currentModalProduct = null;
      function getCart() {
        try {
          return JSON.parse(localStorage.getItem('cart') || '[]');
        } catch (e) {
          return [];
        }
      }
      function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      // 數量控制函數
      function increaseQty(id) {
        const qtyInput = document.getElementById('qty-' + id);
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty < 99) {
          qtyInput.value = currentQty + 1;
        }
      }
      
      function decreaseQty(id) {
        const qtyInput = document.getElementById('qty-' + id);
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty > 1) {
          qtyInput.value = currentQty - 1;
        }
      }

      function addToCart(id) {
        console.log('🛒 加入購物車被點擊，商品ID:', id);
        
        const qtyInput = document.getElementById('qty-' + id);
        if (!qtyInput) {
          console.error('❌ 找不到數量輸入框:', 'qty-' + id);
          alert('錯誤：找不到數量輸入框');
          return;
        }
        
        const qty = parseInt(qtyInput.value) || 1;
        console.log('📦 選擇數量:', qty);
        
        const cart = getCart();
        console.log('🛍️ 當前購物車:', cart);
        
        const existing = cart.find(item => item.productId === id);
        if (existing) {
          existing.quantity += qty;
          console.log('✏️ 更新現有商品數量');
        } else {
          cart.push({ productId: id, quantity: qty });
          console.log('➕ 添加新商品到購物車');
        }
        
        saveCart(cart);
        console.log('💾 購物車已儲存');
        
        // 更美觀的提示
        showNotification('✅ 已加入購物車！', 'success');
        
        // 重置數量為1
        qtyInput.value = 1;
        
        updateCartSummary();
        console.log('🔄 購物車摘要已更新');
      }
      
      // 前往結帳
      function goToCheckout() {
        window.location.href = '/checkout';
      }
      
      // 顯示購物車詳情
      function showCartDetails() {
        document.getElementById('cart-details').style.display = 'block';
      }
      
      // 關閉購物車詳情
      function closeCartDetails() {
        document.getElementById('cart-details').style.display = 'none';
      }
      
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#4CAF50' : '#2196F3'};
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 1000;
          animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }
      
      // 加入CSS動畫
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      function updateCartSummary() {
        const cart = getCart();
        let html = '';
        let subtotal = 0;
        
        cart.forEach(item => {
          const product = products.find(p => p.id === item.productId);
          if (!product) return;
          
          let line = `
            <li class="cart-item">
              <span class="item-name">${product.name}</span>
              <span class="item-qty">× ${item.quantity}${item.selectedUnit ? ` (${item.selectedUnit})` : ''}</span>
              <span class="item-price">`;
          
          if (product.is_priced_item) {
            line += '待確認';
          } else {
            const lineTotal = Number(product.price) * Number(item.quantity);
            line += `$${lineTotal}`;
            subtotal += lineTotal;
          }
          
          line += '</span></li>';
          html += line;
        });
        
        // 更新購物車列表
        const cartList = document.getElementById('cart-list');
        if (cartList) {
          cartList.innerHTML = html;
        }
        
        // 更新小計
        const cartSubtotal = document.getElementById('cart-subtotal');
        if (cartSubtotal) {
          cartSubtotal.innerText = subtotal;
        }
        
        // 顯示/隱藏購物車底欄
        const cartBottom = document.getElementById('cart-bottom');
        if (cartBottom) {
          cartBottom.style.display = cart.length > 0 ? 'block' : 'none';
        }
      }
      // 🕰️ 營業時間相關函數
      async function loadBusinessHours() {
        try {
          const response = await fetch('/api/business-hours');
          if (response.ok) {
            const hours = await response.json();
            updateBusinessHoursDisplay(hours);
          }
        } catch (error) {
          console.error('載入營業時間失敗:', error);
        }
      }
      
      function updateBusinessHoursDisplay(hours) {
        const hoursList = document.getElementById('hours-list');
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const dayNames = ['星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
        
        let html = '';
        days.forEach((day, index) => {
          const dayData = hours[day];
          html += `
            <div class="hours-item">
              <span class="day-name">${dayNames[index]}</span>
              <span class="day-hours${dayData.closed ? ' closed' : ''}">${
                dayData.closed ? '公休' : `${dayData.open} - ${dayData.close}`
              }</span>
            </div>
          `;
        });
        
        if (hoursList) {
          hoursList.innerHTML = html;
        }
      }
      
      function showBusinessHours() {
        const modal = document.getElementById('business-hours-modal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }
      
      function closeBusinessHours() {
        const modal = document.getElementById('business-hours-modal');
        if (modal) {
          modal.style.display = 'none';
        }
        
        // 記錄用戶已看過營業時間
        localStorage.setItem('hasSeenBusinessHours', 'true');
      }
      
      // 檢查是否需要顯示營業時間
      function checkBusinessHoursDisplay() {
        const hasSeenBefore = localStorage.getItem('hasSeenBusinessHours');
        if (!hasSeenBefore) {
          // 等待 1 秒後顯示，讓頁面載入完成
          setTimeout(showBusinessHours, 1000);
        }
      }
      
      // 📱 商品彈出視窗功能
      function openProductModal(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        currentModalProduct = product;
        
        // 更新商品圖片
        const modalImage = document.getElementById('modal-image');
        if (product.image_url && product.image_url.startsWith('/uploads/')) {
          // 真實上傳的圖片
          modalImage.innerHTML = `<img src="${product.image_url}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
        } else if (product.image_url) {
          // emoji圖片
          modalImage.textContent = product.image_url;
        } else {
          // 預設emoji（舊邏輯）
          if (product.name.includes('高麗菜')) {
            modalImage.textContent = '🥬';
          } else if (product.name.includes('番茄')) {
            modalImage.textContent = '🍅';
          } else if (product.name.includes('胡蘿蔔')) {
            modalImage.textContent = '🥕';
          } else if (product.name.includes('小黃瓜')) {
            modalImage.textContent = '🥒';
          } else if (product.name.includes('洋蔥')) {
            modalImage.textContent = '🧅';
          } else if (product.name.includes('玉米')) {
            modalImage.textContent = '🌽';
          } else if (product.name.includes('馬鈴薯')) {
            modalImage.textContent = '🥔';
          } else {
            modalImage.textContent = '🥬';
          }
        }
        
        // 更新標籤
        const modalBadge = document.getElementById('modal-badge');
        const badgeClasses = ['hot', 'new', 'limited', 'recommend'];
        const badgeTexts = ['熱銷', '新品', '限量', '推薦'];
        const badgeIndex = product.id % 4;
        modalBadge.className = `modal-badge ${badgeClasses[badgeIndex]}`;
        modalBadge.textContent = badgeTexts[badgeIndex];
        
        // 更新標題和描述
        document.getElementById('modal-title').textContent = product.name;
        document.getElementById('modal-description').textContent = 
          product.is_priced_item ? '新鮮計價商品，秤重後確認價格，無運費設計！' : '新鮮優質，精選品質保證！當季最新鮮的蔬果。';
        
        // 更新價格選項
        const priceOptions = document.getElementById('modal-price-options');
        
        // 檢查是否有自訂選項群組
        if (product.optionGroups && product.optionGroups.length > 0) {
          let optionsHtml = '';
          
          product.optionGroups.forEach(group => {
            if (group.options && group.options.length > 0) {
              optionsHtml += `<div class="option-group-title">${group.name}</div>`;
              
              group.options.forEach((option, index) => {
                const finalPrice = (product.price || 0) + (option.price_modifier || 0);
                const isActive = option.is_default || index === 0 ? 'active' : '';
                
                optionsHtml += `
                  <div class="modal-price-item ${isActive}" onclick="selectPriceOption(this)" 
                       data-option-id="${option.id}" data-option-name="${option.name}" 
                       data-price-modifier="${option.price_modifier}">
                    <div class="price-main">${option.name}:$${finalPrice}</div>
                    <div class="price-desc">${option.description || ''}</div>
                  </div>
                `;
              });
            }
          });
          
          priceOptions.innerHTML = optionsHtml;
        } else if (product.is_priced_item) {
          // 計價商品的傳統顯示
          priceOptions.innerHTML = `
            <div class="modal-price-item active" onclick="selectPriceOption(this)">
              <div class="price-main">1斤約${Math.floor(Math.random() * 50) + 100}~</div>
              <div class="price-desc">幫您秤重好後告知您金額</div>
            </div>
          `;
        } else {
          // 固定價格商品的傳統顯示（舊邏輯）
          if (product.id % 3 === 1) {
            priceOptions.innerHTML = `
              <div class="modal-price-item active" onclick="selectPriceOption(this)">
                <div class="price-main">1斤:${product.price}</div>
              </div>
            `;
          } else if (product.id % 3 === 2) {
            priceOptions.innerHTML = `
              <div class="modal-price-item active" onclick="selectPriceOption(this)">
                <div class="price-main">5顆:${Math.floor(product.price * 0.8)}</div>
              </div>
              <div class="modal-price-item" onclick="selectPriceOption(this)">
                <div class="price-main">10顆:${Math.floor(product.price * 1.5)}</div>
              </div>
            `;
          } else {
            priceOptions.innerHTML = `
              <div class="modal-price-item active" onclick="selectPriceOption(this)">
                <div class="price-main">半斤:${Math.floor(product.price * 0.6)}</div>
              </div>
              <div class="modal-price-item" onclick="selectPriceOption(this)">
                <div class="price-main">1斤:${product.price}</div>
              </div>
            `;
          }
        }
        
        // 重置數量
        document.getElementById('modal-qty').value = 1;
        
        // 顯示彈出視窗
        document.getElementById('product-modal').style.display = 'flex';
      }
      
      function closeProductModal() {
        document.getElementById('product-modal').style.display = 'none';
        currentModalProduct = null;
      }
      
      // 添加ESC鍵關閉功能
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          const modal = document.getElementById('product-modal');
          if (modal && modal.style.display !== 'none') {
            closeProductModal();
          }
        }
      });
      
      function selectPriceOption(element) {
        // 移除所有active狀態
        document.querySelectorAll('.modal-price-item').forEach(item => {
          item.classList.remove('active');
        });
        // 添加active到選中的選項
        element.classList.add('active');
      }
      
      function modalIncreaseQty() {
        const qtyInput = document.getElementById('modal-qty');
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty < 99) {
          qtyInput.value = currentQty + 1;
        }
      }
      
      function modalDecreaseQty() {
        const qtyInput = document.getElementById('modal-qty');
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty > 1) {
          qtyInput.value = currentQty - 1;
        }
      }
      
      function addToCartFromModal() {
        if (!currentModalProduct) return;
        
        const qty = parseInt(document.getElementById('modal-qty').value) || 1;
        
        // 獲取選中的價格選項
        const activeOption = document.querySelector('.modal-price-item.active');
        let selectedUnit = currentModalProduct.unit_hint || '每個';
        let unitQuantity = qty;
        let selectedOptionId = null;
        let selectedOptionName = null;
        let priceModifier = 0;
        
        if (activeOption) {
          // 檢查是否為自訂選項
          if (activeOption.dataset.optionId) {
            selectedOptionId = activeOption.dataset.optionId;
            selectedOptionName = activeOption.dataset.optionName;
            priceModifier = parseFloat(activeOption.dataset.priceModifier || 0);
            selectedUnit = selectedOptionName; // 使用選項名稱作為單位
          } else {
            // 傳統選項解析邏輯
            const priceText = activeOption.querySelector('.price-main').textContent;
            if (priceText.includes('半斤')) {
              selectedUnit = '半斤';
            } else if (priceText.includes('1斤')) {
              selectedUnit = '每斤';
            } else if (priceText.includes('5顆')) {
              selectedUnit = '每顆';
              unitQuantity = qty * 5; // 5顆選項
            } else if (priceText.includes('10顆')) {
              selectedUnit = '每顆';
              unitQuantity = qty * 10; // 10顆選項
            } else if (priceText.includes('半顆')) {
              selectedUnit = '半顆';
            } else if (priceText.includes('1顆')) {
              selectedUnit = '每顆';
            }
          }
        }
        
        const cart = getCart();
        
        const existing = cart.find(item => 
          item.productId === currentModalProduct.id && 
          item.selectedUnit === selectedUnit &&
          item.selectedOptionId === selectedOptionId
        );
        
        if (existing) {
          existing.quantity += qty;
          existing.unitQuantity += unitQuantity;
        } else {
          cart.push({ 
            productId: currentModalProduct.id, 
            quantity: qty,
            selectedUnit: selectedUnit,
            unitQuantity: unitQuantity,
            selectedOptionId: selectedOptionId,
            selectedOptionName: selectedOptionName,
            priceModifier: priceModifier
          });
        }
        
        saveCart(cart);
        showNotification('✅ 已加入購物車！', 'success');
        updateCartSummary();
        closeProductModal();
      }
      
      // 商品搜尋功能
      function performSearch() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const productItems = document.querySelectorAll('.product-item');
        const clearButton = document.getElementById('search-clear');
        
        // 顯示/隱藏清除按鈕
        clearButton.style.display = searchTerm ? 'block' : 'none';
        
        let visibleCount = 0;
        
        productItems.forEach(item => {
          const productTitle = item.querySelector('.product-title-mobile').textContent.toLowerCase();
          const isMatch = searchTerm === '' || productTitle.includes(searchTerm);
          
          if (isMatch) {
            item.style.display = 'flex';
            visibleCount++;
          } else {
            item.style.display = 'none';
          }
        });
        
        // 顯示搜尋結果提示
        showSearchResults(searchTerm, visibleCount);
        
        // 重置分類選擇
        if (searchTerm) {
          document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
          });
        }
      }
      
      function clearSearch() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-clear').style.display = 'none';
        
        // 顯示所有商品
        document.querySelectorAll('.product-item').forEach(item => {
          item.style.display = 'flex';
        });
        
        // 重新啟用推薦分類
        document.querySelectorAll('.category-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector('[data-category="all"]').classList.add('active');
        
        // 清除搜尋結果提示
        hideSearchResults();
      }
      
      function showSearchResults(searchTerm, count) {
        let existingResult = document.getElementById('search-results');
        
        if (searchTerm && searchTerm.length > 0) {
          if (!existingResult) {
            existingResult = document.createElement('div');
            existingResult.id = 'search-results';
            existingResult.className = 'search-results-info';
            const productsSection = document.querySelector('.products-section');
            productsSection.insertBefore(existingResult, productsSection.firstChild);
          }
          
          existingResult.innerHTML = `
            <div class="search-result-text">
              🔍 搜尋「<strong>${searchTerm}</strong>」找到 ${count} 項商品
            </div>
          `;
          existingResult.style.display = 'block';
        } else {
          hideSearchResults();
        }
      }
      
      function hideSearchResults() {
        const existingResult = document.getElementById('search-results');
        if (existingResult) {
          existingResult.style.display = 'none';
        }
      }
      
      // 分類篩選功能改進
      function filterByCategory(category) {
        const productItems = document.querySelectorAll('.product-item');
        
        // 清除搜尋
        document.getElementById('search-input').value = '';
        document.getElementById('search-clear').style.display = 'none';
        hideSearchResults();
        
        productItems.forEach(item => {
          const itemCategory = item.getAttribute('data-category');
          const isMatch = category === 'all' || itemCategory === category;
          item.style.display = isMatch ? 'flex' : 'none';
        });
      }

      window.onload = function() {
        console.log('🌐 頁面已載入');
        console.log('📦 產品資料:', products);
        console.log('🛒 購物車函數可用:', typeof addToCart);
        updateCartSummary();
        
        // 載入營業時間資料
        loadBusinessHours();
        
        // 檢查是否需要顯示營業時間
        checkBusinessHoursDisplay();
        
        // 設定搜尋功能
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          // 即時搜尋
          searchInput.addEventListener('input', function() {
            setTimeout(performSearch, 100); // 延遲100ms避免過度觸發
          });
          
          // 按Enter搜尋
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              performSearch();
            }
          });
        }
        
        // 設定分類按鈕點擊事件
        document.querySelectorAll('.category-tab').forEach(tab => {
          tab.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            
            // 更新active狀態
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // 篩選商品
            filterByCategory(category);
          });
        });
      };
    </script>
  </body>
</html>