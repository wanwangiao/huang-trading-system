<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª æ„é®®è”¬ï½œæ–°é®®è”¬æœå¤–é€ - æ‰‹æ©Ÿç‰ˆ</title>
    <link rel="stylesheet" href="/css/styles.css">
  </head>
  <body>
    <!-- é ‚éƒ¨å°èˆª -->
    <header class="main-header">
      <div class="header-content">
        <div class="store-info">
          <h1 class="store-name">èª æ„é®®è”¬</h1>
          <div class="store-stats">
            <span class="views">ğŸ‘ 5489 views</span>
            <span class="store-badge">åº—å®¶è³‡è¨Š</span>
          </div>
        </div>
        <% if (sessionLine) { %>
          <div class="line-status connected">
            âœ… LINE å·²ç¶å®šï¼ˆ<%= sessionLine.displayName %>ï¼‰
          </div>
        <% } else { %>
          <div class="line-status">
            <a href="/auth/line/login" class="line-connect">ğŸ“± ç¶å®š LINE</a>
          </div>
        <% } %>
      </div>
    </header>

    <!-- æœå°‹åŠŸèƒ½ -->
    <div class="search-section">
      <div class="search-container">
        <div class="search-input-wrapper">
          <input type="text" id="search-input" placeholder="ğŸ” æœå°‹å•†å“åç¨±..." class="search-input">
          <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display: none;">âœ•</button>
        </div>
      </div>
    </div>

    <!-- å•†å“åˆ†é¡å°èˆª -->
    <nav class="category-nav">
      <div class="category-tabs">
        <button class="category-tab active" data-category="all">æ¨è–¦</button>
        <button class="category-tab" data-category="vegetables">ä¸€èˆ¬è”¬èœ</button>
        <button class="category-tab" data-category="leafy">è‘‰èœé¡</button>
        <button class="category-tab" data-category="fruits">æ°´æœ</button>
        <button class="category-tab" data-category="proxy">ä»£è³¼</button>
      </div>
    </nav>
    
    <!-- ä¸»è¦å…§å®¹å€åŸŸ -->
    <main class="main-content">
      <!-- æœå‹™å…¬å‘Šå€ -->
      <div class="service-announcement">
        <h3>ğŸ“¢ è¨Šæ¯å…¬å‘Š</h3>
        <div class="announcement-content">
          <p><strong>æœå‹™ç¯„åœï¼š</strong>ä¸‰å³½ã€åŒ—å¤§ç‰¹å€ã€é¶¯æ­Œã€æ¨¹æ—ã€åœŸåŸ</p>
          <p><strong>å¤–é€é–€æª»ï¼š</strong>å–®ç­†è¨‚å–®æ»¿200å…ƒå³å¯å¤–é€å–”ï¼ï¼(å…å¤–é€è²»)</p>
          <p><strong>çµå¸³æ–¹å¼ï¼š</strong>ç¾é‡‘ã€LINEPAYã€éŠ€è¡Œè½‰å¸³</p>
          <p><strong>é ç´„æœå‹™ï¼š</strong>ç•¶å¤©11é»å‰ä¸‹å–®ç•¶å¤©é€é”ï¼æ¯æ—¥ä¸‹åˆ14é»å¾Œé–‹æ”¾éš”æ—¥é ç´„</p>
        </div>
      </div>

      <!-- å•†å“å€åŸŸ -->
      <div class="products-section">
        <% if (!products || products.length === 0) { %>
          <div class="empty-products">
            <p>ç›®å‰æ²’æœ‰å•†å“ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>
          </div>
        <% } else { %>
          <div class="products-list mobile-layout">
            <% products.forEach(function(product) { %>
              <div class="product-item mobile-item" data-category="<%= product.is_priced_item ? 'proxy' : 'vegetables' %>" onclick="openProductModal(<%= product.id %>)">
                <!-- å·¦å´åœ–ç‰‡ -->
                <div class="product-image-left">
                  <div class="product-image-container">
                    <% if (product.image_url && product.image_url.startsWith('/uploads/')) { %>
                      <img src="<%= product.image_url %>" alt="<%= product.name %>" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
                    <% } else if (product.image_url) { %>
                      <%= product.image_url %>
                    <% } else if (product.name.includes('é«˜éº—èœ')) { %>
                      ğŸ¥¬
                    <% } else if (product.name.includes('ç•ªèŒ„')) { %>
                      ğŸ…
                    <% } else if (product.name.includes('èƒ¡è˜¿è””')) { %>
                      ğŸ¥•
                    <% } else if (product.name.includes('å°é»ƒç“œ')) { %>
                      ğŸ¥’
                    <% } else if (product.name.includes('æ´‹è”¥')) { %>
                      ğŸ§…
                    <% } else if (product.name.includes('ç‰ç±³')) { %>
                      ğŸŒ½
                    <% } else if (product.name.includes('é¦¬éˆ´è–¯')) { %>
                      ğŸ¥”
                    <% } else { %>
                      ğŸ¥¬
                    <% } %>
                  </div>
                  <!-- å•†å“æ¨™ç±¤ -->
                  <% if (product.id % 4 === 1) { %>
                    <div class="product-badge hot">ç†±éŠ·</div>
                  <% } else if (product.id % 4 === 2) { %>
                    <div class="product-badge new">æ–°å“</div>
                  <% } else if (product.id % 4 === 3) { %>
                    <div class="product-badge limited">é™é‡</div>
                  <% } else if (product.id % 4 === 0) { %>
                    <div class="product-badge recommend">æ¨è–¦</div>
                  <% } %>
                </div>
                
                <!-- å³å´å…§å®¹ -->
                <div class="product-content-right">
                  <h3 class="product-title-mobile"><%= product.name %></h3>
                  
                  <!-- åƒ¹æ ¼å€åŸŸ -->
                  <div class="product-price-mobile">
                    <% if (product.is_priced_item) { %>
                      <!-- è¨ˆåƒ¹å•†å“ -->
                      <div class="price-range">
                        <span class="price-from">1æ–¤ç´„<%= Math.floor(Math.random() * 50) + 100 %>~</span>
                      </div>
                      <div class="price-note">å¹«æ‚¨ç§¤é‡å¥½å¾Œå‘ŠçŸ¥æ‚¨é‡‘é¡~</div>
                    <% } else { %>
                      <!-- å›ºå®šåƒ¹æ ¼å•†å“ï¼Œæ¨¡æ“¬å¤šè¦æ ¼ -->
                      <% if (product.id % 3 === 1) { %>
                        <div class="multi-price">
                          <span class="price-option">1æ–¤:<%= product.price %></span>
                        </div>
                      <% } else if (product.id % 3 === 2) { %>
                        <div class="multi-price">
                          <span class="price-option">5é¡†:<%= Math.floor(product.price * 0.8) %></span>
                          <span class="price-option">10é¡†:<%= Math.floor(product.price * 1.5) %></span>
                        </div>
                      <% } else { %>
                        <div class="multi-price">
                          <span class="price-option">åŠæ–¤:<%= Math.floor(product.price * 0.6) %></span>
                          <span class="price-option">1æ–¤:<%= product.price %></span>
                        </div>
                      <% } %>
                    <% } %>
                  </div>
                  
                  <!-- å•†å“æè¿° -->
                  <div class="product-description">
                    <% if (product.is_priced_item) { %>
                      æ–°é®®è¨ˆåƒ¹å•†å“ï¼Œç§¤é‡å¾Œç¢ºèªåƒ¹æ ¼
                    <% } else { %>
                      æ–°é®®å„ªè³ªï¼Œç²¾é¸å“è³ªä¿è­‰ï¼
                    <% } %>
                  </div>
                </div>
              </div>
            <% }); %>
          </div>
        <% } %>
      </div>
    </main>
    <!-- å›ºå®šåº•éƒ¨è³¼ç‰©è»Š -->
    <div class="cart-bottom" id="cart-bottom" style="display: none;">
      <div class="cart-summary">
        <div class="cart-info">
          <span class="cart-total">åˆè¨ˆ: $<span id="cart-subtotal">0</span> å…ƒ</span>
          <span class="cart-note">ä¾†å»çµå¸³</span>
        </div>
        <button class="checkout-btn" id="checkout-btn" onclick="goToCheckout()">
          <span class="checkout-arrow">â–¶</span>
        </button>
      </div>
    </div>

    <!-- è³¼ç‰©è»Šè©³æƒ…å½ˆçª—ï¼ˆéš±è—ï¼‰ -->
    <div class="cart-details" id="cart-details" style="display: none;">
      <div class="cart-header">
        <h3>è³¼ç‰©è»Šæ˜ç´°</h3>
        <button class="close-cart" onclick="closeCartDetails()">âœ•</button>
      </div>
      <ul id="cart-list" class="cart-items"></ul>
      <div class="cart-footer">
        <p class="cart-note-text">ï¼ˆè¨ˆåƒ¹å•†å“å°‡æ–¼ç§¤é‡å¾Œæ›´æ–°é‡‘é¡ï¼‰</p>
      </div>
    </div>

    <!-- ğŸ•°ï¸ ç‡Ÿæ¥­æ™‚é–“å½ˆå‡ºè¦–çª— -->
    <div class="business-hours-modal" id="business-hours-modal">
      <div class="business-hours-content">
        <div class="hours-title">
          ğŸ•°ï¸ ç‡Ÿæ¥­æ™‚é–“
        </div>
        <div class="hours-list" id="hours-list">
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸä¸€</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸäºŒ</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸä¸‰</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸå››</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸäº”</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸå…­</span>
            <span class="day-hours">06:00 - 13:00</span>
          </div>
          <div class="hours-item">
            <span class="day-name">æ˜ŸæœŸæ—¥</span>
            <span class="day-hours closed">å…¬ä¼‘</span>
          </div>
        </div>
        <button class="hours-close-btn" onclick="closeBusinessHours()">
          çŸ¥é“äº†
        </button>
      </div>
    </div>
    <!-- ğŸ“± å•†å“è©³æƒ…å½ˆå‡ºè¦–çª— -->
    <div class="product-modal" id="product-modal" style="display: none;" onclick="closeProductModal()">
      <div class="product-modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <button class="modal-close" onclick="closeProductModal()">âœ•</button>
        </div>
        
        <div class="modal-product-image">
          <div class="modal-image-container" id="modal-image">
            <!-- å‹•æ…‹æ›´æ–°å•†å“åœ–ç‰‡ -->
          </div>
          <div class="modal-badge" id="modal-badge">æ–°å“</div>
        </div>
        
        <div class="modal-product-info">
          <h3 class="modal-title" id="modal-title">å•†å“åç¨±</h3>
          <div class="modal-description" id="modal-description">
            æ–°é®®å„ªè³ªï¼Œç²¾é¸å“è³ªä¿è­‰ï¼ç•¶å­£æœ€æ–°é®®çš„è”¬æœï¼Œç‚ºæ‚¨çš„é¤æ¡Œå¢æ·»å¥åº·èˆ‡ç¾å‘³ã€‚
          </div>
        </div>
        
        <div class="modal-price-section">
          <div class="modal-price-options" id="modal-price-options">
            <!-- å‹•æ…‹ç”Ÿæˆåƒ¹æ ¼é¸é … -->
          </div>
        </div>
        
        <div class="modal-quantity-section">
          <div class="modal-quantity-label">æ•¸é‡é¸æ“‡</div>
          <div class="modal-quantity-selector">
            <button class="modal-qty-btn" onclick="modalDecreaseQty()">-</button>
            <input type="number" id="modal-qty" value="1" min="1" max="99" readonly>
            <button class="modal-qty-btn" onclick="modalIncreaseQty()">+</button>
          </div>
        </div>
        
        <div class="modal-actions">
          <button class="modal-add-cart" onclick="addToCartFromModal()">
            ğŸ›’ åŠ å…¥è³¼ç‰©è»Š
          </button>
        </div>
      </div>
    </div>
    
    <script>
      // å¾ä¼ºæœç«¯è¤‡è£½ products è‡³å‰ç«¯ä½¿ç”¨
      const products = <%- JSON.stringify(products) %>;
      let currentModalProduct = null;
      function getCart() {
        try {
          return JSON.parse(localStorage.getItem('cart') || '[]');
        } catch (e) {
          return [];
        }
      }
      function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
      }
      // æ•¸é‡æ§åˆ¶å‡½æ•¸
      function increaseQty(id) {
        const qtyInput = document.getElementById('qty-' + id);
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty < 99) {
          qtyInput.value = currentQty + 1;
        }
      }
      
      function decreaseQty(id) {
        const qtyInput = document.getElementById('qty-' + id);
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty > 1) {
          qtyInput.value = currentQty - 1;
        }
      }

      function addToCart(id) {
        console.log('ğŸ›’ åŠ å…¥è³¼ç‰©è»Šè¢«é»æ“Šï¼Œå•†å“ID:', id);
        
        const qtyInput = document.getElementById('qty-' + id);
        if (!qtyInput) {
          console.error('âŒ æ‰¾ä¸åˆ°æ•¸é‡è¼¸å…¥æ¡†:', 'qty-' + id);
          alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æ•¸é‡è¼¸å…¥æ¡†');
          return;
        }
        
        const qty = parseInt(qtyInput.value) || 1;
        console.log('ğŸ“¦ é¸æ“‡æ•¸é‡:', qty);
        
        const cart = getCart();
        console.log('ğŸ›ï¸ ç•¶å‰è³¼ç‰©è»Š:', cart);
        
        const existing = cart.find(item => item.productId === id);
        if (existing) {
          existing.quantity += qty;
          console.log('âœï¸ æ›´æ–°ç¾æœ‰å•†å“æ•¸é‡');
        } else {
          cart.push({ productId: id, quantity: qty });
          console.log('â• æ·»åŠ æ–°å•†å“åˆ°è³¼ç‰©è»Š');
        }
        
        saveCart(cart);
        console.log('ğŸ’¾ è³¼ç‰©è»Šå·²å„²å­˜');
        
        // æ›´ç¾è§€çš„æç¤º
        showNotification('âœ… å·²åŠ å…¥è³¼ç‰©è»Šï¼', 'success');
        
        // é‡ç½®æ•¸é‡ç‚º1
        qtyInput.value = 1;
        
        updateCartSummary();
        console.log('ğŸ”„ è³¼ç‰©è»Šæ‘˜è¦å·²æ›´æ–°');
      }
      
      // å‰å¾€çµå¸³
      function goToCheckout() {
        window.location.href = '/checkout';
      }
      
      // é¡¯ç¤ºè³¼ç‰©è»Šè©³æƒ…
      function showCartDetails() {
        document.getElementById('cart-details').style.display = 'block';
      }
      
      // é—œé–‰è³¼ç‰©è»Šè©³æƒ…
      function closeCartDetails() {
        document.getElementById('cart-details').style.display = 'none';
      }
      
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'success' ? '#4CAF50' : '#2196F3'};
          color: white;
          padding: 1rem 1.5rem;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3);
          z-index: 1000;
          animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.style.animation = 'slideOut 0.3s ease';
          setTimeout(() => notification.remove(), 300);
        }, 2000);
      }
      
      // åŠ å…¥CSSå‹•ç•«
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
      function updateCartSummary() {
        const cart = getCart();
        let html = '';
        let subtotal = 0;
        
        cart.forEach(item => {
          const product = products.find(p => p.id === item.productId);
          if (!product) return;
          
          let line = `
            <li class="cart-item">
              <span class="item-name">${product.name}</span>
              <span class="item-qty">Ã— ${item.quantity}${item.selectedUnit ? ` (${item.selectedUnit})` : ''}</span>
              <span class="item-price">`;
          
          if (product.is_priced_item) {
            line += 'å¾…ç¢ºèª';
          } else {
            const lineTotal = Number(product.price) * Number(item.quantity);
            line += `$${lineTotal}`;
            subtotal += lineTotal;
          }
          
          line += '</span></li>';
          html += line;
        });
        
        // æ›´æ–°è³¼ç‰©è»Šåˆ—è¡¨
        const cartList = document.getElementById('cart-list');
        if (cartList) {
          cartList.innerHTML = html;
        }
        
        // æ›´æ–°å°è¨ˆ
        const cartSubtotal = document.getElementById('cart-subtotal');
        if (cartSubtotal) {
          cartSubtotal.innerText = subtotal;
        }
        
        // é¡¯ç¤º/éš±è—è³¼ç‰©è»Šåº•æ¬„
        const cartBottom = document.getElementById('cart-bottom');
        if (cartBottom) {
          cartBottom.style.display = cart.length > 0 ? 'block' : 'none';
        }
      }
      // ğŸ•°ï¸ ç‡Ÿæ¥­æ™‚é–“ç›¸é—œå‡½æ•¸
      async function loadBusinessHours() {
        try {
          const response = await fetch('/api/business-hours');
          if (response.ok) {
            const hours = await response.json();
            updateBusinessHoursDisplay(hours);
          }
        } catch (error) {
          console.error('è¼‰å…¥ç‡Ÿæ¥­æ™‚é–“å¤±æ•—:', error);
        }
      }
      
      function updateBusinessHoursDisplay(hours) {
        const hoursList = document.getElementById('hours-list');
        const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const dayNames = ['æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­', 'æ˜ŸæœŸæ—¥'];
        
        let html = '';
        days.forEach((day, index) => {
          const dayData = hours[day];
          html += `
            <div class="hours-item">
              <span class="day-name">${dayNames[index]}</span>
              <span class="day-hours${dayData.closed ? ' closed' : ''}">${
                dayData.closed ? 'å…¬ä¼‘' : `${dayData.open} - ${dayData.close}`
              }</span>
            </div>
          `;
        });
        
        if (hoursList) {
          hoursList.innerHTML = html;
        }
      }
      
      function showBusinessHours() {
        const modal = document.getElementById('business-hours-modal');
        if (modal) {
          modal.style.display = 'flex';
        }
      }
      
      function closeBusinessHours() {
        const modal = document.getElementById('business-hours-modal');
        if (modal) {
          modal.style.display = 'none';
        }
        
        // è¨˜éŒ„ç”¨æˆ¶å·²çœ‹éç‡Ÿæ¥­æ™‚é–“
        localStorage.setItem('hasSeenBusinessHours', 'true');
      }
      
      // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºç‡Ÿæ¥­æ™‚é–“
      function checkBusinessHoursDisplay() {
        const hasSeenBefore = localStorage.getItem('hasSeenBusinessHours');
        if (!hasSeenBefore) {
          // ç­‰å¾… 1 ç§’å¾Œé¡¯ç¤ºï¼Œè®“é é¢è¼‰å…¥å®Œæˆ
          setTimeout(showBusinessHours, 1000);
        }
      }
      
      // ğŸ“± å•†å“å½ˆå‡ºè¦–çª—åŠŸèƒ½
      function openProductModal(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        currentModalProduct = product;
        
        // æ›´æ–°å•†å“åœ–ç‰‡
        const modalImage = document.getElementById('modal-image');
        if (product.image_url && product.image_url.startsWith('/uploads/')) {
          // çœŸå¯¦ä¸Šå‚³çš„åœ–ç‰‡
          modalImage.innerHTML = `<img src="${product.image_url}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">`;
        } else if (product.image_url) {
          // emojiåœ–ç‰‡
          modalImage.textContent = product.image_url;
        } else {
          // é è¨­emojiï¼ˆèˆŠé‚è¼¯ï¼‰
          if (product.name.includes('é«˜éº—èœ')) {
            modalImage.textContent = 'ğŸ¥¬';
          } else if (product.name.includes('ç•ªèŒ„')) {
            modalImage.textContent = 'ğŸ…';
          } else if (product.name.includes('èƒ¡è˜¿è””')) {
            modalImage.textContent = 'ğŸ¥•';
          } else if (product.name.includes('å°é»ƒç“œ')) {
            modalImage.textContent = 'ğŸ¥’';
          } else if (product.name.includes('æ´‹è”¥')) {
            modalImage.textContent = 'ğŸ§…';
          } else if (product.name.includes('ç‰ç±³')) {
            modalImage.textContent = 'ğŸŒ½';
          } else if (product.name.includes('é¦¬éˆ´è–¯')) {
            modalImage.textContent = 'ğŸ¥”';
          } else {
            modalImage.textContent = 'ğŸ¥¬';
          }
        }
        
        // æ›´æ–°æ¨™ç±¤
        const modalBadge = document.getElementById('modal-badge');
        const badgeClasses = ['hot', 'new', 'limited', 'recommend'];
        const badgeTexts = ['ç†±éŠ·', 'æ–°å“', 'é™é‡', 'æ¨è–¦'];
        const badgeIndex = product.id % 4;
        modalBadge.className = `modal-badge ${badgeClasses[badgeIndex]}`;
        modalBadge.textContent = badgeTexts[badgeIndex];
        
        // æ›´æ–°æ¨™é¡Œå’Œæè¿°
        document.getElementById('modal-title').textContent = product.name;
        document.getElementById('modal-description').textContent = 
          product.is_priced_item ? 'æ–°é®®è¨ˆåƒ¹å•†å“ï¼Œç§¤é‡å¾Œç¢ºèªåƒ¹æ ¼ï¼Œç„¡é‹è²»è¨­è¨ˆï¼' : 'æ–°é®®å„ªè³ªï¼Œç²¾é¸å“è³ªä¿è­‰ï¼ç•¶å­£æœ€æ–°é®®çš„è”¬æœã€‚';
        
        // æ›´æ–°åƒ¹æ ¼é¸é …
        const priceOptions = document.getElementById('modal-price-options');
        
        // æª¢æŸ¥æ˜¯å¦æœ‰è‡ªè¨‚é¸é …ç¾¤çµ„
        if (product.optionGroups && product.optionGroups.length > 0) {
          let optionsHtml = '';
          
          product.optionGroups.forEach(group => {
            if (group.options && group.options.length > 0) {
              optionsHtml += `<div class="option-group-title">${group.name}</div>`;
              
              group.options.forEach((option, index) => {
                const finalPrice = (product.price || 0) + (option.price_modifier || 0);
                const isActive = option.is_default || index === 0 ? 'active' : '';
                
                optionsHtml += `
                  <div class="modal-price-item ${isActive}" onclick="selectPriceOption(this)" 
                       data-option-id="${option.id}" data-option-name="${option.name}" 
                       data-price-modifier="${option.price_modifier}">
                    <div class="price-main">${option.name}:$${finalPrice}</div>
                    <div class="price-desc">${option.description || ''}</div>
                  </div>
                `;
              });
            }
          });
          
          priceOptions.innerHTML = optionsHtml;
        } else if (product.is_priced_item) {
          // è¨ˆåƒ¹å•†å“çš„å‚³çµ±é¡¯ç¤º
          priceOptions.innerHTML = `
            <div class="modal-price-item active" onclick="selectPriceOption(this)">
              <div class="price-main">1æ–¤ç´„${Math.floor(Math.random() * 50) + 100}~</div>
              <div class="price-desc">å¹«æ‚¨ç§¤é‡å¥½å¾Œå‘ŠçŸ¥æ‚¨é‡‘é¡</div>
            </div>
          `;
        } else {
          // å›ºå®šåƒ¹æ ¼å•†å“çš„å‚³çµ±é¡¯ç¤ºï¼ˆèˆŠé‚è¼¯ï¼‰
          if (product.id % 3 === 1) {
            priceOptions.innerHTML = `
              <div class="modal-price-item active" onclick="selectPriceOption(this)">
                <div class="price-main">1æ–¤:${product.price}</div>
              </div>
            `;
          } else if (product.id % 3 === 2) {
            priceOptions.innerHTML = `
              <div class="modal-price-item active" onclick="selectPriceOption(this)">
                <div class="price-main">5é¡†:${Math.floor(product.price * 0.8)}</div>
              </div>
              <div class="modal-price-item" onclick="selectPriceOption(this)">
                <div class="price-main">10é¡†:${Math.floor(product.price * 1.5)}</div>
              </div>
            `;
          } else {
            priceOptions.innerHTML = `
              <div class="modal-price-item active" onclick="selectPriceOption(this)">
                <div class="price-main">åŠæ–¤:${Math.floor(product.price * 0.6)}</div>
              </div>
              <div class="modal-price-item" onclick="selectPriceOption(this)">
                <div class="price-main">1æ–¤:${product.price}</div>
              </div>
            `;
          }
        }
        
        // é‡ç½®æ•¸é‡
        document.getElementById('modal-qty').value = 1;
        
        // é¡¯ç¤ºå½ˆå‡ºè¦–çª—
        document.getElementById('product-modal').style.display = 'flex';
      }
      
      function closeProductModal() {
        document.getElementById('product-modal').style.display = 'none';
        currentModalProduct = null;
      }
      
      // æ·»åŠ ESCéµé—œé–‰åŠŸèƒ½
      document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
          const modal = document.getElementById('product-modal');
          if (modal && modal.style.display !== 'none') {
            closeProductModal();
          }
        }
      });
      
      function selectPriceOption(element) {
        // ç§»é™¤æ‰€æœ‰activeç‹€æ…‹
        document.querySelectorAll('.modal-price-item').forEach(item => {
          item.classList.remove('active');
        });
        // æ·»åŠ activeåˆ°é¸ä¸­çš„é¸é …
        element.classList.add('active');
      }
      
      function modalIncreaseQty() {
        const qtyInput = document.getElementById('modal-qty');
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty < 99) {
          qtyInput.value = currentQty + 1;
        }
      }
      
      function modalDecreaseQty() {
        const qtyInput = document.getElementById('modal-qty');
        const currentQty = parseInt(qtyInput.value) || 1;
        if (currentQty > 1) {
          qtyInput.value = currentQty - 1;
        }
      }
      
      function addToCartFromModal() {
        if (!currentModalProduct) return;
        
        const qty = parseInt(document.getElementById('modal-qty').value) || 1;
        
        // ç²å–é¸ä¸­çš„åƒ¹æ ¼é¸é …
        const activeOption = document.querySelector('.modal-price-item.active');
        let selectedUnit = currentModalProduct.unit_hint || 'æ¯å€‹';
        let unitQuantity = qty;
        let selectedOptionId = null;
        let selectedOptionName = null;
        let priceModifier = 0;
        
        if (activeOption) {
          // æª¢æŸ¥æ˜¯å¦ç‚ºè‡ªè¨‚é¸é …
          if (activeOption.dataset.optionId) {
            selectedOptionId = activeOption.dataset.optionId;
            selectedOptionName = activeOption.dataset.optionName;
            priceModifier = parseFloat(activeOption.dataset.priceModifier || 0);
            selectedUnit = selectedOptionName; // ä½¿ç”¨é¸é …åç¨±ä½œç‚ºå–®ä½
          } else {
            // å‚³çµ±é¸é …è§£æé‚è¼¯
            const priceText = activeOption.querySelector('.price-main').textContent;
            if (priceText.includes('åŠæ–¤')) {
              selectedUnit = 'åŠæ–¤';
            } else if (priceText.includes('1æ–¤')) {
              selectedUnit = 'æ¯æ–¤';
            } else if (priceText.includes('5é¡†')) {
              selectedUnit = 'æ¯é¡†';
              unitQuantity = qty * 5; // 5é¡†é¸é …
            } else if (priceText.includes('10é¡†')) {
              selectedUnit = 'æ¯é¡†';
              unitQuantity = qty * 10; // 10é¡†é¸é …
            } else if (priceText.includes('åŠé¡†')) {
              selectedUnit = 'åŠé¡†';
            } else if (priceText.includes('1é¡†')) {
              selectedUnit = 'æ¯é¡†';
            }
          }
        }
        
        const cart = getCart();
        
        const existing = cart.find(item => 
          item.productId === currentModalProduct.id && 
          item.selectedUnit === selectedUnit &&
          item.selectedOptionId === selectedOptionId
        );
        
        if (existing) {
          existing.quantity += qty;
          existing.unitQuantity += unitQuantity;
        } else {
          cart.push({ 
            productId: currentModalProduct.id, 
            quantity: qty,
            selectedUnit: selectedUnit,
            unitQuantity: unitQuantity,
            selectedOptionId: selectedOptionId,
            selectedOptionName: selectedOptionName,
            priceModifier: priceModifier
          });
        }
        
        saveCart(cart);
        showNotification('âœ… å·²åŠ å…¥è³¼ç‰©è»Šï¼', 'success');
        updateCartSummary();
        closeProductModal();
      }
      
      // å•†å“æœå°‹åŠŸèƒ½
      function performSearch() {
        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
        const productItems = document.querySelectorAll('.product-item');
        const clearButton = document.getElementById('search-clear');
        
        // é¡¯ç¤º/éš±è—æ¸…é™¤æŒ‰éˆ•
        clearButton.style.display = searchTerm ? 'block' : 'none';
        
        let visibleCount = 0;
        
        productItems.forEach(item => {
          const productTitle = item.querySelector('.product-title-mobile').textContent.toLowerCase();
          const isMatch = searchTerm === '' || productTitle.includes(searchTerm);
          
          if (isMatch) {
            item.style.display = 'flex';
            visibleCount++;
          } else {
            item.style.display = 'none';
          }
        });
        
        // é¡¯ç¤ºæœå°‹çµæœæç¤º
        showSearchResults(searchTerm, visibleCount);
        
        // é‡ç½®åˆ†é¡é¸æ“‡
        if (searchTerm) {
          document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.remove('active');
          });
        }
      }
      
      function clearSearch() {
        document.getElementById('search-input').value = '';
        document.getElementById('search-clear').style.display = 'none';
        
        // é¡¯ç¤ºæ‰€æœ‰å•†å“
        document.querySelectorAll('.product-item').forEach(item => {
          item.style.display = 'flex';
        });
        
        // é‡æ–°å•Ÿç”¨æ¨è–¦åˆ†é¡
        document.querySelectorAll('.category-tab').forEach(tab => {
          tab.classList.remove('active');
        });
        document.querySelector('[data-category="all"]').classList.add('active');
        
        // æ¸…é™¤æœå°‹çµæœæç¤º
        hideSearchResults();
      }
      
      function showSearchResults(searchTerm, count) {
        let existingResult = document.getElementById('search-results');
        
        if (searchTerm && searchTerm.length > 0) {
          if (!existingResult) {
            existingResult = document.createElement('div');
            existingResult.id = 'search-results';
            existingResult.className = 'search-results-info';
            const productsSection = document.querySelector('.products-section');
            productsSection.insertBefore(existingResult, productsSection.firstChild);
          }
          
          existingResult.innerHTML = `
            <div class="search-result-text">
              ğŸ” æœå°‹ã€Œ<strong>${searchTerm}</strong>ã€æ‰¾åˆ° ${count} é …å•†å“
            </div>
          `;
          existingResult.style.display = 'block';
        } else {
          hideSearchResults();
        }
      }
      
      function hideSearchResults() {
        const existingResult = document.getElementById('search-results');
        if (existingResult) {
          existingResult.style.display = 'none';
        }
      }
      
      // åˆ†é¡ç¯©é¸åŠŸèƒ½æ”¹é€²
      function filterByCategory(category) {
        const productItems = document.querySelectorAll('.product-item');
        
        // æ¸…é™¤æœå°‹
        document.getElementById('search-input').value = '';
        document.getElementById('search-clear').style.display = 'none';
        hideSearchResults();
        
        productItems.forEach(item => {
          const itemCategory = item.getAttribute('data-category');
          const isMatch = category === 'all' || itemCategory === category;
          item.style.display = isMatch ? 'flex' : 'none';
        });
      }

      window.onload = function() {
        console.log('ğŸŒ é é¢å·²è¼‰å…¥');
        console.log('ğŸ“¦ ç”¢å“è³‡æ–™:', products);
        console.log('ğŸ›’ è³¼ç‰©è»Šå‡½æ•¸å¯ç”¨:', typeof addToCart);
        updateCartSummary();
        
        // è¼‰å…¥ç‡Ÿæ¥­æ™‚é–“è³‡æ–™
        loadBusinessHours();
        
        // æª¢æŸ¥æ˜¯å¦éœ€è¦é¡¯ç¤ºç‡Ÿæ¥­æ™‚é–“
        checkBusinessHoursDisplay();
        
        // è¨­å®šæœå°‹åŠŸèƒ½
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
          // å³æ™‚æœå°‹
          searchInput.addEventListener('input', function() {
            setTimeout(performSearch, 100); // å»¶é²100msé¿å…éåº¦è§¸ç™¼
          });
          
          // æŒ‰Enteræœå°‹
          searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
              performSearch();
            }
          });
        }
        
        // è¨­å®šåˆ†é¡æŒ‰éˆ•é»æ“Šäº‹ä»¶
        document.querySelectorAll('.category-tab').forEach(tab => {
          tab.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            
            // æ›´æ–°activeç‹€æ…‹
            document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // ç¯©é¸å•†å“
            filterByCategory(category);
          });
        });
      };
    </script>
  </body>
</html>